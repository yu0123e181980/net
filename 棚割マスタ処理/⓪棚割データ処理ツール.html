<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>棚割データ処理ツール</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Meiryo UI", "Yu Gothic", "Hiragino Sans", sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        /* ライブラリ承認モーダル */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal h2 {
            color: #333;
            font-size: 20px;
            font-weight: 600;
        }

        .modal-content {
            line-height: 1.8;
            color: #555;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .modal-content p {
            margin-bottom: 12px;
        }

        .library-list {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid #1F5F8B;
        }

        .library-list h3 {
            color: #1F5F8B;
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .library-list ul {
            list-style: none;
        }

        .library-list li {
            padding: 6px 0;
            color: #333;
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .library-list li::before {
            content: "✓";
            color: #4CAF50;
            font-weight: bold;
            margin-right: 8px;
            font-size: 14px;
        }

        .security-info {
            background: #e8f5e9;
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid #4CAF50;
            font-size: 14px;
        }

        .security-info strong {
            color: #2e7d32;
        }

        .warning-box {
            background: #fff3e0;
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid #ff9800;
            font-size: 14px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #1F5F8B;
            color: white;
        }

        .btn-primary:hover {
            background: #164563;
        }

        .btn-secondary {
            background: #ddd;
            color: #333;
        }

        .btn-secondary:hover {
            background: #ccc;
        }

        /* メインコンテナ */
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* ヘッダー部分 */
        .header {
            text-align: center;
            padding-bottom: 20px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }

        /* ステップインジケーター */
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 0 20px;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #ddd;
            z-index: -1;
        }

        .step.active:not(:last-child)::after {
            background: #1F5F8B;
        }

        .step-number {
            display: inline-block;
            width: 32px;
            height: 32px;
            line-height: 32px;
            border-radius: 50%;
            background: #ddd;
            color: #666;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .step.active .step-number {
            background: #1F5F8B;
            color: white;
        }

        .step-label {
            font-size: 12px;
            color: #666;
        }

        .step.active .step-label {
            color: #1F5F8B;
            font-weight: bold;
        }

        /* ファイルアップロードエリア */
        .upload-area {
            border: 3px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #1F5F8B;
            background: #f9f9f9;
        }

        .upload-area.dragover {
            border-color: #1F5F8B;
            background: #e3f2fd;
        }

        .upload-text {
            color: #333;
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .upload-subtext {
            color: #666;
            font-size: 13px;
        }

        .file-input {
            display: none;
        }

        /* ファイル情報 */
        .file-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }

        .file-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .file-name {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .file-size {
            color: #666;
            font-size: 12px;
        }

        .remove-file {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .remove-file:hover {
            background: #d32f2f;
        }

        /* フォルダ選択 */
        .folder-selection {
            margin-bottom: 30px;
        }

        .folder-selection h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .folder-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .folder-option {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .folder-option:hover {
            border-color: #1F5F8B;
            background: #f9f9f9;
        }

        .folder-option.selected {
            border-color: #1F5F8B;
            background: #e3f2fd;
        }

        .folder-option input[type="radio"] {
            display: none;
        }

        .folder-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .folder-description {
            color: #666;
            font-size: 12px;
        }

        /* 処理ボタン */
        .process-btn {
            width: 100%;
            padding: 15px;
            background: #1F5F8B;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .process-btn:hover:not(:disabled) {
            background: #164563;
        }

        .process-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ステータス表示 */
        .status {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4CAF50;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .status.processing {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #1F5F8B;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* プログレスバー */
        .progress-container {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: #1F5F8B;
            width: 0%;
            transition: width 0.3s;
        }

        /* ローディングスピナー */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1F5F8B;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            flex-shrink: 0;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .folder-options {
                grid-template-columns: 1fr;
            }

            .step-indicator {
                padding: 0 10px;
            }

            .step-label {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- ライブラリ承認モーダル -->
    <div id="libraryModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>外部ライブラリの使用について</h2>
            </div>
            <div class="modal-content">
                <p>このツールは以下の外部ライブラリを使用します：</p>
                <div class="library-list">
                    <h3>使用ライブラリ</h3>
                    <ul>
                        <li><strong>SheetJS (xlsx)</strong>: Excelファイルの読み込み</li>
                        <li><strong>PapaParse</strong>: CSVファイルの解析</li>
                        <li><strong>JSZip</strong>: ZIPファイルの作成</li>
                        <li><strong>FileSaver.js</strong>: ファイルのダウンロード</li>
                        <li><strong>encoding.js</strong>: 文字エンコーディング変換（Shift_JIS対応）</li>
                    </ul>
                </div>
                <div class="security-info">
                    <strong>セキュリティ情報</strong><br>
                    全てのライブラリは信頼性の高いCDN（cdnjs.cloudflare.com）から読み込まれます。
                </div>
                <div class="warning-box">
                    <strong>データの取り扱い</strong><br>
                    ファイルはブラウザ内でのみ処理され、外部サーバーには送信されません。
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="window.close()">キャンセル</button>
                <button class="btn btn-primary" onclick="acceptLibraries()">同意して開始</button>
            </div>
        </div>
    </div>

    <div class="container" id="mainContent" style="display: none;">
        <!-- ヘッダー -->
        <div class="header">
            <h1>棚割データ処理ツール</h1>
        </div>

        <!-- ステップインジケーター -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-label">ファイル選択</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-label">フォルダ構成</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-label">処理実行</div>
            </div>
        </div>

        <!-- ファイルアップロードエリア -->
        <div class="upload-area" id="uploadArea">
            <div class="upload-text">ファイルをドロップ または クリックして選択</div>
            <div class="upload-subtext">対応フォーマット: CSV（Shift_JIS / UTF-8）、Excel（.xlsx）</div>
        </div>
        <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx">

        <!-- ファイル情報 -->
        <div id="fileInfoContainer" style="display: none;">
            <div class="file-info">
                <div class="file-details">
                    <div class="file-name" id="fileName"></div>
                    <div class="file-size" id="fileSize"></div>
                </div>
                <button class="remove-file" onclick="removeFile()">削除</button>
            </div>
        </div>

        <!-- フォルダ選択 -->
        <div class="folder-selection" id="folderSelection" style="display: none;">
            <h3>出力フォルダ構成の選択</h3>
            <div class="folder-options">
                <label class="folder-option" for="folderStore">
                    <input type="radio" name="folderType" value="store" id="folderStore" checked>
                    <div class="folder-label">店舗別フォルダ</div>
                    <div class="folder-description">店舗ごとにフォルダ分け</div>
                </label>
                <label class="folder-option" for="folderShelf">
                    <input type="radio" name="folderType" value="shelf" id="folderShelf">
                    <div class="folder-label">棚名称別フォルダ</div>
                    <div class="folder-description">棚名称ごとにフォルダ分け</div>
                </label>
            </div>
        </div>

        <!-- 処理ボタン -->
        <button class="process-btn" id="processBtn" disabled onclick="processFile()">
            データ処理を開始
        </button>

        <!-- プログレスバー -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <!-- ステータス表示 -->
        <div class="status" id="status"></div>
    </div>

    <!-- 外部ライブラリの読み込み -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/encoding-japanese@2.0.0/encoding.min.js"></script>

    <script>
        // グローバル変数
        let currentFile = null;
        let parsedData = null;

        function acceptLibraries() {
            document.getElementById('libraryModal').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const processBtn = document.getElementById('processBtn');

            // クリックでファイル選択
            uploadArea.addEventListener('click', () => fileInput.click());

            // ファイル選択時の処理
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });

            // ドラッグ&ドロップ
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });

            // フォルダ選択の変更
            document.querySelectorAll('.folder-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.folder-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        });

        function handleFile(file) {
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx')) {
                showStatus('error', 'CSVまたはExcelファイルを選択してください。');
                return;
            }

            currentFile = file;
            
            // ファイル情報の表示
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = `${(file.size / 1024).toFixed(2)} KB`;
            document.getElementById('fileInfoContainer').style.display = 'block';
            document.getElementById('folderSelection').style.display = 'block';
            document.getElementById('processBtn').disabled = false;
            document.getElementById('uploadArea').style.display = 'none';

            // ステップインジケーター更新
            updateStepIndicator(2);

            showStatus('success', 'ファイルが正常に読み込まれました。フォルダ構成を選択して処理を開始してください。');
        }

        function removeFile() {
            currentFile = null;
            parsedData = null;
            document.getElementById('fileInfoContainer').style.display = 'none';
            document.getElementById('folderSelection').style.display = 'none';
            document.getElementById('processBtn').disabled = true;
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('status').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            updateStepIndicator(1);
        }

        function updateStepIndicator(step) {
            document.querySelectorAll('.step').forEach((el, idx) => {
                if (idx < step) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });
        }

        async function processFile() {
            if (!currentFile) return;

            const processBtn = document.getElementById('processBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const status = document.getElementById('status');

            updateStepIndicator(3);
            processBtn.disabled = true;
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';

            try {
                showStatusWithSpinner('processing', 'ファイルを読み込み中...');

                const folderType = document.querySelector('input[name="folderType"]:checked').value;
                const fileName = currentFile.name.toLowerCase();
                
                let data;
                if (fileName.endsWith('.xlsx')) {
                    // Excelファイルの読み込み
                    data = await readExcelFile(currentFile);
                } else {
                    // CSVファイルの読み込み
                    data = await readCSVFile(currentFile);
                }
                
                showStatusWithSpinner('processing', 'データを処理中...');
                const count = await processData(data, folderType);
                showStatus('success', `処理完了！ ${count}件のファイルを出力しました。`);
                progressBar.style.width = '100%';
            } catch (error) {
                showStatus('error', `処理エラー: ${error.message}`);
                console.error(error);
            } finally {
                processBtn.disabled = false;
            }
        }

        async function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        resolve(jsonData);
                    } catch (error) {
                        reject(new Error('Excelファイルの読み込みに失敗しました。'));
                    }
                };
                reader.onerror = () => reject(new Error('ファイルの読み込みに失敗しました。'));
                reader.readAsArrayBuffer(file);
            });
        }

        async function readCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    Papa.parse(e.target.result, {
                        complete: function(results) {
                            if (results.errors.length > 0) {
                                reject(new Error('CSVの解析に失敗しました。'));
                            } else {
                                resolve(results.data);
                            }
                        },
                        error: function(error) {
                            reject(new Error(`CSVの読み込みエラー: ${error.message}`));
                        }
                    });
                };
                reader.onerror = () => reject(new Error('ファイルの読み込みに失敗しました。'));
                reader.readAsText(file);
            });
        }

        async function processData(data, folderType) {
            // ヘッダー行を取得
            const headers = data[0].map(h => String(h).trim());
            const rows = data.slice(1);

            // DataFrameのような構造に変換
            const df = rows.map(row => {
                const obj = {};
                headers.forEach((header, i) => {
                    obj[header] = row[i];
                });
                return obj;
            }).filter(row => row['棚名称'] !== '設定なし' && row['棚名称']);

            if (df.length === 0) {
                throw new Error('有効なデータが見つかりません。');
            }

            // 店舗CD × 棚名称のユニークな組み合わせを取得
            const combinations = new Map();
            df.forEach(row => {
                const key = `${row['店舗CD']}_${row['棚名称']}`;
                if (!combinations.has(key)) {
                    combinations.set(key, {
                        店舗CD: row['店舗CD'],
                        棚名称: row['棚名称']
                    });
                }
            });

            const zip = new JSZip();
            let processedCount = 0;
            const totalCount = combinations.size;

            for (const [key, combo] of combinations) {
                // 進捗表示を更新
                showStatusWithSpinner('processing', `処理中... (${processedCount + 1}/${totalCount}件)`);
                
                // 該当データを抽出
                let shelfData = df.filter(row => 
                    row['店舗CD'] === combo.店舗CD && row['棚名称'] === combo.棚名称
                );

                // 棚番号でソート
                shelfData.sort((a, b) => {
                    const numA = parseInt(a['棚番号']) || 0;
                    const numB = parseInt(b['棚番号']) || 0;
                    return numA - numB;
                });

                // 台番号の割り当て
                const shelfNumbers = [...new Set(shelfData.map(r => r['棚番号']))];
                const shelfToUnit = {};
                shelfNumbers.forEach((num, idx) => {
                    shelfToUnit[num] = idx + 1;
                });

                shelfData.forEach(row => {
                    row['台'] = shelfToUnit[row['棚番号']];
                    row['列'] = Math.floor(parseInt(row['列']) / 10);
                });

                // 段の反転処理
                const unitGroups = {};
                shelfData.forEach(row => {
                    const unit = row['台'];
                    if (!unitGroups[unit]) unitGroups[unit] = [];
                    unitGroups[unit].push(row);
                });

                Object.values(unitGroups).forEach(group => {
                    const steps = group.map(r => parseInt(r['段']));
                    const minStep = Math.min(...steps);
                    const maxStep = Math.max(...steps);
                    
                    group.forEach(row => {
                        const currentStep = parseInt(row['段']);
                        row['段'] = maxStep - (currentStep - minStep);
                    });
                });

                // メタ情報の取得
                const storeName = shelfData[0]['店舗'];
                const shelfName = shelfData[0]['棚名称'];
                const patternName = shelfData[0]['棚パターン名'];

                // フォルダ名とファイル名の決定
                let folderName, fileName;
                if (folderType === 'store') {
                    folderName = sanitizeFilename(`${combo.店舗CD}-${storeName}`);
                    fileName = sanitizeFilename(`${storeName}_${shelfName}_${patternName}.csv`);
                } else {
                    folderName = sanitizeFilename(shelfName);
                    fileName = sanitizeFilename(`${shelfName}_${patternName}.csv`);
                }

                // 台幅の判定
                const shelfWidth = ['3尺', 'ｻｲﾄﾞﾈｯﾄ', 'ｼｰｽﾞﾆﾝｸﾞ'].some(x => patternName.includes(x)) ? 900 : 1200;

                // CSV出力データの構築
                const outputData = [];
                outputData.push(['共通棚割情報', 'V3.0', 'IC']);
                outputData.push([fileName]);
                outputData.push(['台番号', '台高さ', '台幅', '台奥行', '台名称']);

                const uniqueUnits = [...new Set(shelfData.map(r => r['台']))].sort((a, b) => a - b);
                uniqueUnits.forEach(unit => {
                    outputData.push([unit, 2400, shelfWidth, 400, '']);
                });

                outputData.push(['台番号', '棚段番号', '棚高さ', '棚幅', '棚奥行', '棚厚さ', '棚種別']);
                
                uniqueUnits.forEach(unit => {
                    const unitData = shelfData.filter(r => r['台'] === unit);
                    const maxStep = Math.max(...unitData.map(r => parseInt(r['段'])));
                    const shelfHeights = calculateShelfHeights(maxStep);
                    
                    const uniqueSteps = [...new Set(unitData.map(r => parseInt(r['段'])))].sort((a, b) => a - b);
                    uniqueSteps.forEach((step, idx) => {
                        outputData.push([unit, step, shelfHeights[idx], shelfWidth, 400, 10, 1]);
                    });
                });

                outputData.push(['台番号', '棚段番号', '棚位置', '商品コード', 'フェース数', 'フェース面', 'フェース回転', '積上陳列数', '在庫数量', 'フェース内陳列区分', 'フェース内位置', '奥行陳列数']);
                
                shelfData.sort((a, b) => {
                    if (a['台'] !== b['台']) return a['台'] - b['台'];
                    return parseInt(a['段']) - parseInt(b['段']);
                });

                shelfData.forEach(row => {
                    outputData.push([
                        row['台'],
                        row['段'],
                        row['列'],
                        row['JAN'],
                        row['フェイス数'],
                        1, 0, 1, 0, 0, 1, 1
                    ]);
                });

                // CSVに変換
                const csvContent = outputData.map(row => row.join(',')).join('\r\n');
                
                // Shift_JISにエンコード（日本語の棚割ツール用）
                const unicodeArray = [];
                for (let i = 0; i < csvContent.length; i++) {
                    unicodeArray.push(csvContent.charCodeAt(i));
                }
                const sjisArray = Encoding.convert(unicodeArray, {
                    to: 'SJIS',
                    from: 'UNICODE'
                });
                const uint8Array = new Uint8Array(sjisArray);
                
                // ZIPに追加
                zip.folder(folderName).file(fileName, uint8Array);

                processedCount++;
                updateProgress((processedCount / totalCount) * 100);
            }

            // 出力ファイル一覧を作成
            showStatusWithSpinner('processing', '出力ファイル一覧を作成中...');
            const fileList = [];
            zip.forEach((relativePath, file) => {
                if (!file.dir) {
                    fileList.push([relativePath]);
                }
            });
            
            const listCsv = 'ファイルパス\r\n' + fileList.map(row => row.join(',')).join('\r\n');
            
            // 一覧CSVもShift_JISにエンコード
            const listUnicodeArray = [];
            for (let i = 0; i < listCsv.length; i++) {
                listUnicodeArray.push(listCsv.charCodeAt(i));
            }
            const listSjisArray = Encoding.convert(listUnicodeArray, {
                to: 'SJIS',
                from: 'UNICODE'
            });
            const listUint8Array = new Uint8Array(listSjisArray);
            
            zip.file('出力ファイル一覧.csv', listUint8Array);

            // ZIPをダウンロード
            showStatusWithSpinner('processing', 'ZIPファイルを生成中...');
            const content = await zip.generateAsync({ 
                type: 'blob',
                compression: "DEFLATE",
                compressionOptions: {
                    level: 9
                }
            });
            showStatus('success', 'ZIPファイルをダウンロード中...');
            saveAs(content, `棚割データ_${folderType === 'store' ? '店舗別' : '棚名称別'}_${new Date().toISOString().slice(0, 10)}.zip`);
            
            return totalCount;
        }

        function calculateShelfHeights(maxStep) {
            const baseHeight = 150;
            const totalHeight = 2400;
            const availableHeight = totalHeight - baseHeight;

            if (maxStep < 2 || maxStep > 9) {
                return [];
            }

            const interval = Math.floor(availableHeight / (maxStep - 1));
            const heights = [];
            for (let i = 0; i < maxStep; i++) {
                heights.push(baseHeight + i * interval);
            }
            return heights;
        }

        function sanitizeFilename(filename) {
            return filename.replace(/[\\/:*?"<>|]/g, '');
        }

        function showStatus(type, message) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.innerHTML = message;
            status.style.display = 'block';
        }

        function showStatusWithSpinner(type, message) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.innerHTML = `<div class="loading-spinner"></div><span>${message}</span>`;
            status.style.display = 'flex';
        }

        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${percent}%`;
        }
    </script>
</body>
</html>

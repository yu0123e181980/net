<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Benchmarking Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Meiryo UI", "Yu Gothic", "Hiragino Sans", sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .modal {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .modal-content {
            margin-bottom: 25px;
            line-height: 1.8;
            color: #555;
        }
        
        .library-list {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid #1F5F8B;
        }
        
        .library-list li {
            margin: 8px 0;
            color: #333;
        }
        
        .security-info {
            background: #e8f5e9;
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid #4CAF50;
            font-size: 14px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #1F5F8B;
            color: white;
        }
        
        .btn-primary:hover {
            background: #164563;
        }
        
        .btn-secondary {
            background: #ddd;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #ccc;
        }
        
        .loading-message {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1F5F8B;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #ffebee;
            padding: 20px;
            border-radius: 4px;
            border-left: 4px solid #f44336;
            color: #c62828;
        }
        
        .upload-area {
            border: 3px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #1F5F8B;
            background: #f9f9f9;
        }
        
        .upload-area.dragover {
            border-color: #1F5F8B;
            background: #e3f2fd;
        }
        
        .filters {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }
        
        .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .store-filters {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .store-group {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background: #f9f9f9;
        }
        
        .store-group-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 13px;
            padding-bottom: 5px;
            border-bottom: 2px solid #1F5F8B;
        }
        
        .store-group select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .mode-btn {
            padding: 10px 20px;
            border: 2px solid #1F5F8B;
            background: white;
            color: #1F5F8B;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .mode-btn.active {
            background: #1F5F8B;
            color: white;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .breadcrumb-item {
            color: #1F5F8B;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .breadcrumb-item.current {
            color: #333;
            cursor: default;
            text-decoration: none;
            font-weight: bold;
        }
        
        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .chart-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .chart-btn.active {
            background: #1F5F8B;
            color: white;
            border-color: #1F5F8B;
        }
        
        .download-chart-btn {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-left: auto;
        }
        
        .export-table-btn {
            padding: 8px 16px;
            background: #FF9800;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-bottom: 15px;
        }
        
        .aspect-ratio-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .aspect-ratio-controls label {
            font-weight: bold;
            color: #555;
            font-size: 13px;
        }
        
        .aspect-ratio-controls select,
        .aspect-ratio-controls input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .aspect-ratio-controls input[type="number"] {
            width: 80px;
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        .chart-container {
            height: 400px;
            margin-bottom: 30px;
            position: relative;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
            font-size: 13px;
        }
        
        th {
            background: #f5f5f5;
            font-weight: bold;
            color: #333;
            position: relative;
        }
        
        th.sortable {
            cursor: pointer;
            user-select: none;
            padding-right: 25px;
        }
        
        th.sortable:hover {
            background: #e8e8e8;
        }
        
        th .sort-icon {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #999;
        }
        
        th.sort-asc .sort-icon {
            color: #1F5F8B;
        }
        
        th.sort-desc .sort-icon {
            color: #1F5F8B;
        }
        
        th.draggable-header {
            cursor: move;
            user-select: none;
            position: relative;
        }
        
        th.draggable-header:hover {
            background: #e8e8e8;
        }
        
        th.draggable-header::before {
            content: 'â‹®â‹®';
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 16px;
        }
        
        th.dragging {
            opacity: 0.5;
            background: #ddd;
        }
        
        th.drag-over {
            border-left: 3px solid #1F5F8B;
        }
        
        th.vertical-text {
            writing-mode: vertical-rl;
            text-orientation: upright;
            height: 140px;
            padding: 5px 5px 5px 15px;
            font-size: 12px;
            white-space: nowrap;
        }
        
        th.vertical-text .sort-icon {
            writing-mode: horizontal-tb;
            display: inline-block;
            transform: none;
            position: relative;
            right: auto;
            top: auto;
            margin-left: 2px;
        }
        
        .databar-cell {
            position: relative;
            padding: 10px;
            text-align: left;
        }
        
        .databar-sku {
            background: linear-gradient(to right, #4A90E2 0%, #4A90E2 var(--percentage), transparent var(--percentage));
        }
        
        .databar-face {
            background: linear-gradient(to right, #7FB3D5 0%, #7FB3D5 var(--percentage), transparent var(--percentage));
        }
        
        .hidden-column {
            display: none;
        }
        
        .download-table-container {
            position: absolute;
            left: -9999px;
            top: 0;
        }
        
        .download-table table {
            width: auto;
            border-collapse: collapse;
            background: white;
        }
        
        .download-table th, .download-table td {
            padding: 10px 15px;
            text-align: center;
            border: 1px solid #333;
            font-size: 12px;
            min-height: 40px;
            height: auto;
            white-space: nowrap;
            vertical-align: middle;
        }
        
        .download-table th {
            background: #e8e8e8;
            font-weight: bold;
            color: #333;
            writing-mode: horizontal-tb;
            text-orientation: mixed;
        }
        
        .download-table td:first-child,
        .download-table td:nth-child(2),
        .download-table td:nth-child(3),
        .download-table td:nth-child(4),
        .download-table td:nth-child(5) {
            text-align: left;
            font-weight: 500;
        }
        
        .download-table .databar-cell {
            text-align: center;
        }
        
        .drill-btn {
            padding: 5px 10px;
            background: #1F5F8B;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .drill-all-btn {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .export-btn {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
        }
        
        .matrix-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .matrix-controls input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
        }
        
        .pagination {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }
        
        .pagination button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .hidden {
            display: none;
        }
        
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1F5F8B 0%, #2C7FB8 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            animation: fadeOut 0.5s ease-out 2s forwards;
        }
        
        @keyframes fadeOut {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }
        
        .splash-content {
            text-align: center;
        }
        
        .splash-title {
            color: white;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 40px;
            opacity: 0;
            animation: fadeInUp 0.6s ease-out 0.2s forwards;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chart-animation {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 8px;
            height: 120px;
            margin-bottom: 30px;
        }
        
        .bar {
            width: 20px;
            background: white;
            border-radius: 3px 3px 0 0;
            opacity: 0.9;
            animation: growBar 0.8s ease-out forwards;
        }
        
        .bar:nth-child(1) {
            height: 60px;
            animation-delay: 0.3s;
        }
        
        .bar:nth-child(2) {
            height: 90px;
            animation-delay: 0.4s;
        }
        
        .bar:nth-child(3) {
            height: 45px;
            animation-delay: 0.5s;
        }
        
        .bar:nth-child(4) {
            height: 75px;
            animation-delay: 0.6s;
        }
        
        .bar:nth-child(5) {
            height: 100px;
            animation-delay: 0.7s;
        }
        
        .bar:nth-child(6) {
            height: 55px;
            animation-delay: 0.8s;
        }
        
        @keyframes growBar {
            from {
                transform: scaleY(0);
                opacity: 0;
            }
            to {
                transform: scaleY(1);
                opacity: 0.9;
            }
        }
        
        .line-chart {
            position: relative;
            width: 200px;
            height: 80px;
            margin: 0 auto 20px;
        }
        
        .line-path {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .line-path svg {
            width: 100%;
            height: 100%;
        }
        
        .line-path path {
            stroke: white;
            stroke-width: 3;
            fill: none;
            stroke-dasharray: 300;
            stroke-dashoffset: 300;
            animation: drawLine 1.2s ease-out 0.8s forwards;
        }
        
        @keyframes drawLine {
            to {
                stroke-dashoffset: 0;
            }
        }
        
        .loading-text {
            color: white;
            font-size: 14px;
            opacity: 0;
            animation: fadeIn 0.5s ease-out 1.5s forwards;
        }
        
        @keyframes fadeIn {
            to {
                opacity: 0.8;
            }
        }
        
        .matrix-table {
            overflow-x: auto;
        }
        
        .matrix-table td.has-product {
            text-align: center;
            font-size: 16px;
        }
        
        .arbitrary-selector {
            margin-bottom: 20px;
        }
        
        .arbitrary-selector label {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .arbitrary-selector select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .price-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        /* ä¾¡æ ¼æˆ¦ç•¥åˆ†æãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .price-granularity-selector {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .price-hierarchy-filters {
            margin-bottom: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .price-filter-set {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .price-filter-set.hidden {
            display: none !important;
        }
        
        .price-filter-set .filter-group {
            flex: 1;
            min-width: 300px;
        }
        
        .price-filter-set .filter-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
        }
        
        .price-filter-set .filter-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .price-item-selector {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .price-item-selector .filter-group select {
            width: 100%;
            max-height: 200px;
        }
        
        .price-axis-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .price-axis-controls .filter-group {
            flex: 0 0 auto;
        }
        
        .price-axis-controls .download-chart-btn {
            margin-left: auto;
        }
        
        .price-chart-wrapper {
            margin-bottom: 40px;
            padding: 20px;
            background: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .price-chart-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1F5F8B;
        }
        
        .price-chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }
        
        .price-chart-container canvas {
            max-height: 400px;
        }
        
        /* å•†å“ãƒãƒˆãƒªã‚¯ã‚¹ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        .product-matrix-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .product-matrix-modal.hidden {
            display: none !important;
        }
        
        .product-matrix-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 1200px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .product-matrix-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 2px solid #1F5F8B;
            background: #f9f9f9;
            border-radius: 8px 8px 0 0;
        }
        
        .product-matrix-header h3 {
            color: #333;
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }
        
        .product-matrix-close {
            background: #f44336;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: background 0.3s;
        }
        
        .product-matrix-close:hover {
            background: #d32f2f;
        }
        
        .product-matrix-body {
            padding: 20px 30px;
            overflow: auto;
            flex: 1;
        }
        
        .product-matrix-body table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .product-matrix-body th,
        .product-matrix-body td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .product-matrix-body th {
            background: #2B5797;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .product-matrix-body td.product-name {
            text-align: left;
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .product-matrix-body td.jan-code {
            font-family: monospace;
            font-size: 11px;
        }
        
        .product-matrix-body td.price-cell {
            font-weight: bold;
            color: #1F5F8B;
        }
        
        .product-matrix-body td.no-price {
            background: #f5f5f5;
            color: #999;
        }

    </style>
</head>
<body>
    <div id="splashScreen" class="splash-screen">
        <div class="splash-content">
            <div class="splash-title">Visual Benchmarking Tool</div>
            <div class="chart-animation">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
            <div class="line-chart">
                <div class="line-path">
                    <svg viewBox="0 0 200 80" preserveAspectRatio="none">
                        <path d="M 0,60 L 40,45 L 80,50 L 120,25 L 160,35 L 200,15" />
                    </svg>
                </div>
            </div>
            <div class="loading-text">Loading...</div>
        </div>
    </div>
    
    <div id="confirmModal" class="modal-overlay hidden">
        <div class="modal">
            <h2>ğŸ”’ å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ç¢ºèª</h2>
            <div class="modal-content">
                <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®JavaScriptãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å¤–éƒ¨ã‹ã‚‰èª­ã¿è¾¼ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™:</p>
                
                <div class="library-list">
                    <ul>
                        <li><strong>XLSX.js (v0.18.5)</strong> - Excelãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ç”¨</li>
                        <li><strong>Chart.js (v3.9.1)</strong> - ã‚°ãƒ©ãƒ•è¡¨ç¤ºç”¨</li>
                        <li><strong>html2canvas (v1.4.1)</strong> - ç”»åƒå‡ºåŠ›ç”¨</li>
                    </ul>
                </div>
                
                <div class="security-info">
                    <strong>âœ“ æ¥ç¶šæƒ…å ±:</strong><br>
                    ãƒ»æ¥ç¶šå…ˆ: https://cdnjs.cloudflare.com (Cloudflareå…¬å¼CDN)<br>
                    ãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“<br>
                    ãƒ»ã™ã¹ã¦ã®å‡¦ç†ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å®Œçµã—ã¾ã™
                </div>
                
                <p style="color: #666; font-size: 13px; margin-top: 15px;">
                    â€»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯æ¯å›ã®ãƒ„ãƒ¼ãƒ«èµ·å‹•æ™‚ã«èª­ã¿è¾¼ã¾ã‚Œã€ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§ã®ã¿å‹•ä½œã—ã¾ã™ã€‚<br>
                    â€»æœ¬ãƒ„ãƒ¼ãƒ«å†…ã§åˆ©ç”¨ã•ã‚Œã‚‹CDN(Content Delivery Network)çµŒç”±ã§æä¾›ã•ã‚Œã‚‹å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¤ã„ã¦ã¯ã€ãã®å®‰å…¨æ€§ã€å¯ç”¨æ€§ã€æ­£ç¢ºæ€§ã€ãŠã‚ˆã³ãƒ„ãƒ¼ãƒ«ã®æ©Ÿèƒ½ã«ä¸ãˆã‚‹å½±éŸ¿ã‚’å«ã‚ã€ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚
                </p>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" id="approveBtn">è¨˜è¼‰äº‹é …ã«åŒæ„ã—ã¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚€</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <h1>Visual Benchmarking Tool</h1>
        
        <div id="loadingMessage" class="loading-message hidden">
            <div class="loading-spinner"></div>
            <p>ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
        </div>
        
        <div id="errorMessage" class="error-message hidden"></div>
        
        <div id="mainApp" class="hidden">
            <div class="upload-area" id="uploadArea">
                <p>Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none;">
            </div>
            
            <div id="mainContent" class="hidden">
                <div class="filters">
                    <div class="filter-group">
                        <label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                        <select id="filterCategory" multiple size="5"></select>
                    </div>
                    <div class="filter-group">
                        <label>ä¼æ¥­å</label>
                        <select id="filterCompany" multiple size="5"></select>
                    </div>
                    <div class="filter-group">
                        <label>æ£šåç§°</label>
                        <select id="filterShelf" multiple size="5"></select>
                    </div>
                </div>
                
                <div class="store-filters" id="storeFilters"></div>
                
                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="hierarchy">éšå±¤åˆ†æãƒ¢ãƒ¼ãƒ‰</button>
                    <button class="mode-btn" data-mode="arbitrary">ä»»æ„é …ç›®åˆ†æãƒ¢ãƒ¼ãƒ‰</button>
                    <button class="mode-btn" data-mode="price">ä¾¡æ ¼æˆ¦ç•¥åˆ†æãƒ¢ãƒ¼ãƒ‰</button>
                </div>
                
                <div id="hierarchyMode">
                    <div class="breadcrumb" id="breadcrumb"></div>
                    
                    <button class="drill-all-btn hidden" id="drillAllBtn">å…¨ä½“ã‚’ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³</button>
                    
                    <!-- ã‚°ãƒ©ãƒ•ç”¨ã®ç¸¦æ¨ªæ¯”è¨­å®š -->
                    <div class="aspect-ratio-controls" id="chartAspectRatioControls">
                        <label>ã‚°ãƒ©ãƒ•ç”»åƒã®ç¸¦æ¨ªæ¯”:</label>
                        <select id="chartAspectRatioPreset">
                            <option value="16:9" selected>16:9 (æ¨ªé•·)</option>
                            <option value="4:3">4:3 (æ¨™æº–)</option>
                            <option value="1:1">1:1 (æ­£æ–¹å½¢)</option>
                            <option value="3:4">3:4 (ç¸¦é•·)</option>
                            <option value="210:297">A4ç¸¦ (210:297)</option>
                            <option value="297:210">A4æ¨ª (297:210)</option>
                            <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
                        </select>
                        <span id="chartCustomAspectRatio" style="display:none;">
                            <label>å¹…:</label>
                            <input type="number" id="chartAspectWidth" value="16" min="1">
                            <label>é«˜ã•:</label>
                            <input type="number" id="chartAspectHeight" value="9" min="1">
                        </span>
                    </div>
                    
                    <div class="chart-controls">
                        <button class="chart-btn active" data-metric="sku">SKUæ•°</button>
                        <button class="chart-btn" data-metric="skuRatio">SKUæ•°æ§‹æˆæ¯”</button>
                        <button class="chart-btn" data-metric="face">ãƒ•ã‚§ã‚¤ã‚¹æ•°</button>
                        <button class="chart-btn" data-metric="faceRatio">ãƒ•ã‚§ã‚¤ã‚¹æ•°æ§‹æˆæ¯”</button>
                        <button class="download-chart-btn" id="downloadChartBtn">ã‚°ãƒ©ãƒ•ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                    
                    <button class="export-table-btn" id="exportTableBtn">è¡¨ã‚’ç”»åƒã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    <div class="table-container" id="comparisonTable"></div>
                    
                    <div id="matrixSection" class="hidden">
                        <h2 style="margin-bottom: 15px;">å•†å“ãƒãƒˆãƒªã‚¯ã‚¹</h2>
                        <div class="matrix-controls">
                            <input type="text" id="productSearch" placeholder="å•†å“åã¾ãŸã¯JANã‚³ãƒ¼ãƒ‰ã§æ¤œç´¢...">
                        </div>
                        <div class="matrix-table" id="matrixTable"></div>
                        <div class="pagination">
                            <button id="prevPage">å‰ã¸</button>
                            <span id="pageInfo"></span>
                            <button id="nextPage">æ¬¡ã¸</button>
                        </div>
                    </div>
                </div>
                
                <div id="arbitraryMode" class="hidden">
                    <div class="arbitrary-selector">
                        <label>åˆ†æè»¸ã‚’é¸æŠ:</label>
                        <select id="arbitraryAxis">
                            <option value="ä»»æ„â‘ ">ä»»æ„â‘ </option>
                            <option value="ä»»æ„â‘¡">ä»»æ„â‘¡</option>
                            <option value="ä»»æ„â‘¢">ä»»æ„â‘¢</option>
                            <option value="ä»»æ„â‘£">ä»»æ„â‘£</option>
                        </select>
                    </div>
                    
                    <!-- ä»»æ„é …ç›®ãƒ¢ãƒ¼ãƒ‰ç”¨ã‚°ãƒ©ãƒ•ç¸¦æ¨ªæ¯”è¨­å®š -->
                    <div class="aspect-ratio-controls" id="arbitraryChartAspectRatioControls">
                        <label>ã‚°ãƒ©ãƒ•ç”»åƒã®ç¸¦æ¨ªæ¯”:</label>
                        <select id="arbitraryChartAspectRatioPreset">
                            <option value="16:9" selected>16:9 (æ¨ªé•·)</option>
                            <option value="4:3">4:3 (æ¨™æº–)</option>
                            <option value="1:1">1:1 (æ­£æ–¹å½¢)</option>
                            <option value="3:4">3:4 (ç¸¦é•·)</option>
                            <option value="210:297">A4ç¸¦ (210:297)</option>
                            <option value="297:210">A4æ¨ª (297:210)</option>
                            <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
                        </select>
                        <span id="arbitraryChartCustomAspectRatio" style="display:none;">
                            <label>å¹…:</label>
                            <input type="number" id="arbitraryChartAspectWidth" value="16" min="1">
                            <label>é«˜ã•:</label>
                            <input type="number" id="arbitraryChartAspectHeight" value="9" min="1">
                        </span>
                    </div>
                    
                    <div class="chart-controls">
                        <button class="chart-btn active" data-metric="sku">SKUæ•°</button>
                        <button class="chart-btn" data-metric="skuRatio">SKUæ•°æ§‹æˆæ¯”</button>
                        <button class="chart-btn" data-metric="face">ãƒ•ã‚§ã‚¤ã‚¹æ•°</button>
                        <button class="chart-btn" data-metric="faceRatio">ãƒ•ã‚§ã‚¤ã‚¹æ•°æ§‹æˆæ¯”</button>
                        <button class="download-chart-btn" id="downloadArbitraryChartBtn">ã‚°ãƒ©ãƒ•ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="arbitraryChart"></canvas>
                    </div>
                    
                    <button class="export-table-btn" id="exportArbitraryTableBtn">è¡¨ã‚’ç”»åƒã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    <div class="table-container" id="arbitraryTable"></div>
                </div>
                
                <div id="priceMode" class="hidden">
                    <!-- åˆ†æç²’åº¦é¸æŠ -->
                    <div class="price-granularity-selector">
                        <div class="filter-group">
                            <label>åˆ†æç²’åº¦</label>
                            <select id="priceGranularity">
                                <option value="ã‚«ãƒ†ã‚´ãƒªãƒ¼">ã‚«ãƒ†ã‚´ãƒªãƒ¼</option>
                                <option value="ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼" selected>ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼</option>
                                <option value="ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</option>
                                <option value="ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ">ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- éšå±¤åˆ¥é …ç›®é¸æŠã‚¹ãƒ©ã‚¤ã‚µãƒ¼ -->
                    <div class="price-hierarchy-filters" id="priceHierarchyFilters">
                        <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ç²’åº¦ç”¨ï¼šã‚¹ãƒ©ã‚¤ã‚µãƒ¼ä¸è¦ï¼ˆæ—¢å­˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§é¸æŠæ¸ˆã¿ï¼‰ -->
                        <div class="price-filter-set hidden" id="priceFilterCategory">
                            <div class="filter-group">
                                <p style="color: #666; font-size: 14px; padding: 10px;">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¯ä¸Šéƒ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
                            </div>
                        </div>
                        
                        <!-- ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ç²’åº¦ç”¨ï¼šã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ã¿ -->
                        <div class="price-filter-set hidden" id="priceFilterSubCategory">
                            <div class="filter-group">
                                <label>ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠ</label>
                                <select id="priceSubCategorySelect" multiple size="8"></select>
                            </div>
                        </div>
                        
                        <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç²’åº¦ç”¨ï¼šã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ + ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ -->
                        <div class="price-filter-set hidden" id="priceFilterSegment">
                            <div class="filter-group">
                                <label>ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠ</label>
                                <select id="priceSegmentParentSelect" multiple size="8"></select>
                            </div>
                            <div class="filter-group">
                                <label>ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé¸æŠ</label>
                                <select id="priceSegmentSelect" multiple size="8"></select>
                            </div>
                        </div>
                        
                        <!-- ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç²’åº¦ç”¨ï¼šã‚»ã‚°ãƒ¡ãƒ³ãƒˆ + ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ -->
                        <div class="price-filter-set hidden" id="priceFilterSubSegment">
                            <div class="filter-group">
                                <label>ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé¸æŠ</label>
                                <select id="priceSubSegmentParentSelect" multiple size="8"></select>
                            </div>
                            <div class="filter-group">
                                <label>ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé¸æŠ</label>
                                <select id="priceSubSegmentSelect" multiple size="8"></select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç¸¦è»¸ãƒ»æ¨ªè»¸è¨­å®š -->
                    <div class="price-axis-controls">
                        <div class="filter-group">
                            <label>ç¸¦è»¸</label>
                            <select id="priceYAxis">
                                <option value="sku" selected>SKUæ•°</option>
                                <option value="face">ãƒ•ã‚§ã‚¤ã‚¹æ•°</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>ãƒ—ãƒ©ã‚¤ã‚¹ãƒ©ã‚¤ãƒ³åˆ»ã¿</label>
                            <select id="priceInterval">
                                <option value="10">10å††åˆ»ã¿</option>
                                <option value="20">20å††åˆ»ã¿</option>
                                <option value="30">30å††åˆ»ã¿</option>
                                <option value="40">40å††åˆ»ã¿</option>
                                <option value="50" selected>50å††åˆ»ã¿</option>
                                <option value="60">60å††åˆ»ã¿</option>
                                <option value="70">70å††åˆ»ã¿</option>
                                <option value="80">80å††åˆ»ã¿</option>
                                <option value="90">90å††åˆ»ã¿</option>
                                <option value="100">100å††åˆ»ã¿</option>
                                <option value="150">150å††åˆ»ã¿</option>
                                <option value="200">200å††åˆ»ã¿</option>
                            </select>
                        </div>
                        <button class="download-chart-btn" id="downloadPriceChartsBtn">å…¨ã‚°ãƒ©ãƒ•ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    </div>
                    
                    <!-- ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="priceChartsContainer"></div>
                </div>
                
                <!-- å•†å“ãƒãƒˆãƒªã‚¯ã‚¹ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
                <div id="productMatrixModal" class="product-matrix-modal hidden">
                    <div class="product-matrix-content">
                        <div class="product-matrix-header">
                            <h3 id="productMatrixTitle">å•†å“ãƒãƒˆãƒªã‚¯ã‚¹</h3>
                            <button class="product-matrix-close" id="closeProductMatrixBtn">Ã—</button>
                        </div>
                        <div class="product-matrix-body" id="productMatrixBody"></div>
                    </div>
                </div>

                
                <button class="export-btn" id="exportBtn">å•†å“ãƒãƒˆãƒªã‚¯ã‚¹ã‚’Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            </div>
        </div>
    </div>
    
    <script>
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('splashScreen').style.display = 'none';
                document.getElementById('confirmModal').classList.remove('hidden');
            }, 2500);
        });
        
        const libraries = [
            {
                name: 'XLSX',
                url: 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
                check: () => typeof XLSX !== 'undefined'
            },
            {
                name: 'Chart.js',
                url: 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js',
                check: () => typeof Chart !== 'undefined'
            },
            {
                name: 'html2canvas',
                url: 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
                check: () => typeof html2canvas !== 'undefined'
            }
        ];
        
        let librariesLoaded = false;
        
        document.getElementById('approveBtn').addEventListener('click', loadLibraries);
        document.getElementById('cancelBtn').addEventListener('click', handleCancel);
        
        function loadLibraries() {
            document.getElementById('confirmModal').classList.add('hidden');
            document.getElementById('loadingMessage').classList.remove('hidden');
            
            const promises = libraries.map(lib => loadScript(lib));
            
            Promise.all(promises)
                .then(() => {
                    librariesLoaded = true;
                    document.getElementById('loadingMessage').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    initializeApp();
                })
                .catch(error => {
                    document.getElementById('loadingMessage').classList.add('hidden');
                    const errorMsg = document.getElementById('errorMessage');
                    errorMsg.textContent = `ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
                    errorMsg.classList.remove('hidden');
                });
        }
        
        function loadScript(lib) {
            return new Promise((resolve, reject) => {
                if (lib.check()) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = lib.url;
                
                script.onload = () => {
                    if (lib.check()) {
                        console.log(`âœ“ ${lib.name} loaded successfully`);
                        resolve();
                    } else {
                        reject(new Error(`${lib.name} failed to initialize`));
                    }
                };
                
                script.onerror = () => {
                    reject(new Error(`${lib.name} failed to load from CDN`));
                };
                
                document.head.appendChild(script);
            });
        }
        
        function handleCancel() {
            document.getElementById('confirmModal').classList.add('hidden');
            const errorMsg = document.getElementById('errorMessage');
            errorMsg.innerHTML = `
                <strong>ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ</strong><br>
                ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã‚’æ‰¿èªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br>
                ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã€å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚
            `;
            errorMsg.classList.remove('hidden');
        }
        
        // ç¸¦æ¨ªæ¯”é–¢é€£ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function parseAspectRatio(presetId, customWidthId, customHeightId) {
            const preset = document.getElementById(presetId).value;
            
            if (preset === 'custom') {
                const width = parseInt(document.getElementById(customWidthId).value) || 16;
                const height = parseInt(document.getElementById(customHeightId).value) || 9;
                return { width, height };
            }
            
            const [width, height] = preset.split(':').map(Number);
            return { width, height };
        }
        
        function setupAspectRatioControls() {
            // éšå±¤ãƒ¢ãƒ¼ãƒ‰ã®ã‚°ãƒ©ãƒ•
            document.getElementById('chartAspectRatioPreset').addEventListener('change', function() {
                document.getElementById('chartCustomAspectRatio').style.display = 
                    this.value === 'custom' ? 'inline' : 'none';
            });
            
            // ä»»æ„é …ç›®ãƒ¢ãƒ¼ãƒ‰ã®ã‚°ãƒ©ãƒ•
            document.getElementById('arbitraryChartAspectRatioPreset').addEventListener('change', function() {
                document.getElementById('arbitraryChartCustomAspectRatio').style.display = 
                    this.value === 'custom' ? 'inline' : 'none';
            });
        }
        
        function initializeApp() {
            setupAspectRatioControls();
            
            let rawData = [];
            let filteredData = [];
            let currentHierarchy = [];
            let currentMode = 'hierarchy';
            let currentMetric = 'sku';
            let comparisonChart = null;
            let arbitraryChart = null;
            let priceChart = null;
            let currentPage = 1;
            const itemsPerPage = 50;
            let storeOrder = [];
            let sortState = {column: null, direction: null};
            let hiddenDatasets = new Set();
            let priceHierarchy = [];
            let priceInterval = 50;
            
            const hierarchyLevels = ['ã‚«ãƒ†ã‚´ãƒªãƒ¼', 'ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼', 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ', 'ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ', 'JAN'];
            
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFile(e.dataTransfer.files[0]);
            });
            fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
            
            function handleFile(file) {
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        rawData = jsonData.filter(row => 
                            row['ä¼æ¥­å'] !== 'è¨­å®šãªã—' && 
                            row['åº—èˆ—å'] !== 'è¨­å®šãªã—' &&
                            row['ã‚«ãƒ†ã‚´ãƒªãƒ¼'] !== 'è¨­å®šãªã—' &&
                            row['æ£šåç§°'] !== 'è¨­å®šãªã—'
                        );
                        
                        initializeData();
                    } catch (error) {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
            
            function initializeData() {
                document.getElementById('mainContent').classList.remove('hidden');
                populateFilters();
                applyFilters();
                updateView();
                initializePriceMode();
            }
            
            function populateFilters() {
                const categories = [...new Set(rawData.map(d => d['ã‚«ãƒ†ã‚´ãƒªãƒ¼']))].sort();
                const companies = [...new Set(rawData.map(d => d['ä¼æ¥­å']))].sort();
                const shelves = [...new Set(rawData.map(d => d['æ£šåç§°']))].sort();
                
                populateSelect('filterCategory', categories);
                populateSelect('filterCompany', companies);
                populateSelect('filterShelf', shelves);
                
                populateStoreFilters();
            }
            
            function populateStoreFilters() {
                const companies = [...new Set(rawData.map(d => d['ä¼æ¥­å']))].sort();
                const storeFiltersContainer = document.getElementById('storeFilters');
                
                storeFiltersContainer.innerHTML = '';
                
                companies.forEach(company => {
                    const stores = [...new Set(rawData.filter(d => d['ä¼æ¥­å'] === company).map(d => d['åº—èˆ—å']))].sort();
                    
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'store-group';
                    
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'store-group-title';
                    titleDiv.textContent = company;
                    
                    const select = document.createElement('select');
                    select.id = `filterStore_${company}`;
                    select.multiple = true;
                    select.size = Math.min(stores.length, 5);
                    
                    stores.forEach(store => {
                        const option = document.createElement('option');
                        option.value = store;
                        option.textContent = store;
                        option.selected = true;
                        select.appendChild(option);
                    });
                    
                    select.addEventListener('change', () => {
                        applyFilters();
                        resetSortAndFilter();
                        currentHierarchy = [];
                        updateView();
                    });
                    
                    groupDiv.appendChild(titleDiv);
                    groupDiv.appendChild(select);
                    storeFiltersContainer.appendChild(groupDiv);
                });
            }
            
            function populateSelect(id, options) {
                const select = document.getElementById(id);
                select.innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                
                for (let i = 0; i < select.options.length; i++) {
                    select.options[i].selected = true;
                }
                
                select.addEventListener('change', () => {
                    applyFilters();
                    resetSortAndFilter();
                    currentHierarchy = [];
                    updateView();
                });
            }
            
            function applyFilters() {
                const selectedCategories = getSelectedValues('filterCategory');
                const selectedCompanies = getSelectedValues('filterCompany');
                const selectedShelves = getSelectedValues('filterShelf');
                
                const selectedStores = [];
                selectedCompanies.forEach(company => {
                    const storeSelect = document.getElementById(`filterStore_${company}`);
                    if (storeSelect) {
                        selectedStores.push(...Array.from(storeSelect.selectedOptions).map(opt => opt.value));
                    }
                });
                
                filteredData = rawData.filter(row => 
                    selectedCategories.includes(row['ã‚«ãƒ†ã‚´ãƒªãƒ¼']) &&
                    selectedCompanies.includes(row['ä¼æ¥­å']) &&
                    selectedStores.includes(row['åº—èˆ—å']) &&
                    selectedShelves.includes(row['æ£šåç§°'])
                );
                
                storeOrder = [];
                hiddenDatasets.clear();
            }
            
            function getSelectedValues(id) {
                const select = document.getElementById(id);
                return Array.from(select.selectedOptions).map(opt => opt.value);
            }
            
            function resetSortAndFilter() {
                sortState = {column: null, direction: null};
            }
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentMode = btn.dataset.mode;
                    
                    if (currentMode === 'hierarchy') {
                        document.getElementById('hierarchyMode').classList.remove('hidden');
                        document.getElementById('arbitraryMode').classList.add('hidden');
                        document.getElementById('priceMode').classList.add('hidden');
                        updateView();
                    } else if (currentMode === 'arbitrary') {
                        document.getElementById('hierarchyMode').classList.add('hidden');
                        document.getElementById('arbitraryMode').classList.remove('hidden');
                        document.getElementById('priceMode').classList.add('hidden');
                        updateArbitraryView();
                    } else if (currentMode === 'price') {
                        document.getElementById('hierarchyMode').classList.add('hidden');
                        document.getElementById('arbitraryMode').classList.add('hidden');
                        document.getElementById('priceMode').classList.remove('hidden');
                        updatePriceHierarchySelectors();
                    }
                });
            });
            
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const container = btn.closest('#hierarchyMode, #arbitraryMode');
                    container.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentMetric = btn.dataset.metric;
                    
                    if (currentMode === 'hierarchy') {
                        updateView();
                    } else {
                        updateArbitraryView();
                    }
                });
            });
            
            function updateView() {
                updateBreadcrumb();
                
                const currentLevel = currentHierarchy.length;
                
                if (currentLevel < 4) {
                    document.getElementById('comparisonTable').classList.remove('hidden');
                    document.querySelector('#hierarchyMode .chart-container').classList.remove('hidden');
                    document.querySelector('#hierarchyMode .chart-controls').classList.remove('hidden');
                    document.getElementById('chartAspectRatioControls').classList.remove('hidden');
                    document.getElementById('matrixSection').classList.add('hidden');
                    document.getElementById('drillAllBtn').classList.remove('hidden');
                    updateComparisonView();
                } else {
                    document.getElementById('comparisonTable').classList.add('hidden');
                    document.querySelector('#hierarchyMode .chart-container').classList.add('hidden');
                    document.querySelector('#hierarchyMode .chart-controls').classList.add('hidden');
                    document.getElementById('chartAspectRatioControls').classList.add('hidden');
                    document.getElementById('matrixSection').classList.remove('hidden');
                    document.getElementById('drillAllBtn').classList.add('hidden');
                    updateMatrixView();
                }
            }
            
            function updateBreadcrumb() {
                const breadcrumb = document.getElementById('breadcrumb');
                let html = '<span class="breadcrumb-item" data-level="-1">ãƒˆãƒƒãƒ—</span>';
                
                currentHierarchy.forEach((item, index) => {
                    const displayText = item === '*ALL*' ? 'å…¨ä½“' : item;
                    html += ' > <span class="breadcrumb-item' + 
                            (index === currentHierarchy.length - 1 ? ' current' : '') + 
                            '" data-level="' + index + '">' + displayText + '</span>';
                });
                
                breadcrumb.innerHTML = html;
                
                breadcrumb.querySelectorAll('.breadcrumb-item:not(.current)').forEach(item => {
                    item.addEventListener('click', () => {
                        const level = parseInt(item.dataset.level);
                        currentHierarchy = currentHierarchy.slice(0, level + 1);
                        resetSortAndFilter();
                        updateView();
                    });
                });
            }
            
            function getCurrentData() {
                let data = filteredData;
                
                currentHierarchy.forEach((value, index) => {
                    if (value !== '*ALL*') {
                        const level = hierarchyLevels[index];
                        data = data.filter(row => row[level] === value);
                    }
                });
                
                return data;
            }
            
            function getStoreList(data) {
                const storeInfo = {};
                data.forEach(row => {
                    const key = `${row['ä¼æ¥­å']}_${row['åº—èˆ—å']}`;
                    if (!storeInfo[key]) {
                        storeInfo[key] = {
                            ä¼æ¥­å: row['ä¼æ¥­å'],
                            åº—èˆ—å: row['åº—èˆ—å'],
                            ä¼æ¥­ã‚³ãƒ¼ãƒ‰: row['ä¼æ¥­ã‚³ãƒ¼ãƒ‰'],
                            åº—èˆ—ã‚³ãƒ¼ãƒ‰: row['åº—èˆ—ã‚³ãƒ¼ãƒ‰']
                        };
                    }
                });
                
                const allStores = Object.values(storeInfo);
                
                if (storeOrder.length === 0) {
                    const sortedByCode = allStores.sort((a, b) => {
                        const codeA = parseInt(a.ä¼æ¥­ã‚³ãƒ¼ãƒ‰, 10);
                        const codeB = parseInt(b.ä¼æ¥­ã‚³ãƒ¼ãƒ‰, 10);
                        if (!isNaN(codeA) && !isNaN(codeB) && codeA !== codeB) {
                            return codeA - codeB;
                        }
                        const storeA = parseInt(a.åº—èˆ—ã‚³ãƒ¼ãƒ‰, 10);
                        const storeB = parseInt(b.åº—èˆ—ã‚³ãƒ¼ãƒ‰, 10);
                        if (!isNaN(storeA) && !isNaN(storeB)) {
                            return storeA - storeB;
                        }
                        return 0;
                    });
                    storeOrder = sortedByCode.map(s => `${s.ä¼æ¥­å}_${s.åº—èˆ—å}`);
                }
                
                const sorted = [];
                storeOrder.forEach(key => {
                    const store = allStores.find(s => `${s.ä¼æ¥­å}_${s.åº—èˆ—å}` === key);
                    if (store) sorted.push(store);
                });
                
                allStores.forEach(store => {
                    const key = `${store.ä¼æ¥­å}_${store.åº—èˆ—å}`;
                    if (!storeOrder.includes(key)) {
                        sorted.push(store);
                        storeOrder.push(key);
                    }
                });
                
                return sorted;
            }
            
            function applySorting(data) {
                if (!sortState.column || sortState.direction === null) {
                    return data;
                }
                
                const sorted = [...data].sort((a, b) => {
                    let aVal, bVal;
                    
                    if (sortState.column.startsWith('store_')) {
                        const parts = sortState.column.replace('store_', '').split('_');
                        const metricType = parts.pop();
                        const storeKey = parts.join('_');
                        
                        const metricMap = {
                            'sku': 'SKUæ•°',
                            'skuRatio': 'SKUæ•°æ§‹æˆæ¯”',
                            'face': 'ãƒ•ã‚§ã‚¤ã‚¹æ•°',
                            'faceRatio': 'ãƒ•ã‚§ã‚¤ã‚¹æ•°æ§‹æˆæ¯”'
                        };
                        
                        const metricLabel = metricMap[metricType];
                        aVal = a[storeKey] ? a[storeKey][metricLabel] : 0;
                        bVal = b[storeKey] ? b[storeKey][metricLabel] : 0;
                    } else if (sortState.column === 'name') {
                        aVal = a.name || '';
                        bVal = b.name || '';
                    } else {
                        aVal = a.hierarchyPath[sortState.column] || '';
                        bVal = b.hierarchyPath[sortState.column] || '';
                    }
                    
                    if (typeof aVal === 'string') {
                        return sortState.direction === 'asc' 
                            ? aVal.localeCompare(bVal, 'ja')
                            : bVal.localeCompare(aVal, 'ja');
                    } else {
                        return sortState.direction === 'asc' ? aVal - bVal : bVal - aVal;
                    }
                });
                
                return sorted;
            }
            
            function updateComparisonView() {
                const data = getCurrentData();
                const currentLevel = currentHierarchy.length;
                const nextLevel = hierarchyLevels[currentLevel];
                
                const sortedStores = getStoreList(data);
                
                const categoryTotals = {};
                sortedStores.forEach(store => {
                    const key = `${store.ä¼æ¥­å}_${store.åº—èˆ—å}`;
                    const storeData = filteredData.filter(d => 
                        d['ä¼æ¥­å'] === store.ä¼æ¥­å && d['åº—èˆ—å'] === store.åº—èˆ—å
                    );
                    categoryTotals[key] = {
                        totalSKU: storeData.reduce((sum, d) => sum + (d['SKUæ•°'] || 0), 0),
                        totalFace: storeData.reduce((sum, d) => sum + (d['ãƒ•ã‚§ã‚¤ã‚¹æ•°'] || 0), 0)
                    };
                });
                
                const items = [...new Set(data.map(d => d[nextLevel]))].sort();
                
                let aggregatedData = items.map(item => {
                    const itemData = data.filter(d => d[nextLevel] === item);
                    const result = { 
                        name: item,
                        hierarchyPath: {}
                    };
                    
                    for (let i = 0; i < currentLevel; i++) {
                        const levelName = hierarchyLevels[i];
                        const values = [...new Set(itemData.map(d => d[levelName]))];
                        result.hierarchyPath[levelName] = values[0] || '';
                    }
                    
                    sortedStores.forEach(store => {
                        const key = `${store.ä¼æ¥­å}_${store.åº—èˆ—å}`;
                        const storeData = itemData.filter(d => 
                            d['ä¼æ¥­å'] === store.ä¼æ¥­å && d['åº—èˆ—å'] === store.åº—èˆ—å
                        );
                        
                        const skuCount = storeData.reduce((sum, d) => sum + (d['SKUæ•°'] || 0), 0);
                        const faceCount = storeData.reduce((sum, d) => sum + (d['ãƒ•ã‚§ã‚¤ã‚¹æ•°'] || 0), 0);
                        
                        const skuRatio = categoryTotals[key].totalSKU > 0 
                            ? (skuCount / categoryTotals[key].totalSKU) * 100 
                            : 0;
                        const faceRatio = categoryTotals[key].totalFace > 0 
                            ? (faceCount / categoryTotals[key].totalFace) * 100 
                            : 0;
                        
                        result[key] = {
                            SKUæ•°: skuCount,
                            'SKUæ•°æ§‹æˆæ¯”': skuRatio,
                            'ãƒ•ã‚§ã‚¤ã‚¹æ•°': faceCount,
                            'ãƒ•ã‚§ã‚¤ã‚¹æ•°æ§‹æˆæ¯”': faceRatio
                        };
                    });
                    
                    return result;
                });
                
                if (sortState.column) {
                    aggregatedData = applySorting(aggregatedData);
                }
                
                renderComparisonTable(aggregatedData, sortedStores);
                renderComparisonChart(aggregatedData, sortedStores, items);
            }
            
            function renderComparisonTable(data, stores) {
                const currentLevel = currentHierarchy.length;
                const nextLevel = hierarchyLevels[currentLevel];
                
                let html = '<table><thead><tr>';
                
                for (let i = 0; i < currentLevel; i++) {
                    const levelName = hierarchyLevels[i];
                    html += `<th rowspan="2">${levelName}</th>`;
                }
                
                html += `<th rowspan="2">${nextLevel}</th>`;
                
                stores.forEach((store, index) => {
                    const storeKey = `${store.ä¼æ¥­å}_${store.åº—èˆ—å}`;
                    const storeOrderIndex = storeOrder.indexOf(storeKey);
                    const hiddenClass = hiddenDatasets.has(index) ? ' hidden-column' : '';
                    html += `<th colspan="4" class="draggable-header${hiddenClass}" draggable="true" data-store-index="${storeOrderIndex}" data-dataset-index="${index}">${store.ä¼æ¥­å}<br>${store.åº—èˆ—å}</th>`;
                });
                
                html += '</tr><tr>';
                
                stores.forEach((store, index) => {
                    const storeKey = `${store.ä¼æ¥­å}_${store.åº—èˆ—å}`;
                    const skuSortIcon = getSortIcon(`store_${storeKey}_sku`);
                    const skuRatioSortIcon = getSortIcon(`store_${storeKey}_skuRatio`);
                    const faceSortIcon = getSortIcon(`store_${storeKey}_face`);
                    const faceRatioSortIcon = getSortIcon(`store_${storeKey}_faceRatio`);
                    const hiddenClass = hiddenDatasets.has(index) ? ' hidden-column' : '';
                    
                    html += `<th class="vertical-text sortable${hiddenClass}" data-column="store_${storeKey}_sku" data-dataset-index="${index}">SKUæ•°${skuSortIcon}</th>`;
                    html += `<th class="vertical-text sortable${hiddenClass}" data-column="store_${storeKey}_skuRatio" data-dataset-index="${index}">SKUæ•°æ§‹æˆæ¯”${skuRatioSortIcon}</th>`;
                    html += `<th class="vertical-text sortable${hiddenClass}" data-column="store_${storeKey}_face" data-dataset-index="${index}">ãƒ•ã‚§ã‚¤ã‚¹æ•°${faceSortIcon}</th>`;
                    html += `<th class="vertical-text sortable${hiddenClass}" data-column="store_${storeKey}_faceRatio" data-dataset-index="${index}">ãƒ•ã‚§ã‚¤ã‚¹æ•°æ§‹æˆæ¯”${faceRatioSortIcon}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                data.forEach(item => {
                    html += '<tr>';
                    
                    for (let i = 0; i < currentLevel; i++) {
                        const levelName = hierarchyLevels[i];
                        const levelValue = item.hierarchyPath[levelName] || '';
                        html += `<td>${levelValue}</td>`;
                    }
                    
                    if (currentLevel < 4) {
                        html += `<td><button class="drill-btn" data-item="${item.name}">â–¼</button> ${item.name}</td>`;
                    } else {
                        html += `<td>${item.name}</td>`;
                    }
                    
                    stores.forEach((store, index) => {
                        const key = `${store.ä¼æ¥­å}_${store.åº—èˆ—å}`;
                        const storeData = item[key] || {};
                        const skuRatio = storeData['SKUæ•°æ§‹æˆæ¯”'] || 0;
                        const faceRatio = storeData['ãƒ•ã‚§ã‚¤ã‚¹æ•°æ§‹æˆæ¯”'] || 0;
                        const hiddenClass = hiddenDatasets.has(index) ? ' hidden-column' : '';
                        
                        html += `<td class="${hiddenClass}" data-dataset-index="${index}">${storeData.SKUæ•° || 0}</td>`;
                        html += `<td class="databar-cell databar-sku${hiddenClass}" style="--percentage: ${skuRatio}%" data-dataset-index="${index}">${skuRatio.toFixed(1)}%</td>`;
                        html += `<td class="${hiddenClass}" data-dataset-index="${index}">${storeData['ãƒ•ã‚§ã‚¤ã‚¹æ•°'] || 0}</td>`;
                        html += `<td class="databar-cell databar-face${hiddenClass}" style="--percentage: ${faceRatio}%" data-dataset-index="${index}">${faceRatio.toFixed(1)}%</td>`;
                    });
                    
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                
                document.getElementById('comparisonTable').innerHTML = html;
                
                setupTableInteractions();
            }
            
            function getSortIcon(column) {
                if (sortState.column === column) {
                    if (sortState.direction === 'asc') {
                        return '<span class="sort-icon">â–²</span>';
                    } else if (sortState.direction === 'desc') {
                        return '<span class="sort-icon">â–¼</span>';
                    }
                }
                return '<span class="sort-icon">â‡…</span>';
            }
            
            function setupTableInteractions() {
                document.querySelectorAll('.sortable').forEach(header => {
                    header.addEventListener('click', (e) => {
                        const column = header.dataset.column;
                        
                        if (!sortState.column || sortState.column !== column) {
                            sortState = {column: column, direction: 'asc'};
                        } else if (sortState.direction === 'asc') {
                            sortState.direction = 'desc';
                        } else {
                            sortState = {column: null, direction: null};
                        }
                        
                        if (currentMode === 'hierarchy') {
                            updateComparisonView();
                        } else {
                            updateArbitraryView();
                        }
                    });
                });
                
                setupDragAndDrop();
                
                if (currentHierarchy.length < 4) {
                    document.querySelectorAll('.drill-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            currentHierarchy.push(btn.dataset.item);
                            resetSortAndFilter();
                            updateView();
                        });
                    });
                }
            }
            
            let draggedElement = null;
            let draggedIndex = null;
            
            function setupDragAndDrop() {
                const draggableHeaders = document.querySelectorAll('.draggable-header');
                
                draggableHeaders.forEach(header => {
                    header.addEventListener('dragstart', handleDragStart);
                    header.addEventListener('dragover', handleDragOver);
                    header.addEventListener('drop', handleDrop);
                    header.addEventListener('dragend', handleDragEnd);
                    header.addEventListener('dragenter', handleDragEnter);
                    header.addEventListener('dragleave', handleDragLeave);
                });
            }
            
            function handleDragStart(e) {
                draggedElement = this;
                draggedIndex = parseInt(this.dataset.storeIndex);
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            }
            
            function handleDragOver(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                }
                e.dataTransfer.dropEffect = 'move';
                return false;
            }
            
            function handleDragEnter(e) {
                if (this !== draggedElement) {
                    this.classList.add('drag-over');
                }
            }
            
            function handleDragLeave(e) {
                this.classList.remove('drag-over');
            }
            
            function handleDrop(e) {
                if (e.stopPropagation) {
                    e.stopPropagation();
                }
                
                const dropIndex = parseInt(this.dataset.storeIndex);
                
                if (draggedIndex !== dropIndex) {
                    const item = storeOrder[draggedIndex];
                    storeOrder.splice(draggedIndex, 1);
                    storeOrder.splice(dropIndex, 0, item);
                    
                    if (currentMode === 'hierarchy') {
                        updateView();
                    } else {
                        updateArbitraryView();
                    }
                }
                
                return false;
            }
            
            function handleDragEnd(e) {
                document.querySelectorAll('.draggable-header').forEach(header => {
                    header.classList.remove('dragging', 'drag-over');
                });
                draggedElement = null;
                draggedIndex = null;
            }
            
            function getStoreColor(index) {
                if (index === 0) {
                    return {
                        bg: '#1F5F8B',
                        border: '#164563'
                    };
                }
                const grayValue = 200 - (index * 40);
                const borderValue = Math.max(grayValue - 30, 20);
                return {
                    bg: `rgb(${grayValue}, ${grayValue}, ${grayValue})`,
                    border: `rgb(${borderValue}, ${borderValue}, ${borderValue})`
                };
            }
            
            function renderComparisonChart(data, stores) {
                const ctx = document.getElementById('comparisonChart');
                
                if (comparisonChart) {
                    comparisonChart.destroy();
                }
                
                const metricMap = {
                    'sku': 'SKUæ•°',
                    'skuRatio': 'SKUæ•°æ§‹æˆæ¯”',
                    'face': 'ãƒ•ã‚§ã‚¤ã‚¹æ•°',
                    'faceRatio': 'ãƒ•ã‚§ã‚¤ã‚¹æ•°æ§‹æˆæ¯”'
                };
                
                const metricLabel = metricMap[currentMetric];
                const currentLevel = currentHierarchy.length;
                
                const labels = [];
                
                if (currentLevel > 0) {
                    const parentLevelName = hierarchyLevels[currentLevel - 1];
                    data.forEach((d) => {
                        const parent = d.hierarchyPath[parentLevelName] || '';
                        const labelArray = [d.name, parent];
                        labels.push(labelArray);
                    });
                } else {
                    data.forEach(d => {
                        labels.push([d.name, '']);
                    });
                }
                
                const datasets = stores.map((store, index) => {
                    const key = `${store.ä¼æ¥­å}_${store.åº—èˆ—å}`;
                    const colors = getStoreColor(index);
                    return {
                        label: store.åº—èˆ—å,
                        data: data.map(item => item[key] ? item[key][metricLabel] : 0),
                        backgroundColor: colors.bg,
                        borderColor: colors.border,
                        borderWidth: 1,
                        itemNames: data.map(d => d.name),
                        hidden: hiddenDatasets.has(index)
                    };
                });
                
                comparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onClick: (event, activeElements) => {
                            if (activeElements.length > 0 && currentHierarchy.length < 4) {
                                const index = activeElements[0].index;
                                const itemName = datasets[0].itemNames[index];
                                currentHierarchy.push(itemName);
                                resetSortAndFilter();
                                updateView();
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                onClick: function(e, legendItem, legend) {
                                    const index = legendItem.datasetIndex;
                                    const ci = legend.chart;
                                    
                                    if (ci.isDatasetVisible(index)) {
                                        ci.hide(index);
                                        hiddenDatasets.add(index);
                                        legendItem.hidden = true;
                                    } else {
                                        ci.show(index);
                                        hiddenDatasets.delete(index);
                                        legendItem.hidden = false;
                                    }
                                    
                                    toggleTableColumns(index, !ci.isDatasetVisible(index));
                                }
                            },
                            title: {
                                display: true,
                                text: metricLabel + ' æ¯”è¼ƒ'
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    autoSkip: false,
                                    maxRotation: 45,
                                    minRotation: 0
                                }
                            },
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            function toggleTableColumns(datasetIndex, hide) {
                const table = document.querySelector('#comparisonTable table, #arbitraryTable table');
                if (!table) return;
                
                const allCells = table.querySelectorAll(`[data-dataset-index="${datasetIndex}"]`);
                allCells.forEach(cell => {
                    if (hide) {
                        cell.classList.add('hidden-column');
                    } else {
                        cell.classList.remove('hidden-column');
                    }
                });
            }
            
            document.getElementById('drillAllBtn').addEventListener('click', () => {
                if (currentHierarchy.length < 4) {
                    currentHierarchy.push('*ALL*');
                    resetSortAndFilter();
                    updateView();
                }
            });
            
            function updateMatrixView() {
                const data = getCurrentData();
                
                const sortedStores = getStoreList(data);
                
                const productMap = {};
                data.forEach(d => {
                    const jan = d['JAN'];
                    if (!productMap[jan]) {
                        productMap[jan] = {
                            JAN: jan,
                            å•†å“å: d['å•†å“å'],
                            ã‚«ãƒ†ã‚´ãƒªãƒ¼: d['ã‚«ãƒ†ã‚´ãƒªãƒ¼'],
                            ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼: d['ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼'],
                            ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ: d['ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ'],
                            ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ: d['ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ'],
                            stores: {}
                        };
                    }
                    const storeKey = `${d['ä¼æ¥­å']}_${d['åº—èˆ—å']}`;
                    productMap[jan].stores[storeKey] = true;
                });
                
                const products = Object.values(productMap);
                
                const searchTerm = document.getElementById('productSearch').value.toLowerCase();
                const filteredProducts = products.filter(p => 
                    p.å•†å“å.toLowerCase().includes(searchTerm) || 
                    p.JAN.toString().includes(searchTerm)
                );
                
                const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const pageProducts = filteredProducts.slice(startIndex, endIndex);
                
                let html = '<table><thead><tr>';
                html += '<th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th><th>ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼</th><th>ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</th><th>ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</th>';
                html += '<th>JANã‚³ãƒ¼ãƒ‰</th><th>å•†å“å</th>';
                sortedStores.forEach(store => {
                    html += `<th>${store.ä¼æ¥­å}<br>${store.åº—èˆ—å}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                pageProducts.forEach(product => {
                    html += '<tr>';
                    html += `<td>${product.ã‚«ãƒ†ã‚´ãƒªãƒ¼ || ''}</td>`;
                    html += `<td>${product.ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ || ''}</td>`;
                    html += `<td>${product.ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ || ''}</td>`;
                    html += `<td>${product.ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ || ''}</td>`;
                    html += `<td>${product.JAN}</td>`;
                    html += `<td>${product.å•†å“å}</td>`;
                    
                    sortedStores.forEach(store => {
                        const storeKey = `${store.ä¼æ¥­å}_${store.åº—èˆ—å}`;
                        const hasProduct = product.stores[storeKey] || false;
                        html += `<td class="has-product">${hasProduct ? 'â—¯' : ''}</td>`;
                    });
                    
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                
                document.getElementById('matrixTable').innerHTML = html;
                document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPages}`;
                document.getElementById('prevPage').disabled = currentPage === 1;
                document.getElementById('nextPage').disabled = currentPage === totalPages;
            }
            
            document.getElementById('productSearch').addEventListener('input', () => {
                currentPage = 1;
                updateMatrixView();
            });
            
            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    updateMatrixView();
                }
            });
            
            document.getElementById('nextPage').addEventListener('click', () => {
                const searchTerm = document.getElementById('productSearch').value.toLowerCase();
                const data = getCurrentData();
                
                const productMap = {};
                data.forEach(d => {
                    const jan = d['JAN'];
                    if (!productMap[jan]) {
                        productMap[jan] = {
                            JAN: jan,
                            å•†å“å: d['å•†å“å']
                        };
                    }
                });
                
                const products = Object.values(productMap);
                const filteredProducts = products.filter(p => 
                    p.å•†å“å.toLowerCase().includes(searchTerm) || 
                    p.JAN.toString().includes(searchTerm)
                );
                const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
                
                if (currentPage < totalPages) {
                    currentPage++;
                    updateMatrixView();
                }
            });
            
            document.getElementById('arbitraryAxis').addEventListener('change', () => {
                resetSortAndFilter();
                updateArbitraryView();
            });
            
            function updateArbitraryView() {
                const axis = document.getElementById('arbitraryAxis').value;
                const data = filteredData;
                
                const sortedStores = getStoreList(data);
                
                const categoryTotals = {};
                sortedStores.forEach(store => {
                    const key = `${store.ä¼æ¥­å}_${store.åº—èˆ—å}`;
                    const storeData = filteredData.filter(d => 
                        d['ä¼æ¥­å'] === store.ä¼æ¥­å && d['åº—èˆ—å'] === store.åº—èˆ—å
                    );
                    categoryTotals[key] = {
                        totalSKU: storeData.reduce((sum, d) => sum + (d['SKUæ•°'] || 0), 0),
                        totalFace: storeData.reduce((sum, d) => sum + (d['ãƒ•ã‚§ã‚¤ã‚¹æ•°'] || 0), 0)
                    };
                });
                
                const items = [...new Set(data.map(d => d[axis]))].filter(x => x).sort();
                
                let aggregatedData = items.map(item => {
                    const itemData = data.filter(d => d[axis] === item);
                    const result = { 
                        name: item,
                        hierarchyPath: {}
                    };
                    
                    sortedStores.forEach(store => {
                        const key = `${store.ä¼æ¥­å}_${store.åº—èˆ—å}`;
                        const storeData = itemData.filter(d => 
                            d['ä¼æ¥­å'] === store.ä¼æ¥­å && d['åº—èˆ—å'] === store.åº—èˆ—å
                        );
                        
                        const skuCount = storeData.reduce((sum, d) => sum + (d['SKUæ•°'] || 0), 0);
                        const faceCount = storeData.reduce((sum, d) => sum + (d['ãƒ•ã‚§ã‚¤ã‚¹æ•°'] || 0), 0);
                        
                        const skuRatio = categoryTotals[key].totalSKU > 0 
                            ? (skuCount / categoryTotals[key].totalSKU) * 100 
                            : 0;
                        const faceRatio = categoryTotals[key].totalFace > 0 
                            ? (faceCount / categoryTotals[key].totalFace) * 100 
                            : 0;
                        
                        result[key] = {
                            SKUæ•°: skuCount,
                            'SKUæ•°æ§‹æˆæ¯”': skuRatio,
                            'ãƒ•ã‚§ã‚¤ã‚¹æ•°': faceCount,
                            'ãƒ•ã‚§ã‚¤ã‚¹æ•°æ§‹æˆæ¯”': faceRatio
                        };
                    });
                    
                    return result;
                });
                
                if (sortState.column) {
                    aggregatedData = applySorting(aggregatedData);
                }
                
                renderArbitraryTable(aggregatedData, sortedStores, axis);
                renderArbitraryChart(aggregatedData, sortedStores, axis);
            }
            
            function renderArbitraryTable(data, stores, axis) {
                let html = '<table><thead><tr>';
                
                html += `<th rowspan="2">${axis}</th>`;
                
                stores.forEach((store, index) => {
                    const storeKey = `${store.ä¼æ¥­å}_${store.åº—èˆ—å}`;
                    const storeOrderIndex = storeOrder.indexOf(storeKey);
                    const hiddenClass = hiddenDatasets.has(index) ? ' hidden-column' : '';
                    html += `<th colspan="4" class="draggable-header${hiddenClass}" draggable="true" data-store-index="${storeOrderIndex}" data-dataset-index="${index}">${store.ä¼æ¥­å}<br>${store.åº—èˆ—å}</th>`;
                });
                
                html += '</tr><tr>';
                
                stores.forEach((store, index) => {
                    const storeKey = `${store.ä¼æ¥­å}_${store.åº—èˆ—å}`;
                    const skuSortIcon = getSortIcon(`store_${storeKey}_sku`);
                    const skuRatioSortIcon = getSortIcon(`store_${storeKey}_skuRatio`);
                    const faceSortIcon = getSortIcon(`store_${storeKey}_face`);
                    const faceRatioSortIcon = getSortIcon(`store_${storeKey}_faceRatio`);
                    const hiddenClass = hiddenDatasets.has(index) ? ' hidden-column' : '';
                    
                    html += `<th class="vertical-text sortable${hiddenClass}" data-column="store_${storeKey}_sku" data-dataset-index="${index}">SKUæ•°${skuSortIcon}</th>`;
                    html += `<th class="vertical-text sortable${hiddenClass}" data-column="store_${storeKey}_skuRatio" data-dataset-index="${index}">SKUæ•°æ§‹æˆæ¯”${skuRatioSortIcon}</th>`;
                    html += `<th class="vertical-text sortable${hiddenClass}" data-column="store_${storeKey}_face" data-dataset-index="${index}">ãƒ•ã‚§ã‚¤ã‚¹æ•°${faceSortIcon}</th>`;
                    html += `<th class="vertical-text sortable${hiddenClass}" data-column="store_${storeKey}_faceRatio" data-dataset-index="${index}">ãƒ•ã‚§ã‚¤ã‚¹æ•°æ§‹æˆæ¯”${faceRatioSortIcon}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                data.forEach(item => {
                    html += `<tr><td>${item.name}</td>`;
                    
                    stores.forEach((store, index) => {
                        const key = `${store.ä¼æ¥­å}_${store.åº—èˆ—å}`;
                        const storeData = item[key] || {};
                        const skuRatio = storeData['SKUæ•°æ§‹æˆæ¯”'] || 0;
                        const faceRatio = storeData['ãƒ•ã‚§ã‚¤ã‚¹æ•°æ§‹æˆæ¯”'] || 0;
                        const hiddenClass = hiddenDatasets.has(index) ? ' hidden-column' : '';
                        
                        html += `<td class="${hiddenClass}" data-dataset-index="${index}">${storeData.SKUæ•° || 0}</td>`;
                        html += `<td class="databar-cell databar-sku${hiddenClass}" style="--percentage: ${skuRatio}%" data-dataset-index="${index}">${skuRatio.toFixed(1)}%</td>`;
                        html += `<td class="${hiddenClass}" data-dataset-index="${index}">${storeData['ãƒ•ã‚§ã‚¤ã‚¹æ•°'] || 0}</td>`;
                        html += `<td class="databar-cell databar-face${hiddenClass}" style="--percentage: ${faceRatio}%" data-dataset-index="${index}">${faceRatio.toFixed(1)}%</td>`;
                    });
                    
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                
                document.getElementById('arbitraryTable').innerHTML = html;
                
                setupTableInteractions();
            }
            
            function renderArbitraryChart(data, stores, axis) {
                const ctx = document.getElementById('arbitraryChart');
                
                if (arbitraryChart) {
                    arbitraryChart.destroy();
                }
                
                const metricMap = {
                    'sku': 'SKUæ•°',
                    'skuRatio': 'SKUæ•°æ§‹æˆæ¯”',
                    'face': 'ãƒ•ã‚§ã‚¤ã‚¹æ•°',
                    'faceRatio': 'ãƒ•ã‚§ã‚¤ã‚¹æ•°æ§‹æˆæ¯”'
                };
                
                const metricLabel = metricMap[currentMetric];
                
                const datasets = stores.map((store, index) => {
                    const key = `${store.ä¼æ¥­å}_${store.åº—èˆ—å}`;
                    const colors = getStoreColor(index);
                    
                    return {
                        label: store.åº—èˆ—å,
                        data: data.map(item => item[key] ? item[key][metricLabel] : 0),
                        backgroundColor: colors.bg,
                        borderColor: colors.border,
                        borderWidth: 1,
                        hidden: hiddenDatasets.has(index)
                    };
                });
                
                arbitraryChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.name),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                onClick: function(e, legendItem, legend) {
                                    const index = legendItem.datasetIndex;
                                    const ci = legend.chart;
                                    
                                    if (ci.isDatasetVisible(index)) {
                                        ci.hide(index);
                                        hiddenDatasets.add(index);
                                        legendItem.hidden = true;
                                    } else {
                                        ci.show(index);
                                        hiddenDatasets.delete(index);
                                        legendItem.hidden = false;
                                    }
                                    
                                    toggleTableColumns(index, !ci.isDatasetVisible(index));
                                }
                            },
                            title: {
                                display: true,
                                text: axis + ' - ' + metricLabel + ' æ¯”è¼ƒ'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            document.getElementById('exportBtn').addEventListener('click', () => {
                if (currentMode === 'hierarchy' && currentHierarchy.length === 4) {
                    const data = getCurrentData();
                    const sortedStores = getStoreList(data);
                    
                    const productMap = {};
                    data.forEach(d => {
                        const jan = d['JAN'];
                        if (!productMap[jan]) {
                            productMap[jan] = {
                                'ã‚«ãƒ†ã‚´ãƒªãƒ¼': d['ã‚«ãƒ†ã‚´ãƒªãƒ¼'] || '',
                                'ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼': d['ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼'] || '',
                                'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ': d['ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ'] || '',
                                'ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ': d['ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ'] || '',
                                'JANã‚³ãƒ¼ãƒ‰': jan,
                                'å•†å“å': d['å•†å“å']
                            };
                            sortedStores.forEach(store => {
                                const storeKey = `${store.ä¼æ¥­å}_${store.åº—èˆ—å}`;
                                productMap[jan][storeKey] = '';
                            });
                        }
                        const storeKey = `${d['ä¼æ¥­å']}_${d['åº—èˆ—å']}`;
                        productMap[jan][storeKey] = 'â—¯';
                    });
                    
                    const products = Object.values(productMap);
                    
                    const headers = ['ã‚«ãƒ†ã‚´ãƒªãƒ¼', 'ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼', 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ', 'ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ', 'JANã‚³ãƒ¼ãƒ‰', 'å•†å“å'];
                    sortedStores.forEach(store => {
                        headers.push(`${store.ä¼æ¥­å}_${store.åº—èˆ—å}`);
                    });
                    
                    const exportData = products.map(p => {
                        const row = {};
                        headers.forEach(header => {
                            row[header] = p[header] || '';
                        });
                        return row;
                    });
                    
                    const ws = XLSX.utils.json_to_sheet(exportData, { header: headers });
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "å•†å“ãƒãƒˆãƒªã‚¯ã‚¹");
                    
                    const filename = 'å•†å“ãƒãƒˆãƒªã‚¯ã‚¹_' + new Date().toISOString().slice(0, 10) + '.xlsx';
                    XLSX.writeFile(wb, filename);
                } else {
                    alert('å•†å“ãƒãƒˆãƒªã‚¯ã‚¹ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã«ã¯ã€ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã¾ã§ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                }
            });
            
            document.getElementById('downloadChartBtn').addEventListener('click', () => {
                if (comparisonChart) {
                    const aspectRatio = parseAspectRatio('chartAspectRatioPreset', 'chartAspectWidth', 'chartAspectHeight');
                    downloadChartWithAspectRatio(comparisonChart, aspectRatio, 'ã‚°ãƒ©ãƒ•');
                }
            });
            
            document.getElementById('downloadArbitraryChartBtn').addEventListener('click', () => {
                if (arbitraryChart) {
                    const aspectRatio = parseAspectRatio('arbitraryChartAspectRatioPreset', 'arbitraryChartAspectWidth', 'arbitraryChartAspectHeight');
                    downloadChartWithAspectRatio(arbitraryChart, aspectRatio, 'ã‚°ãƒ©ãƒ•_ä»»æ„é …ç›®');
                }
            });
            
            function downloadChartWithAspectRatio(chart, aspectRatio, filename) {
                const baseWidth = 1920;
                const newWidth = baseWidth;
                const newHeight = Math.round(baseWidth * aspectRatio.height / aspectRatio.width);
                
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = newWidth;
                tempCanvas.height = newHeight;
                tempCanvas.style.width = newWidth + 'px';
                tempCanvas.style.height = newHeight + 'px';
                
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                tempContainer.style.width = newWidth + 'px';
                tempContainer.style.height = newHeight + 'px';
                tempContainer.appendChild(tempCanvas);
                document.body.appendChild(tempContainer);
                
                const tempChart = new Chart(tempCanvas, {
                    type: chart.config.type,
                    data: chart.config.data,
                    options: {
                        ...chart.config.options,
                        responsive: false,
                        maintainAspectRatio: false,
                        animation: false
                    }
                });
                
                setTimeout(() => {
                    const url = tempCanvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = filename + '_' + new Date().toISOString().slice(0, 10) + '.png';
                    link.href = url;
                    link.click();
                    
                    tempChart.destroy();
                    document.body.removeChild(tempContainer);
                }, 100);
            }
            
            document.getElementById('exportTableBtn').addEventListener('click', () => {
                exportTableAsImage('comparisonTable', 'æ¯”è¼ƒè¡¨');
            });
            
            document.getElementById('exportArbitraryTableBtn').addEventListener('click', () => {
                exportTableAsImage('arbitraryTable', 'ä»»æ„é …ç›®åˆ†æè¡¨');
            });
            

            

            // ä¾¡æ ¼æˆ¦ç•¥åˆ†æãƒ¢ãƒ¼ãƒ‰ï¼ˆæ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
            let priceGranularity = 'ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼';
            let selectedPriceItems = [];
            let priceYAxis = 'sku';
            let priceCharts = [];
            
            const deepPastelColors = [
                '#FF6B7A', '#FFB366', '#FFE566', '#66D98A', '#66B3FF',
                '#FF66CC', '#9966FF', '#FFB366', '#66FFCC', '#CC66FF',
                '#FF8899', '#FFCC88', '#FFFF88', '#88FFAA', '#88CCFF',
                '#FF88CC', '#CC88FF', '#FFCC99', '#99FFCC', '#CC99FF'
            ];
            
            function initializePriceMode() {
                // åˆ†æç²’åº¦å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
                document.getElementById('priceGranularity').addEventListener('change', function(e) {
                    priceGranularity = e.target.value;
                    updatePriceHierarchySelectors();
                    clearPriceCharts();
                });
                
                // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ç²’åº¦ç”¨ï¼ˆå˜ä¸€ã‚¹ãƒ©ã‚¤ã‚µãƒ¼ï¼‰
                document.getElementById('priceSubCategorySelect').addEventListener('change', function(e) {
                    selectedPriceItems = Array.from(e.target.selectedOptions).map(function(opt) {
                        return opt.value;
                    });
                    updatePriceCharts();
                });
                
                // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç²’åº¦ç”¨
                document.getElementById('priceSegmentParentSelect').addEventListener('change', function(e) {
                    updatePriceChildSelector('priceSegmentParentSelect', 'priceSegmentSelect', 'ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼', 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ');
                });
                
                document.getElementById('priceSegmentSelect').addEventListener('change', function(e) {
                    selectedPriceItems = Array.from(e.target.selectedOptions).map(function(opt) {
                        return opt.value;
                    });
                    updatePriceCharts();
                });
                
                // ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç²’åº¦ç”¨
                document.getElementById('priceSubSegmentParentSelect').addEventListener('change', function(e) {
                    updatePriceChildSelector('priceSubSegmentParentSelect', 'priceSubSegmentSelect', 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ', 'ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ');
                });
                
                document.getElementById('priceSubSegmentSelect').addEventListener('change', function(e) {
                    selectedPriceItems = Array.from(e.target.selectedOptions).map(function(opt) {
                        return opt.value;
                    });
                    updatePriceCharts();
                });
                
                // ç¸¦è»¸ãƒ»åˆ»ã¿å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
                document.getElementById('priceYAxis').addEventListener('change', function(e) {
                    priceYAxis = e.target.value;
                    if (selectedPriceItems.length > 0) {
                        updatePriceCharts();
                    }
                });
                
                document.getElementById('priceInterval').addEventListener('change', function(e) {
                    priceInterval = parseInt(e.target.value);
                    if (selectedPriceItems.length > 0) {
                        updatePriceCharts();
                    }
                });
                
                document.getElementById('downloadPriceChartsBtn').addEventListener('click', downloadAllPriceCharts);
                
                // å•†å“ãƒãƒˆãƒªã‚¯ã‚¹ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                const closeBtn = document.getElementById('closeProductMatrixBtn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', closeProductMatrix);
                }
                
                const modal = document.getElementById('productMatrixModal');
                if (modal) {
                    modal.addEventListener('click', function(e) {
                        if (e.target.id === 'productMatrixModal') {
                            closeProductMatrix();
                        }
                    });
                }
                
                // Escã‚­ãƒ¼ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        const modal = document.getElementById('productMatrixModal');
                        if (modal && !modal.classList.contains('hidden')) {
                            closeProductMatrix();
                        }
                    }
                });
            }
            
            function updatePriceHierarchySelectors() {
                // ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ãƒƒãƒˆã‚’éè¡¨ç¤º
                document.getElementById('priceFilterCategory').classList.add('hidden');
                document.getElementById('priceFilterSubCategory').classList.add('hidden');
                document.getElementById('priceFilterSegment').classList.add('hidden');
                document.getElementById('priceFilterSubSegment').classList.add('hidden');
                
                // filteredDataã‚’ç›´æ¥ä½¿ç”¨
                const data = filteredData;
                
                // åˆ†æç²’åº¦ã«å¿œã˜ã¦é©åˆ‡ãªã‚¹ãƒ©ã‚¤ã‚µãƒ¼ã‚’è¡¨ç¤ºãƒ»åˆæœŸåŒ–
                if (priceGranularity === 'ã‚«ãƒ†ã‚´ãƒªãƒ¼') {
                    // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¯æ—¢å­˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§é¸æŠæ¸ˆã¿ã®ãŸã‚ã‚¹ãƒ©ã‚¤ã‚µãƒ¼ä¸è¦
                    document.getElementById('priceFilterCategory').classList.remove('hidden');
                    // ã‚°ãƒ©ãƒ•ç”Ÿæˆç”¨ã«ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§ã‚’å–å¾—
                    const uniqueCategories = [];
                    const seenCategories = {};
                    data.forEach(function(d) {
                        const cat = d['ã‚«ãƒ†ã‚´ãƒªãƒ¼'];
                        if (cat && !seenCategories[cat]) {
                            uniqueCategories.push(cat);
                            seenCategories[cat] = true;
                        }
                    });
                    uniqueCategories.sort();
                    selectedPriceItems = uniqueCategories; // è‡ªå‹•çš„ã«å…¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠ
                } else if (priceGranularity === 'ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼') {
                    // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ã¿ï¼ˆå˜ä¸€ã‚¹ãƒ©ã‚¤ã‚µãƒ¼ï¼‰
                    document.getElementById('priceFilterSubCategory').classList.remove('hidden');
                    initializeSingleSelector('priceSubCategorySelect', data, 'ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼');
                } else if (priceGranularity === 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ') {
                    // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ + ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ
                    document.getElementById('priceFilterSegment').classList.remove('hidden');
                    initializeSingleSelector('priceSegmentParentSelect', data, 'ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼');
                    initializeSingleSelector('priceSegmentSelect', data, 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ');
                } else if (priceGranularity === 'ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ') {
                    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ + ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ
                    document.getElementById('priceFilterSubSegment').classList.remove('hidden');
                    initializeSingleSelector('priceSubSegmentParentSelect', data, 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ');
                    initializeSingleSelector('priceSubSegmentSelect', data, 'ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ');
                }
                
                // ã‚«ãƒ†ã‚´ãƒªãƒ¼ç²’åº¦ä»¥å¤–ã¯é¸æŠã‚’ã‚¯ãƒªã‚¢
                if (priceGranularity !== 'ã‚«ãƒ†ã‚´ãƒªãƒ¼') {
                    selectedPriceItems = [];
                }
                
                // ã‚«ãƒ†ã‚´ãƒªãƒ¼ç²’åº¦ã®å ´åˆã¯è‡ªå‹•çš„ã«ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
                if (priceGranularity === 'ã‚«ãƒ†ã‚´ãƒªãƒ¼' && selectedPriceItems.length > 0) {
                    updatePriceCharts();
                } else {
                    clearPriceCharts();
                }
            }
            
            function initializeSingleSelector(selectId, data, columnName) {
                const uniqueItems = [];
                const seenItems = {};
                
                data.forEach(function(d) {
                    const item = d[columnName];
                    if (item && !seenItems[item]) {
                        uniqueItems.push(item);
                        seenItems[item] = true;
                    }
                });
                
                uniqueItems.sort();
                
                const select = document.getElementById(selectId);
                select.innerHTML = uniqueItems.map(function(item) {
                    return '<option value="' + item + '">' + item + '</option>';
                }).join('');
            }
            
            function updatePriceChildSelector(parentSelectId, childSelectId, parentColumn, childColumn) {
                const parentSelect = document.getElementById(parentSelectId);
                const selectedParents = Array.from(parentSelect.selectedOptions).map(function(opt) {
                    return opt.value;
                });
                
                const data = filteredData;
                const uniqueItems = [];
                const seenItems = {};
                
                data.forEach(function(d) {
                    // è¦ªãŒæœªé¸æŠã®å ´åˆã¯å…¨é …ç›®ã€é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯çµã‚Šè¾¼ã¿
                    if (selectedParents.length === 0 || selectedParents.includes(d[parentColumn])) {
                        const item = d[childColumn];
                        if (item && !seenItems[item]) {
                            uniqueItems.push(item);
                            seenItems[item] = true;
                        }
                    }
                });
                
                uniqueItems.sort();
                
                const childSelect = document.getElementById(childSelectId);
                childSelect.innerHTML = uniqueItems.map(function(item) {
                    return '<option value="' + item + '">' + item + '</option>';
                }).join('');
                
                // å­ã‚¹ãƒ©ã‚¤ã‚µãƒ¼ã®é¸æŠã‚’ã‚¯ãƒªã‚¢
                selectedPriceItems = [];
                clearPriceCharts();
            }
            
            function clearPriceCharts() {
                priceCharts.forEach(function(chart) {
                    if (chart) {
                        chart.destroy();
                    }
                });
                priceCharts = [];
                document.getElementById('priceChartsContainer').innerHTML = '';
            }
            
            function updatePriceCharts() {
                clearPriceCharts();
                
                if (selectedPriceItems.length === 0) {
                    return;
                }
                
                // filteredDataã‚’ç›´æ¥ä½¿ç”¨
                const data = filteredData;
                const stores = getStoreList(data);
                const container = document.getElementById('priceChartsContainer');
                
                selectedPriceItems.forEach(function(item, index) {
                    // ä¿®æ­£ï¼šéšå±¤ã‚’è€ƒæ…®ã—ãŸãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                    const itemData = data.filter(function(d) {
                        // åŸºæœ¬æ¡ä»¶ï¼šé¸æŠã•ã‚ŒãŸç²’åº¦ã®å€¤ãŒä¸€è‡´
                        if (d[priceGranularity] !== item) return false;
                        
                        // éšå±¤ã«ã‚ˆã‚‹è¿½åŠ ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                        if (priceGranularity === 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ') {
                            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å ´åˆã€è¦ªã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚‚ç¢ºèª
                            const selectedSubCategories = Array.from(document.getElementById('priceSegmentParentSelect').selectedOptions)
                                .map(opt => opt.value);
                            if (selectedSubCategories.length > 0 && !selectedSubCategories.includes(d['ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼'])) {
                                return false;
                            }
                        } else if (priceGranularity === 'ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ') {
                            // ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å ´åˆã€è¦ªã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚‚ç¢ºèª
                            const selectedSegments = Array.from(document.getElementById('priceSubSegmentParentSelect').selectedOptions)
                                .map(opt => opt.value);
                            if (selectedSegments.length > 0 && !selectedSegments.includes(d['ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ'])) {
                                return false;
                            }
                        }
                        
                        return true;
                    });
                    
                    if (itemData.length === 0) {
                        return;
                    }
                    
                    const chartWrapper = document.createElement('div');
                    chartWrapper.className = 'price-chart-wrapper';
                    chartWrapper.innerHTML = '<h3 class="price-chart-title">' + item + '</h3>' +
                                            '<div class="price-chart-container">' +
                                            '<canvas id="priceChart_' + index + '"></canvas>' +
                                            '</div>';
                    container.appendChild(chartWrapper);
                    
                    const chartData = preparePriceChartData(itemData, stores);
                    if (chartData) {
                        const chart = renderPriceLineChart('priceChart_' + index, chartData, item);
                        if (chart) {
                            priceCharts.push(chart);
                        }
                    }
                });
            }
            
            function preparePriceChartData(data, stores) {
                const prices = [];
                data.forEach(function(d) {
                    const price = d['ä¾¡æ ¼'];
                    if (price && !isNaN(price)) {
                        prices.push(price);
                    }
                });
                
                if (prices.length === 0) {
                    return null;
                }
                
                const minPrice = Math.min.apply(Math, prices);
                const maxPrice = Math.max.apply(Math, prices);
                
                const priceBands = [];
                let start = Math.floor(minPrice / priceInterval) * priceInterval;
                
                while (start <= maxPrice) {
                    priceBands.push(start);
                    start += priceInterval;
                }
                
                const storeData = {};
                
                stores.forEach(function(store) {
                    const storeKey = store.ä¼æ¥­å + '_' + store.åº—èˆ—å;
                    storeData[storeKey] = {
                        label: store.åº—èˆ—å,
                        data: []
                    };
                    
                    const storeItems = data.filter(function(d) {
                        return d['ä¼æ¥­å'] === store.ä¼æ¥­å && d['åº—èˆ—å'] === store.åº—èˆ—å;
                    });
                    
                    priceBands.forEach(function(pricePoint) {
                        const itemsInBand = storeItems.filter(function(d) {
                            const price = d['ä¾¡æ ¼'];
                            return price >= pricePoint && price < pricePoint + priceInterval;
                        });
                        
                        let value = 0;
                        if (priceYAxis === 'sku') {
                            value = itemsInBand.length;
                        } else {
                            value = itemsInBand.reduce(function(sum, d) {
                                return sum + (d['ãƒ•ã‚§ã‚¤ã‚¹æ•°'] || 0);
                            }, 0);
                        }
                        
                        storeData[storeKey].data.push(value);
                    });
                });
                
                const datasetsArray = [];
                const keys = Object.keys(storeData);
                keys.forEach(function(key, idx) {
                    datasetsArray.push({
                        label: storeData[key].label,
                        data: storeData[key].data,
                        borderColor: deepPastelColors[idx % deepPastelColors.length],
                        backgroundColor: deepPastelColors[idx % deepPastelColors.length],
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    });
                });
                
                return {
                    labels: priceBands.map(function(p) {
                        return p + 'å††';
                    }),
                    datasets: datasetsArray
                };
            }
            
            function renderPriceLineChart(canvasId, chartData, title) {
                if (!chartData) {
                    return null;
                }
                
                const ctx = document.getElementById(canvasId);
                if (!ctx) {
                    console.error('Canvas element not found:', canvasId);
                    return null;
                }
                
                return new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2,
                        onClick: function(event, elements) {
                            try {
                                if (elements.length > 0) {
                                    const element = elements[0];
                                    const datasetIndex = element.datasetIndex;
                                    const index = element.index;
                                    const priceLabel = chartData.labels[index];
                                    const priceValue = parseInt(priceLabel.replace('å††', ''));
                                    
                                    if (!isNaN(priceValue)) {
                                        // å•†å“ãƒãƒˆãƒªã‚¯ã‚¹ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
                                        showProductMatrix(title, priceValue);
                                    }
                                }
                            } catch (error) {
                                console.error('ã‚°ãƒ©ãƒ•ã‚¯ãƒªãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                            }
                        },
                        plugins: {
                            title: {
                                display: false
                            },
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y;
                                        const unit = priceYAxis === 'sku' ? 'SKU' : 'ãƒ•ã‚§ã‚¤ã‚¹';
                                        return label + ': ' + value + unit;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'ãƒ—ãƒ©ã‚¤ã‚¹ãƒ©ã‚¤ãƒ³'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: priceYAxis === 'sku' ? 'SKUæ•°' : 'ãƒ•ã‚§ã‚¤ã‚¹æ•°'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    }
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });
            }
            
            function downloadAllPriceCharts() {
                if (priceCharts.length === 0) {
                    alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚°ãƒ©ãƒ•ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                priceCharts.forEach(function(chart, index) {
                    setTimeout(function() {
                        const url = chart.toBase64Image();
                        const link = document.createElement('a');
                        const date = new Date().toISOString().slice(0, 10);
                        link.download = 'ä¾¡æ ¼æˆ¦ç•¥åˆ†æ_' + selectedPriceItems[index] + '_' + date + '.png';
                        link.href = url;
                        link.click();
                    }, index * 500);
                });
            }
            
            // å•†å“ãƒãƒˆãƒªã‚¯ã‚¹ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ©Ÿèƒ½
            function showProductMatrix(categoryName, pricePoint) {
                try {
                    console.log('=== å•†å“ãƒãƒˆãƒªã‚¯ã‚¹è¡¨ç¤ºé–‹å§‹ ===');
                    console.log('ã‚«ãƒ†ã‚´ãƒªãƒ¼:', categoryName);
                    console.log('ä¾¡æ ¼å¸¯:', pricePoint, 'å†† ã€œ', (pricePoint + priceInterval - 1), 'å††');
                    console.log('ä¾¡æ ¼é–“éš”:', priceInterval);
                    console.log('ä¾¡æ ¼ç²’åº¦:', priceGranularity);
                    
                    // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                    if (!filteredData || filteredData.length === 0) {
                        alert('ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                        return;
                    }
                    
                    console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‰ã®ãƒ‡ãƒ¼ã‚¿æ•°:', filteredData.length);
                    
                    // è©²å½“ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ»ãƒ—ãƒ©ã‚¤ã‚¹ãƒ©ã‚¤ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    const data = filteredData.filter(function(d) {
                        const itemValue = d[priceGranularity];
                        const price = d['ä¾¡æ ¼'];
                        
                        // åŸºæœ¬æ¡ä»¶ï¼šä¾¡æ ¼ã¨é¸æŠé …ç›®ã®ä¸€è‡´
                        const basicCondition = itemValue === categoryName && 
                                              price != null && 
                                              !isNaN(price) &&
                                              price >= pricePoint && 
                                              price < pricePoint + priceInterval;
                        
                        if (!basicCondition) return false;
                        
                        // ä¿®æ­£ï¼šéšå±¤ã«ã‚ˆã‚‹è¿½åŠ ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                        if (priceGranularity === 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ') {
                            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å ´åˆã€è¦ªã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚‚ç¢ºèª
                            const selectedSubCategories = Array.from(document.getElementById('priceSegmentParentSelect').selectedOptions)
                                .map(opt => opt.value);
                            if (selectedSubCategories.length > 0 && !selectedSubCategories.includes(d['ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼'])) {
                                return false;
                            }
                        } else if (priceGranularity === 'ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ') {
                            // ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å ´åˆã€è¦ªã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚‚ç¢ºèª
                            const selectedSegments = Array.from(document.getElementById('priceSubSegmentParentSelect').selectedOptions)
                                .map(opt => opt.value);
                            if (selectedSegments.length > 0 && !selectedSegments.includes(d['ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ'])) {
                                return false;
                            }
                        }
                        
                        return true;
                    });
                    
                    console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœ:', data.length, 'ä»¶ã®å•†å“');
                    
                    if (data.length === 0) {
                        alert('è©²å½“ã™ã‚‹å•†å“ãŒã‚ã‚Šã¾ã›ã‚“\nï¼ˆä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰');
                        return;
                    }
                    
                    // åº—èˆ—ä¸€è¦§ã‚’å–å¾—
                    const stores = getStoreList(data);
                    
                    // JANã‚³ãƒ¼ãƒ‰ã”ã¨ã«å•†å“ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                    const productMap = {};
                    data.forEach(function(d) {
                        const jan = d['JAN'] || 'N/A';
                        if (!productMap[jan]) {
                            productMap[jan] = {
                                jan: jan,
                                name: d['å•†å“å'] || '',
                                prices: {}
                            };
                        }
                        const storeKey = d['åº—èˆ—å'];
                        productMap[jan].prices[storeKey] = d['ä¾¡æ ¼'];
                    });
                    
                    console.log('ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸå•†å“æ•°:', Object.keys(productMap).length);
                    console.log('åº—èˆ—æ•°:', stores.length);
                    
                    // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ã‚°å‡ºåŠ›
                    if (Object.keys(productMap).length > 0) {
                        const firstJAN = Object.keys(productMap)[0];
                        console.log('ã‚µãƒ³ãƒ—ãƒ«å•†å“:', {
                            JAN: firstJAN,
                            å•†å“å: productMap[firstJAN].name,
                            åº—èˆ—åˆ¥ä¾¡æ ¼: productMap[firstJAN].prices
                        });
                    }
                    
                    // ãƒ†ãƒ¼ãƒ–ãƒ«HTMLç”Ÿæˆ
                    let html = '<table><thead><tr>';
                    html += '<th>JANã‚³ãƒ¼ãƒ‰</th>';
                    html += '<th>å•†å“å</th>';
                    
                    stores.forEach(function(store) {
                        html += '<th>' + store.åº—èˆ—å + '</th>';
                    });
                    
                    html += '</tr></thead><tbody>';
                    
                    // å•†å“è¡Œã‚’ç”Ÿæˆ
                    Object.keys(productMap).forEach(function(jan) {
                        const product = productMap[jan];
                        html += '<tr>';
                        html += '<td class="jan-code">' + product.jan + '</td>';
                        html += '<td class="product-name" title="' + product.name + '">' + product.name + '</td>';
                        
                        stores.forEach(function(store) {
                            const storeKey = store.åº—èˆ—å;
                            if (product.prices[storeKey]) {
                                html += '<td class="price-cell">' + Math.round(product.prices[storeKey]).toLocaleString() + 'å††</td>';
                            } else {
                                html += '<td class="no-price">-</td>';
                            }
                        });
                        
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    
                    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã«è¡¨ç¤º
                    const modal = document.getElementById('productMatrixModal');
                    const title = document.getElementById('productMatrixTitle');
                    const body = document.getElementById('productMatrixBody');
                    
                    if (!modal || !title || !body) {
                        console.error('å•†å“ãƒãƒˆãƒªã‚¯ã‚¹ç”¨ã®DOMè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        return;
                    }
                    
                    title.textContent = categoryName + ' - ' + pricePoint + 'å††ã€œ' + (pricePoint + priceInterval - 1) + 'å††';
                    body.innerHTML = html;
                    modal.classList.remove('hidden');
                } catch (error) {
                    console.error('å•†å“ãƒãƒˆãƒªã‚¯ã‚¹è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                    alert('å•†å“ãƒãƒˆãƒªã‚¯ã‚¹ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            }
            
            function closeProductMatrix() {
                const modal = document.getElementById('productMatrixModal');
                if (modal) {
                    modal.classList.add('hidden');
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…å®¹ã‚’ã‚¯ãƒªã‚¢
                    const body = document.getElementById('productMatrixBody');
                    if (body) {
                        body.innerHTML = '';
                    }
                }
            }
            
            // å•†å“ãƒãƒˆãƒªã‚¯ã‚¹ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼åˆæœŸåŒ–
            function initializeProductMatrixListeners() {
                const closeBtn = document.getElementById('closeProductMatrixBtn');
                const modal = document.getElementById('productMatrixModal');
                const content = modal ? modal.querySelector('.product-matrix-content') : null;
                
                // åˆæœŸçŠ¶æ…‹ã‚’ç¢ºå®Ÿã«éè¡¨ç¤ºã«ã™ã‚‹
                if (modal) {
                    modal.classList.add('hidden');
                }
                
                // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éƒ¨åˆ†ã®ã‚¯ãƒªãƒƒã‚¯ã¯èƒŒæ™¯ã«ä¼æ’­ã•ã›ãªã„
                if (content) {
                    content.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                }
                
                if (closeBtn) {
                    closeBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        closeProductMatrix();
                    });
                }
                
                if (modal) {
                    modal.addEventListener('click', function(e) {
                        if (e.target.id === 'productMatrixModal') {
                            closeProductMatrix();
                        }
                    });
                }
                
                // Escã‚­ãƒ¼ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' || e.keyCode === 27) {
                        const modal = document.getElementById('productMatrixModal');
                        if (modal && !modal.classList.contains('hidden')) {
                            closeProductMatrix();
                        }
                    }
                });
            }
            
            // ä¾¡æ ¼æˆ¦ç•¥ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–æ™‚ã«ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            initializeProductMatrixListeners();


        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£²ä¸Šåˆ†æãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Hiragino Sans", "Yu Gothic", "Meiryo", "MS PGothic", sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .modal {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .modal-content {
            margin-bottom: 25px;
            line-height: 1.8;
            color: #555;
        }
        
        .library-list {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid #1F5F8B;
        }
        
        .library-list li {
            margin: 8px 0;
            color: #333;
        }
        
        .security-info {
            background: #e8f5e9;
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid #4CAF50;
            font-size: 14px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #1F5F8B;
            color: white;
        }
        
        .btn-primary:hover {
            background: #164563;
        }
        
        .btn-secondary {
            background: #ddd;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #ccc;
        }
        
        .loading-message {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1F5F8B;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #ffebee;
            padding: 20px;
            border-radius: 4px;
            border-left: 4px solid #f44336;
            color: #c62828;
        }
        
        .upload-area {
            border: 3px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #1F5F8B;
            background: #f9f9f9;
        }
        
        .upload-area.dragover {
            border-color: #1F5F8B;
            background: #e3f2fd;
        }
        
        .filters {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
        }
        
        .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .metrics-selector {
            margin-bottom: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .metrics-selector h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }
        
        .metric-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .metric-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .metric-checkbox label {
            cursor: pointer;
            font-size: 13px;
            user-select: none;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .breadcrumb-item {
            color: #1F5F8B;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .breadcrumb-item.current {
            color: #333;
            cursor: default;
            text-decoration: none;
            font-weight: bold;
        }
        
        .drill-all-btn {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .export-table-btn {
            padding: 8px 16px;
            background: #FF9800;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-bottom: 15px;
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .table-unit {
            font-size: 13px;
            color: #666;
            font-weight: bold;
        }
        
        .charts-section {
            margin-bottom: 40px;
        }
        
        .chart-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .chart-card-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        
        .chart-card-controls label {
            font-weight: bold;
            color: #555;
            font-size: 13px;
        }
        
        .chart-card-controls select,
        .chart-card-controls input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .chart-card-controls input[type="number"] {
            width: 80px;
        }
        
        .chart-card-controls input[type="range"] {
            width: 150px;
            vertical-align: middle;
        }
        
        #bubbleScaleValue {
            display: inline-block;
            min-width: 40px;
            font-weight: bold;
            color: #1F5F8B;
        }
        
        .download-chart-button {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-left: auto;
        }
        
        .download-chart-button:hover {
            background: #45a049;
        }
        
        .chart-wrapper {
            position: relative;
            margin-bottom: 20px;
        }
        
        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .mode-btn {
            padding: 10px 20px;
            border: 2px solid #1F5F8B;
            background: white;
            color: #1F5F8B;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .mode-btn.active {
            background: #1F5F8B;
            color: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        th, td {
            padding: 8px;
            text-align: right;
            border: 1px solid #ddd;
        }
        
        th {
            background: #2B5797;
            font-weight: bold;
            color: white;
            position: relative;
        }
        
        tr.total-row {
            background: #e3f2fd;
            font-weight: bold;
        }
        
        tr.total-row td {
            border-top: 2px solid #1F5F8B;
        }
        
        th.sortable {
            cursor: pointer;
            user-select: none;
            padding-right: 25px;
        }
        
        th.sortable:hover {
            background: #3d6ba8;
        }
        
        th .sort-icon {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        th.sort-asc .sort-icon {
            color: white;
        }
        
        th.sort-desc .sort-icon {
            color: white;
        }
        
        th.draggable-header {
            cursor: move;
            user-select: none;
            position: relative;
        }
        
        th.draggable-header:hover {
            background: #3d6ba8;
        }
        
        th.draggable-header::before {
            content: 'â‹®â‹®';
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.6);
            font-size: 16px;
        }
        
        th.dragging {
            opacity: 0.5;
            background: #1e3d5f;
        }
        
        th.drag-over {
            border-left: 3px solid #4CAF50;
        }
        
        td.name-column {
            text-align: left;
            padding-left: 30px;
        }
        
        .drill-btn {
            padding: 4px 8px;
            background: #1F5F8B;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            margin-right: 5px;
        }
        
        .databar-cell {
            position: relative;
            padding: 8px;
            text-align: right;
        }
        
        .hidden {
            display: none;
        }
        
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1F5F8B 0%, #2C7FB8 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            animation: fadeOut 0.5s ease-out 2s forwards;
        }
        
        @keyframes fadeOut {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }
        
        .splash-content {
            text-align: center;
        }
        
        .splash-title {
            color: white;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 40px;
            opacity: 0;
            animation: fadeInUp 0.6s ease-out 0.2s forwards;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chart-animation {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 8px;
            height: 120px;
            margin-bottom: 30px;
        }
        
        .bar {
            width: 20px;
            background: white;
            border-radius: 3px 3px 0 0;
            opacity: 0.9;
            animation: growBar 0.8s ease-out forwards;
        }
        
        .bar:nth-child(1) {
            height: 60px;
            animation-delay: 0.3s;
        }
        
        .bar:nth-child(2) {
            height: 90px;
            animation-delay: 0.4s;
        }
        
        .bar:nth-child(3) {
            height: 45px;
            animation-delay: 0.5s;
        }
        
        .bar:nth-child(4) {
            height: 75px;
            animation-delay: 0.6s;
        }
        
        .bar:nth-child(5) {
            height: 100px;
            animation-delay: 0.7s;
        }
        
        .bar:nth-child(6) {
            height: 55px;
            animation-delay: 0.8s;
        }
        
        @keyframes growBar {
            from {
                transform: scaleY(0);
                opacity: 0;
            }
            to {
                transform: scaleY(1);
                opacity: 0.9;
            }
        }
        
        .loading-text {
            color: white;
            font-size: 14px;
            opacity: 0;
            animation: fadeIn 0.5s ease-out 1.5s forwards;
        }
        
        @keyframes fadeIn {
            to {
                opacity: 0.8;
            }
        }
        
        /* ã‚¯ãƒ­ã‚¹åˆ†æç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .cross-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            align-items: center;
        }
        
        .cross-metric-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            align-items: center;
        }
        
        .cross-metric-selector label {
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }
        
        .cross-metric-selector select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .cross-table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        .cross-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            font-weight: 600;
        }
        
        .cross-table th,
        .cross-table td {
            padding: 8px;
            border: 1px solid #ddd;
        }
        
        .cross-table th {
            background: #2B5797;
            color: white;
            font-weight: bold;
            text-align: center;
        }
        
        .cross-table td {
            text-align: right;
        }
        
        .cross-table td.category-cell {
            text-align: left;
            padding-left: 30px;
            font-weight: 600;
        }
        
        .cross-table .databar-sales-ratio {
            background: linear-gradient(to right, rgba(135, 179, 226, 0.5) 0%, rgba(135, 179, 226, 0.5) var(--percentage), transparent var(--percentage));
        }
        
        .yoy-positive {
            color: #0070C0;
            font-weight: bold;
        }
        
        .yoy-negative {
            color: #C00000;
            font-weight: bold;
        }
        
        .cross-chart-container {
            margin-bottom: 30px;
        }
        
        .cross-chart-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="splashScreen" class="splash-screen">
        <div class="splash-content">
            <div class="splash-title">å£²ä¸Šåˆ†æãƒ„ãƒ¼ãƒ«</div>
            <div class="chart-animation">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
            <div class="loading-text">Loading...</div>
        </div>
    </div>
    
    <div id="confirmModal" class="modal-overlay hidden">
        <div class="modal">
            <h2>ğŸ”’ å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ç¢ºèª</h2>
            <div class="modal-content">
                <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®JavaScriptãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å¤–éƒ¨ã‹ã‚‰èª­ã¿è¾¼ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™:</p>
                
                <div class="library-list">
                    <ul>
                        <li><strong>XLSX.js (v0.18.5)</strong> - Excelãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ç”¨</li>
                        <li><strong>Chart.js (v3.9.1)</strong> - ã‚°ãƒ©ãƒ•è¡¨ç¤ºç”¨</li>
                        <li><strong>html2canvas (v1.4.1)</strong> - ç”»åƒå‡ºåŠ›ç”¨</li>
                    </ul>
                </div>
                
                <div class="security-info">
                    <strong>âœ“ æ¥ç¶šæƒ…å ±:</strong><br>
                    ãƒ»æ¥ç¶šå…ˆ: https://cdnjs.cloudflare.com (Cloudflareå…¬å¼CDN)<br>
                    ãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“<br>
                    ãƒ»ã™ã¹ã¦ã®å‡¦ç†ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å®Œçµã—ã¾ã™
                </div>
                
                <p style="color: #666; font-size: 13px; margin-top: 15px;">
                    â€»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯æ¯å›ã®ãƒ„ãƒ¼ãƒ«èµ·å‹•æ™‚ã«èª­ã¿è¾¼ã¾ã‚Œã€ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§ã®ã¿å‹•ä½œã—ã¾ã™ã€‚<br>
                    â€»æœ¬ãƒ„ãƒ¼ãƒ«å†…ã§åˆ©ç”¨ã•ã‚Œã‚‹CDN(Content Delivery Network)çµŒç”±ã§æä¾›ã•ã‚Œã‚‹å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¤ã„ã¦ã¯ã€ãã®å®‰å…¨æ€§ã€å¯ç”¨æ€§ã€æ­£ç¢ºæ€§ã€ãŠã‚ˆã³ãƒ„ãƒ¼ãƒ«ã®æ©Ÿèƒ½ã«ä¸ãˆã‚‹å½±éŸ¿ã‚’å«ã‚ã€ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚
                </p>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" id="approveBtn">è¨˜è¼‰äº‹é …ã«åŒæ„ã—ã¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚€</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <h1>å£²ä¸Šåˆ†æãƒ„ãƒ¼ãƒ«</h1>
        
        <div id="loadingMessage" class="loading-message hidden">
            <div class="loading-spinner"></div>
            <p>ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
        </div>
        
        <div id="errorMessage" class="error-message hidden"></div>
        
        <div id="mainApp" class="hidden">
            <div class="upload-area" id="uploadArea">
                <p>Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none;">
            </div>
            
            <div id="mainContent" class="hidden">
                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="standard">æ¨™æº–åˆ†æãƒ¢ãƒ¼ãƒ‰</button>
                    <button class="mode-btn" data-mode="cross">ã‚¯ãƒ­ã‚¹åˆ†æãƒ¢ãƒ¼ãƒ‰</button>
                </div>
                
                <!-- æ¨™æº–åˆ†æãƒ¢ãƒ¼ãƒ‰ -->
                <div id="standardMode">
                    <div class="filters">
                        <div class="filter-group">
                            <label>å•†å“åˆ†é¡</label>
                            <select id="filterClassification">
                                <option value="suc">SuCå•†å“åˆ†é¡</option>
                                <option value="smart" selected>SMARTå•†å“åˆ†é¡</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>ã‚¿ã‚¤ãƒ—åˆ†é¡</label>
                            <select id="filterType" multiple size="4"></select>
                        </div>
                    </div>
                    
                    <div class="metrics-selector">
                        <h3>è¡¨ç¤ºæŒ‡æ¨™ã®é¸æŠ(ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§åˆ—ã®ä¸¦ã¹æ›¿ãˆãŒå¯èƒ½)</h3>
                        <div class="metrics-grid" id="metricsGrid"></div>
                    </div>
                    
                    <div class="breadcrumb" id="breadcrumb"></div>
                    
                    <button class="drill-all-btn hidden" id="drillAllBtn">å…¨ä½“ã‚’ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³</button>
                    
                    <button class="export-table-btn" id="exportTableBtn">è¡¨ã‚’ç”»åƒã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    <div class="table-container" id="tableContainer"></div>
                    
                    <!-- ã‚°ãƒ©ãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="charts-section" id="chartsSection">
                        <!-- ãƒãƒ–ãƒ«ãƒãƒ£ãƒ¼ãƒˆ -->
                        <div class="chart-card">
                            <h3>å¤šæ¬¡å…ƒåˆ†æ(ãƒãƒ–ãƒ«ãƒãƒ£ãƒ¼ãƒˆ)</h3>
                            <div class="chart-card-controls">
                                <label>æ¨ªè»¸:</label>
                                <select id="bubbleXAxis">
                                    <option value="sales" selected>å£²ä¸Šé«˜</option>
                                    <option value="sales_ratio">å£²ä¸Šæ§‹æˆæ¯”</option>
                                    <option value="last_sales">æ˜¨å¹´å£²ä¸Šé«˜</option>
                                    <option value="target_ratio">å£²ä¸Šç›®æ¨™æ¯”</option>
                                    <option value="yoy_ratio">å£²ä¸Šå‰å¹´æ¯”</option>
                                    <option value="profit">è’åˆ©é«˜</option>
                                    <option value="profit_yoy">è’åˆ©å‰å¹´æ¯”</option>
                                    <option value="margin">è’åˆ©ç‡</option>
                                    <option value="last_margin">æ˜¨å¹´è’åˆ©ç‡</option>
                                    <option value="cross_ratio">ç›¸ä¹—ç©</option>
                                </select>
                                
                                <label>ç¸¦è»¸:</label>
                                <select id="bubbleYAxis">
                                    <option value="sales">å£²ä¸Šé«˜</option>
                                    <option value="sales_ratio">å£²ä¸Šæ§‹æˆæ¯”</option>
                                    <option value="last_sales">æ˜¨å¹´å£²ä¸Šé«˜</option>
                                    <option value="target_ratio">å£²ä¸Šç›®æ¨™æ¯”</option>
                                    <option value="yoy_ratio">å£²ä¸Šå‰å¹´æ¯”</option>
                                    <option value="profit">è’åˆ©é«˜</option>
                                    <option value="profit_yoy">è’åˆ©å‰å¹´æ¯”</option>
                                    <option value="margin" selected>è’åˆ©ç‡</option>
                                    <option value="last_margin">æ˜¨å¹´è’åˆ©ç‡</option>
                                    <option value="cross_ratio">ç›¸ä¹—ç©</option>
                                </select>
                                
                                <label>ãƒãƒ–ãƒ«ã‚µã‚¤ã‚º:</label>
                                <select id="bubbleSize">
                                    <option value="none">æŒ‡å®šãªã—(å›ºå®š)</option>
                                    <option value="sales">å£²ä¸Šé«˜</option>
                                    <option value="sales_ratio">å£²ä¸Šæ§‹æˆæ¯”</option>
                                    <option value="yoy_ratio" selected>å£²ä¸Šå‰å¹´æ¯”</option>
                                    <option value="profit">è’åˆ©é«˜</option>
                                    <option value="profit_yoy">è’åˆ©å‰å¹´æ¯”</option>
                                    <option value="margin">è’åˆ©ç‡</option>
                                </select>
                                
                                <label>ãƒãƒ–ãƒ«å€ç‡:</label>
                                <input type="range" id="bubbleScale" min="0.1" max="5" step="0.1" value="0.5">
                                <span id="bubbleScaleValue">0.5x</span>
                            </div>
                            <div class="chart-card-controls">
                                <label>ã‚°ãƒ©ãƒ•ç”»åƒã®ç¸¦æ¨ªæ¯”:</label>
                                <select id="bubbleChartAspectPreset">
                                    <option value="16:9" selected>16:9 (æ¨ªé•·)</option>
                                    <option value="4:3">4:3 (æ¨™æº–)</option>
                                    <option value="1:1">1:1 (æ­£æ–¹å½¢)</option>
                                    <option value="3:4">3:4 (ç¸¦é•·)</option>
                                    <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
                                </select>
                                <span id="bubbleChartCustomAspect" style="display:none;">
                                    <label>å¹…:</label>
                                    <input type="number" id="bubbleChartAspectWidth" value="16" min="1">
                                    <label>é«˜ã•:</label>
                                    <input type="number" id="bubbleChartAspectHeight" value="9" min="1">
                                </span>
                                <button class="download-chart-button" id="downloadBubbleChart">ã‚°ãƒ©ãƒ•ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                            </div>
                            <div class="chart-wrapper" style="height: 600px;">
                                <canvas id="bubbleChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ã‚¯ãƒ­ã‚¹åˆ†æãƒ¢ãƒ¼ãƒ‰ -->
                <div id="crossMode" class="hidden">
                    <div class="cross-filters">
                        <div class="filter-group">
                            <label>å•†å“åˆ†é¡</label>
                            <select id="crossFilterClassification">
                                <option value="suc">SuCå•†å“åˆ†é¡</option>
                                <option value="smart" selected>SMARTå•†å“åˆ†é¡</option>
                            </select>
                        </div>
                    </div>
                    

                    
                    <div class="breadcrumb" id="crossBreadcrumb"></div>
                    
                    <button class="drill-all-btn hidden" id="crossDrillAllBtn">å…¨ä½“ã‚’ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³</button>
                    
                    <button class="export-table-btn" id="exportCrossTableBtn">è¡¨ã‚’ç”»åƒã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    <div class="cross-table-container" id="crossTableContainer"></div>
                    
                    <!-- 100%ç©ã¿ä¸Šã’æ¨ªæ£’ã‚°ãƒ©ãƒ• -->
                    <div class="cross-chart-container">
                        <h3 style="margin-bottom: 15px;">å£²ä¸Šæ§‹æˆæ¯”(100%ç©ã¿ä¸Šã’æ¨ªæ£’ã‚°ãƒ©ãƒ•)</h3>
                        <div class="cross-chart-controls">
                            <label>ã‚°ãƒ©ãƒ•ç”»åƒã®ç¸¦æ¨ªæ¯”:</label>
                            <select id="crossChartAspectPreset">
                                <option value="16:9" selected>16:9 (æ¨ªé•·)</option>
                                <option value="4:3">4:3 (æ¨™æº–)</option>
                                <option value="1:1">1:1 (æ­£æ–¹å½¢)</option>
                                <option value="3:4">3:4 (ç¸¦é•·)</option>
                                <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
                            </select>
                            <span id="crossChartCustomAspect" style="display:none;">
                                <label>å¹…:</label>
                                <input type="number" id="crossChartAspectWidth" value="16" min="1">
                                <label>é«˜ã•:</label>
                                <input type="number" id="crossChartAspectHeight" value="9" min="1">
                            </span>
                            <button class="download-chart-button" id="downloadCrossChart">ã‚°ãƒ©ãƒ•ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                        </div>
                        <div class="chart-wrapper" style="height: 600px;">
                            <canvas id="crossChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('splashScreen').style.display = 'none';
                document.getElementById('confirmModal').classList.remove('hidden');
            }, 2500);
        });
        
        const libraries = [
            {
                name: 'XLSX',
                url: 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
                check: () => typeof XLSX !== 'undefined'
            },
            {
                name: 'Chart.js',
                url: 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js',
                check: () => typeof Chart !== 'undefined'
            },
            {
                name: 'html2canvas',
                url: 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
                check: () => typeof html2canvas !== 'undefined'
            }
        ];
        
        let librariesLoaded = false;
        
        document.getElementById('approveBtn').addEventListener('click', loadLibraries);
        document.getElementById('cancelBtn').addEventListener('click', handleCancel);
        
        function loadLibraries() {
            document.getElementById('confirmModal').classList.add('hidden');
            document.getElementById('loadingMessage').classList.remove('hidden');
            
            const promises = libraries.map(lib => loadScript(lib));
            
            Promise.all(promises)
                .then(() => {
                    librariesLoaded = true;
                    document.getElementById('loadingMessage').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    initializeApp();
                })
                .catch(error => {
                    document.getElementById('loadingMessage').classList.add('hidden');
                    const errorMsg = document.getElementById('errorMessage');
                    errorMsg.textContent = `ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
                    errorMsg.classList.remove('hidden');
                });
        }
        
        function loadScript(lib) {
            return new Promise((resolve, reject) => {
                if (lib.check()) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = lib.url;
                
                script.onload = () => {
                    if (lib.check()) {
                        console.log(`âœ“ ${lib.name} loaded successfully`);
                        resolve();
                    } else {
                        reject(new Error(`${lib.name} failed to initialize`));
                    }
                };
                
                script.onerror = () => {
                    reject(new Error(`${lib.name} failed to load from CDN`));
                };
                
                document.head.appendChild(script);
            });
        }
        
        function handleCancel() {
            document.getElementById('confirmModal').classList.add('hidden');
            const errorMsg = document.getElementById('errorMessage');
            errorMsg.innerHTML = `
                <strong>ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ</strong><br>
                ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã‚’æ‰¿èªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br>
                ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã€å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚
            `;
            errorMsg.classList.remove('hidden');
        }
        
        function initializeApp() {
            let rawData = [];
            let filteredData = [];
            let currentHierarchy = [];
            let currentClassification = 'smart';
            let sortState = {column: null, direction: null};
            let currentMode = 'standard';
            
            // ã‚¯ãƒ­ã‚¹åˆ†æç”¨ã®çŠ¶æ…‹
            let crossHierarchy = [];
            let crossClassification = 'smart';
            let crossSortState = {column: null, direction: null};
            let typeOrder = [];
            let crossAggregatedData = []; // ã‚½ãƒ¼ãƒˆæ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
            
            // ã‚°ãƒ©ãƒ•ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            let bubbleChart = null;
            let crossChart = null;
            
            const allMetrics = [
                {id: 'sales_target', name: 'å£²ä¸Šé«˜ç›®æ¨™', visible: true},
                {id: 'sales', name: 'å£²ä¸Šé«˜', visible: true},
                {id: 'sales_ratio', name: 'å£²ä¸Šæ§‹æˆæ¯”', visible: true, databar: true},
                {id: 'last_sales', name: 'æ˜¨å¹´å£²ä¸Šé«˜', visible: true},
                {id: 'last_sales_ratio', name: 'æ˜¨å¹´å£²ä¸Šæ§‹æˆæ¯”', visible: true, databar: true},
                {id: 'target_ratio', name: 'å£²ä¸Šç›®æ¨™æ¯”', visible: true},
                {id: 'yoy_ratio', name: 'å£²ä¸Šå‰å¹´æ¯”', visible: true},
                {id: 'market_yoy', name: 'å¸‚å ´å‰å¹´æ¯”', visible: true},
                {id: 'profit_target', name: 'è’åˆ©é«˜ç›®æ¨™', visible: true},
                {id: 'profit', name: 'è’åˆ©é«˜', visible: true},
                {id: 'last_profit', name: 'æ˜¨å¹´è’åˆ©é«˜', visible: true},
                {id: 'profit_yoy', name: 'è’åˆ©å‰å¹´æ¯”', visible: true},
                {id: 'margin_target', name: 'è’åˆ©ç‡ç›®æ¨™', visible: true},
                {id: 'margin', name: 'è’åˆ©ç‡', visible: true},
                {id: 'last_margin', name: 'æ˜¨å¹´è’åˆ©ç‡', visible: true},
                {id: 'cross_ratio', name: 'ç›¸ä¹—ç©', visible: true},
                {id: 'last_cross_ratio', name: 'æ˜¨å¹´ç›¸ä¹—ç©', visible: true}
            ];
            
            const hierarchyLevels = {
                suc: ['ãƒ‡ã‚£ãƒ“ã‚¸ãƒ§ãƒ³å', 'ãƒ©ã‚¤ãƒ³å', 'éƒ¨é–€å', 'ã‚«ãƒ†ã‚´ãƒªãƒ¼å', 'ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼å', 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå', 'ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå'],
                smart: ['SMART-ãƒ‡ã‚£ãƒ“ã‚¸ãƒ§ãƒ³', 'SMART-ãƒ©ã‚¤ãƒ³', 'SMART-éƒ¨é–€', 'SMART-ã‚«ãƒ†ã‚´ãƒªãƒ¼', 'SMART-ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼', 'SMART-ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ', 'SMART-ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ']
            };
            
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFile(e.dataTransfer.files[0]);
            });
            fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
            
            // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentMode = btn.dataset.mode;
                    
                    if (currentMode === 'standard') {
                        document.getElementById('standardMode').classList.remove('hidden');
                        document.getElementById('crossMode').classList.add('hidden');
                    } else {
                        document.getElementById('standardMode').classList.add('hidden');
                        document.getElementById('crossMode').classList.remove('hidden');
                        updateCrossView();
                    }
                });
            });
            
            function handleFile(file) {
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        rawData = jsonData;
                        initializeData();
                    } catch (error) {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
            
            function initializeData() {
                document.getElementById('mainContent').classList.remove('hidden');
                populateFilters();
                populateMetricsSelector();
                applyFilters();
                updateView();
            }
            
            function populateFilters() {
                const types = [...new Set(rawData.map(d => d['ã‚¿ã‚¤ãƒ—åˆ†é¡å']))].sort();
                const typeSelect = document.getElementById('filterType');
                typeSelect.innerHTML = types.map(t => {
                    const isSelected = t === 'SMART' ? 'selected' : '';
                    return `<option value="${t}" ${isSelected}>${t}</option>`;
                }).join('');
                
                typeSelect.addEventListener('change', () => {
                    applyFilters();
                    currentHierarchy = [];
                    updateView();
                });
                
                document.getElementById('filterClassification').addEventListener('change', (e) => {
                    currentClassification = e.target.value;
                    currentHierarchy = [];
                    applyFilters();
                    updateView();
                });
                
                // ã‚¯ãƒ­ã‚¹åˆ†æç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                document.getElementById('crossFilterClassification').addEventListener('change', (e) => {
                    crossClassification = e.target.value;
                    crossHierarchy = [];
                    updateCrossView();
                });
            }
            
            function populateMetricsSelector() {
                const grid = document.getElementById('metricsGrid');
                grid.innerHTML = allMetrics.map(metric => `
                    <div class="metric-checkbox">
                        <input type="checkbox" id="metric_${metric.id}" ${metric.visible ? 'checked' : ''} 
                               onchange="toggleMetric('${metric.id}')">
                        <label for="metric_${metric.id}">${metric.name}</label>
                    </div>
                `).join('');
            }
            
            window.toggleMetric = function(metricId) {
                const metric = allMetrics.find(m => m.id === metricId);
                if (metric) {
                    metric.visible = !metric.visible;
                    updateView();
                }
            };
            
            function applyFilters() {
                const selectedTypes = Array.from(document.getElementById('filterType').selectedOptions).map(opt => opt.value);
                filteredData = rawData.filter(row => selectedTypes.includes(row['ã‚¿ã‚¤ãƒ—åˆ†é¡å']));
            }
            
            function getCurrentData() {
                let data = filteredData;
                const levels = hierarchyLevels[currentClassification];
                
                currentHierarchy.forEach((value, index) => {
                    if (value !== '*ALL*') {
                        const level = levels[index];
                        data = data.filter(row => row[level] === value);
                    }
                });
                
                return data;
            }
            
            function updateView() {
                if (currentMode === 'standard') {
                    updateBreadcrumb();
                    
                    const currentLevel = currentHierarchy.length;
                    const levels = hierarchyLevels[currentClassification];
                    
                    if (currentLevel < 6) {
                        document.getElementById('drillAllBtn').classList.remove('hidden');
                    } else {
                        document.getElementById('drillAllBtn').classList.add('hidden');
                    }
                    
                    updateTable();
                    updateCharts();
                }
            }
            
            function updateBreadcrumb() {
                const breadcrumb = document.getElementById('breadcrumb');
                let html = '<span class="breadcrumb-item" data-level="-1">ãƒˆãƒƒãƒ—</span>';
                
                currentHierarchy.forEach((item, index) => {
                    const displayText = item === '*ALL*' ? 'å…¨ä½“' : item;
                    html += ' > <span class="breadcrumb-item' + 
                            (index === currentHierarchy.length - 1 ? ' current' : '') + 
                            '" data-level="' + index + '">' + displayText + '</span>';
                });
                
                breadcrumb.innerHTML = html;
                
                breadcrumb.querySelectorAll('.breadcrumb-item:not(.current)').forEach(item => {
                    item.addEventListener('click', () => {
                        const level = parseInt(item.dataset.level);
                        currentHierarchy = currentHierarchy.slice(0, level + 1);
                        sortState = {column: null, direction: null};
                        updateView();
                    });
                });
            }
            
            function calculateMetrics(data) {
                const levels = hierarchyLevels[currentClassification];
                const currentLevel = currentHierarchy.length;
                
                if (currentLevel >= 7) {
                    return [];
                }
                
                const nextLevel = levels[currentLevel];
                
                // éšå±¤5ãƒ»6ã§ã¯ä¸Šä½éšå±¤ã¨ã®çµ„ã¿åˆã‚ã›ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–
                let items;
                if (currentLevel === 5) {
                    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆéšå±¤ï¼šã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ + ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®çµ„ã¿åˆã‚ã›ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–
                    const combinations = data.map(d => ({
                        subCategory: d[levels[4]],
                        segment: d[nextLevel]
                    }));
                    const uniqueCombos = Array.from(
                        new Map(combinations.map(c => [`${c.subCategory}|||${c.segment}`, c])).values()
                    );
                    items = uniqueCombos.sort((a, b) => {
                        if (a.subCategory !== b.subCategory) {
                            return a.subCategory.localeCompare(b.subCategory, 'ja');
                        }
                        return a.segment.localeCompare(b.segment, 'ja');
                    });
                } else if (currentLevel === 6) {
                    // ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆéšå±¤ï¼šã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ + ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ + ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®çµ„ã¿åˆã‚ã›
                    const combinations = data.map(d => ({
                        subCategory: d[levels[4]],
                        segment: d[levels[5]],
                        subsegment: d[nextLevel]
                    }));
                    const uniqueCombos = Array.from(
                        new Map(combinations.map(c => [`${c.subCategory}|||${c.segment}|||${c.subsegment}`, c])).values()
                    );
                    items = uniqueCombos.sort((a, b) => {
                        if (a.subCategory !== b.subCategory) {
                            return a.subCategory.localeCompare(b.subCategory, 'ja');
                        }
                        if (a.segment !== b.segment) {
                            return a.segment.localeCompare(b.segment, 'ja');
                        }
                        return a.subsegment.localeCompare(b.subsegment, 'ja');
                    });
                } else {
                    // é€šå¸¸ã®éšå±¤ï¼šåå‰ã®ã¿ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–
                    items = [...new Set(data.map(d => d[nextLevel]))].filter(x => x).sort();
                }
                
                // å…¨ä½“ã®åˆè¨ˆã‚’è¨ˆç®—
                const totalSales = data.reduce((sum, d) => sum + (d['å£²ä¸Šé«˜ç¨æŠœ(åƒå††)'] || 0), 0);
                const totalLastSales = data.reduce((sum, d) => sum + (d['æ˜¨å¹´å£²ä¸Šé«˜ç¨æŠœ(åƒå††)'] || 0), 0);
                
                const aggregatedData = items.map(item => {
                    let itemData;
                    let name;
                    let hierarchyInfo = {};
                    
                    if (currentLevel === 5) {
                        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆéšå±¤
                        itemData = data.filter(d => 
                            d[levels[4]] === item.subCategory && 
                            d[nextLevel] === item.segment
                        );
                        name = item.segment;
                        hierarchyInfo.subCategory = item.subCategory;
                    } else if (currentLevel === 6) {
                        // ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆéšå±¤
                        itemData = data.filter(d => 
                            d[levels[4]] === item.subCategory && 
                            d[levels[5]] === item.segment && 
                            d[nextLevel] === item.subsegment
                        );
                        name = item.subsegment;
                        hierarchyInfo.subCategory = item.subCategory;
                        hierarchyInfo.segment = item.segment;
                    } else {
                        // é€šå¸¸ã®éšå±¤
                        itemData = data.filter(d => d[nextLevel] === item);
                        name = item;
                        
                        // ä¸Šä½éšå±¤ã®æƒ…å ±ã‚’å–å¾—ï¼ˆæœ€åˆã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼‰
                        if (itemData.length > 0) {
                            const firstItem = itemData[0];
                            // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ä»¥é™ã®å ´åˆã€ä¸Šä½éšå±¤ã®æƒ…å ±ã‚’ä¿å­˜
                            if (currentLevel >= 4) {
                                hierarchyInfo.subCategory = firstItem[levels[4]] || '';
                            }
                            if (currentLevel >= 5) {
                                hierarchyInfo.segment = firstItem[levels[5]] || '';
                            }
                        }
                    }
                    
                    const sales_target = itemData.reduce((sum, d) => sum + (d['å£²ä¸Šé«˜ç›®æ¨™(åƒå††)'] || 0), 0);
                    const sales = itemData.reduce((sum, d) => sum + (d['å£²ä¸Šé«˜ç¨æŠœ(åƒå††)'] || 0), 0);
                    const last_sales = itemData.reduce((sum, d) => sum + (d['æ˜¨å¹´å£²ä¸Šé«˜ç¨æŠœ(åƒå††)'] || 0), 0);
                    const profit_target = itemData.reduce((sum, d) => sum + (d['è²©å£²è’åˆ©é«˜ç›®æ¨™(åƒå††)'] || 0), 0);
                    const profit = itemData.reduce((sum, d) => sum + (d['è²©å£²è’åˆ©é«˜(åƒå††)'] || 0), 0);
                    const last_profit = itemData.reduce((sum, d) => sum + (d['æ˜¨å¹´è²©å£²è’åˆ©é«˜(åƒå††)'] || 0), 0);
                    const ksp_market = itemData.reduce((sum, d) => sum + (d['KSPå¸‚å ´å£²ä¸Šé‡‘é¡'] || 0), 0);
                    const last_ksp_market = itemData.reduce((sum, d) => sum + (d['æ˜¨å¹´KSPå¸‚å ´å£²ä¸Šé‡‘é¡'] || 0), 0);
                    
                    const sales_ratio = totalSales > 0 ? (sales / totalSales) * 100 : 0;
                    const last_sales_ratio = totalLastSales > 0 ? (last_sales / totalLastSales) * 100 : 0;
                    const target_ratio = sales_target > 0 ? (sales / sales_target) * 100 : 0;
                    const yoy_ratio = last_sales > 0 ? (sales / last_sales) * 100 : 0;
                    const market_yoy = last_ksp_market > 0 ? (ksp_market / last_ksp_market) * 100 : 0;
                    const profit_yoy = last_profit > 0 ? (profit / last_profit) * 100 : 0;
                    const margin_target = sales_target > 0 ? (profit_target / sales_target) * 100 : 0;
                    const margin = sales > 0 ? (profit / sales) * 100 : 0;
                    const last_margin = last_sales > 0 ? (last_profit / last_sales) * 100 : 0;
                    const cross_ratio = sales_ratio * margin / 100;
                    const last_cross_ratio = last_sales_ratio * last_margin / 100;
                    
                    return {
                        name: name,
                        hierarchyInfo,
                        sales_target,
                        sales,
                        sales_ratio,
                        last_sales,
                        last_sales_ratio,
                        target_ratio,
                        yoy_ratio,
                        market_yoy,
                        profit_target,
                        profit,
                        last_profit,
                        profit_yoy,
                        margin_target,
                        margin,
                        last_margin,
                        cross_ratio,
                        last_cross_ratio
                    };
                });
                
                return aggregatedData;
            }
            
            function updateTable() {
                const data = getCurrentData();
                const aggregatedData = calculateMetrics(data);
                const currentLevel = currentHierarchy.length;
                
                if (sortState.column) {
                    aggregatedData.sort((a, b) => {
                        let aVal, bVal;
                        
                        // éšå±¤æƒ…å ±ã®åˆ—ã«å¯¾ã™ã‚‹ã‚½ãƒ¼ãƒˆå‡¦ç†
                        if (sortState.column === 'subCategory') {
                            aVal = a.hierarchyInfo.subCategory || '';
                            bVal = b.hierarchyInfo.subCategory || '';
                        } else if (sortState.column === 'segment') {
                            aVal = a.hierarchyInfo.segment || '';
                            bVal = b.hierarchyInfo.segment || '';
                        } else {
                            aVal = a[sortState.column];
                            bVal = b[sortState.column];
                        }
                        
                        if (sortState.column === 'name' || sortState.column === 'subCategory' || sortState.column === 'segment') {
                            return sortState.direction === 'asc' 
                                ? aVal.localeCompare(bVal, 'ja')
                                : bVal.localeCompare(aVal, 'ja');
                        } else {
                            return sortState.direction === 'asc' ? aVal - bVal : bVal - aVal;
                        }
                    });
                }
                
                renderTable(aggregatedData, currentLevel);
            }
            
            function renderTable(data, currentLevel) {
                const levels = hierarchyLevels[currentClassification];
                const nextLevel = levels[currentLevel];
                const visibleMetrics = allMetrics.filter(m => m.visible);
                
                // åˆè¨ˆè¡Œã®è¨ˆç®—
                const totals = {};
                visibleMetrics.forEach(metric => {
                    if (!metric.id.includes('ratio') && !metric.id.includes('margin') && !metric.id.includes('yoy') && !metric.id.includes('cross')) {
                        totals[metric.id] = data.reduce((sum, item) => sum + (item[metric.id] || 0), 0);
                    }
                });
                
                // åˆè¨ˆè¡Œã®å£²ä¸Šæ§‹æˆæ¯”ã¨ç›¸ä¹—ç©ã‚’è¨ˆç®—
                const totalSales = data.reduce((sum, item) => sum + (item.sales || 0), 0);
                const totalLastSales = data.reduce((sum, item) => sum + (item.last_sales || 0), 0);
                const totalProfit = data.reduce((sum, item) => sum + (item.profit || 0), 0);
                const totalLastProfit = data.reduce((sum, item) => sum + (item.last_profit || 0), 0);
                
                totals.sales_ratio = 100; // åˆè¨ˆã¯å¸¸ã«100%
                totals.last_sales_ratio = 100;
                totals.target_ratio = totals.sales_target > 0 ? (totals.sales / totals.sales_target) * 100 : 0;
                totals.yoy_ratio = totals.last_sales > 0 ? (totals.sales / totals.last_sales) * 100 : 0;
                totals.market_yoy = 0; // å¸‚å ´å‰å¹´æ¯”ã¯åˆè¨ˆã§ããªã„
                totals.profit_yoy = totals.last_profit > 0 ? (totals.profit / totals.last_profit) * 100 : 0;
                totals.margin_target = totals.sales_target > 0 ? (totals.profit_target / totals.sales_target) * 100 : 0;
                totals.margin = totalSales > 0 ? (totalProfit / totalSales) * 100 : 0;
                totals.last_margin = totalLastSales > 0 ? (totalLastProfit / totalLastSales) * 100 : 0;
                totals.cross_ratio = totals.sales_ratio * totals.margin / 100;
                totals.last_cross_ratio = totals.last_sales_ratio * totals.last_margin / 100;
                
                let html = '<div class="table-header">';
                html += '<div></div>';
                html += '<div class="table-unit">å£²ä¸Šé«˜ãƒ»è’åˆ©é«˜(åƒå††)</div>';
                html += '</div>';
                html += '<table><thead><tr>';
                
                // éšå±¤ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ãƒ˜ãƒƒãƒ€ãƒ¼åˆ—ã‚’è¿½åŠ 
                if (currentLevel === 5) {
                    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆéšå±¤:ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼å + ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå
                    html += `<th class="sortable" data-column="subCategory">${levels[4]}${getSortIcon('subCategory')}</th>`;
                    html += `<th class="sortable" data-column="name">${nextLevel}${getSortIcon('name')}</th>`;
                } else if (currentLevel === 6) {
                    // ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆéšå±¤:ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼å + ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå + ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå
                    html += `<th class="sortable" data-column="subCategory">${levels[4]}${getSortIcon('subCategory')}</th>`;
                    html += `<th class="sortable" data-column="segment">${levels[5]}${getSortIcon('segment')}</th>`;
                    html += `<th class="sortable" data-column="name">${nextLevel}${getSortIcon('name')}</th>`;
                } else {
                    // ãã‚Œä»¥å¤–:é€šå¸¸ã®1åˆ—è¡¨ç¤º
                    html += `<th class="sortable" data-column="name">${nextLevel}${getSortIcon('name')}</th>`;
                }
                
                visibleMetrics.forEach(metric => {
                    html += `<th class="sortable draggable-header" draggable="true" data-column="${metric.id}" data-metric-id="${metric.id}">
                        ${metric.name}${getSortIcon(metric.id)}
                    </th>`;
                });
                
                html += '</tr></thead><tbody>';
                
                data.forEach(item => {
                    html += '<tr>';
                    
                    // éšå±¤ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦åå‰åˆ—ã‚’åˆ†ã‘ã¦è¡¨ç¤º
                    if (currentLevel === 5) {
                        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆéšå±¤:ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ååˆ— + ã‚»ã‚°ãƒ¡ãƒ³ãƒˆååˆ—
                        html += `<td class="name-column">${item.hierarchyInfo.subCategory || ''}</td>`;
                        if (currentLevel < 6) {
                            html += `<td class="name-column">
                                <button class="drill-btn" data-item="${item.name}">â–¼</button>
                                ${item.name}
                            </td>`;
                        } else {
                            html += `<td class="name-column">${item.name}</td>`;
                        }
                    } else if (currentLevel === 6) {
                        // ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆéšå±¤:ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ååˆ— + ã‚»ã‚°ãƒ¡ãƒ³ãƒˆååˆ— + ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆååˆ—
                        html += `<td class="name-column">${item.hierarchyInfo.subCategory || ''}</td>`;
                        html += `<td class="name-column">${item.hierarchyInfo.segment || ''}</td>`;
                        html += `<td class="name-column">${item.name}</td>`;
                    } else {
                        // ãã‚Œä»¥å¤–:é€šå¸¸ã®1åˆ—è¡¨ç¤º
                        if (currentLevel < 6) {
                            html += `<td class="name-column">
                                <button class="drill-btn" data-item="${item.name}">â–¼</button>
                                ${item.name}
                            </td>`;
                        } else {
                            html += `<td class="name-column">${item.name}</td>`;
                        }
                    }
                    
                    visibleMetrics.forEach(metric => {
                        const value = item[metric.id];
                        let formattedValue = '';
                        
                        if (metric.id.includes('ratio') || metric.id.includes('margin') || metric.id.includes('yoy') || metric.id.includes('cross')) {
                            formattedValue = value.toFixed(1) + '%';
                        } else {
                            formattedValue = Math.round(value).toLocaleString();
                        }
                        
                        // æ¡ä»¶ä»˜ãæ›¸å¼ã‚’é©ç”¨ã™ã‚‹æŒ‡æ¨™
                        const conditionalMetrics = ['target_ratio', 'yoy_ratio', 'market_yoy', 'profit_yoy'];
                        let colorStyle = '';
                        
                        if (conditionalMetrics.includes(metric.id)) {
                            if (value >= 100) {
                                colorStyle = ' style="color: #0070C0; font-weight: bold;"';
                            } else {
                                colorStyle = ' style="color: #C00000; font-weight: bold;"';
                            }
                        }
                        
                        if (metric.databar) {
                            const percentage = Math.min(Math.abs(value), 100);
                            const bgColor = `linear-gradient(to right, rgba(135, 179, 226, 0.5) 0%, rgba(135, 179, 226, 0.5) ${percentage}%, transparent ${percentage}%)`;
                            html += `<td class="databar-cell" style="background-image: ${bgColor};${colorStyle ? colorStyle.replace('style="', '').replace('"', '') : ''}">${formattedValue}</td>`;
                        } else {
                            html += `<td${colorStyle}>${formattedValue}</td>`;
                        }
                    });
                    
                    html += '</tr>';
                });
                
                // åˆè¨ˆè¡Œã‚’è¿½åŠ 
                html += '<tr class="total-row">';
                
                // éšå±¤ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦åˆè¨ˆè¡Œã®åˆ—æ•°ã‚’èª¿æ•´
                if (currentLevel === 5) {
                    html += '<td class="name-column" colspan="2">åˆè¨ˆ</td>';
                } else if (currentLevel === 6) {
                    html += '<td class="name-column" colspan="3">åˆè¨ˆ</td>';
                } else {
                    html += '<td class="name-column">åˆè¨ˆ</td>';
                }
                
                visibleMetrics.forEach(metric => {
                    const value = totals[metric.id] || 0;
                    let formattedValue = '';
                    
                    if (metric.id.includes('ratio') || metric.id.includes('margin') || metric.id.includes('yoy') || metric.id.includes('cross')) {
                        formattedValue = value.toFixed(1) + '%';
                    } else if (metric.id === 'market_yoy') {
                        formattedValue = '-';
                    } else {
                        formattedValue = Math.round(value).toLocaleString();
                    }
                    
                    // æ¡ä»¶ä»˜ãæ›¸å¼ã‚’é©ç”¨ã™ã‚‹æŒ‡æ¨™
                    const conditionalMetrics = ['target_ratio', 'yoy_ratio', 'market_yoy', 'profit_yoy'];
                    let colorStyle = '';
                    
                    if (conditionalMetrics.includes(metric.id) && metric.id !== 'market_yoy') {
                        // market_yoyã¯åˆè¨ˆè¡Œã§ã¯'-'ãªã®ã§è‰²ä»˜ã‘ã—ãªã„
                        if (value >= 100) {
                            colorStyle = ' style="color: #0070C0; font-weight: bold;"';
                        } else {
                            colorStyle = ' style="color: #C00000; font-weight: bold;"';
                        }
                    }
                    
                    if (metric.databar) {
                        const percentage = Math.min(Math.abs(value), 100);
                        const bgColor = `linear-gradient(to right, rgba(135, 179, 226, 0.5) 0%, rgba(135, 179, 226, 0.5) ${percentage}%, transparent ${percentage}%)`;
                        html += `<td class="databar-cell" style="background-image: ${bgColor};${colorStyle ? colorStyle.replace('style="', '').replace('"', '') : ''}">${formattedValue}</td>`;
                    } else {
                        html += `<td${colorStyle}>${formattedValue}</td>`;
                    }
                });
                
                html += '</tr>';
                html += '</tbody></table>';
                
                document.getElementById('tableContainer').innerHTML = html;
                
                setupTableInteractions();
            }
            
            function getSortIcon(column) {
                const state = currentMode === 'standard' ? sortState : crossSortState;
                if (state.column === column) {
                    if (state.direction === 'asc') {
                        return '<span class="sort-icon">â–²</span>';
                    } else if (state.direction === 'desc') {
                        return '<span class="sort-icon">â–¼</span>';
                    }
                }
                return '<span class="sort-icon">â‡…</span>';
            }
            
            function setupTableInteractions() {
                // ã™ã¹ã¦ã®sortableãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’è¿½åŠ 
                document.querySelectorAll('.sortable').forEach(header => {
                    header.addEventListener('click', (e) => {
                        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯ã‚½ãƒ¼ãƒˆã—ãªã„
                        if (header.classList.contains('dragging')) {
                            return;
                        }
                        
                        const column = header.dataset.column;
                        const state = currentMode === 'standard' ? sortState : crossSortState;
                        
                        if (!state.column || state.column !== column) {
                            state.column = column;
                            state.direction = 'desc';
                        } else if (state.direction === 'desc') {
                            state.direction = 'asc';
                        } else {
                            state.column = null;
                            state.direction = null;
                        }
                        
                        if (currentMode === 'standard') {
                            sortState = state;
                            updateView();
                        } else {
                            crossSortState = state;
                            updateCrossView();
                        }
                    });
                });
                
                setupDragAndDrop();
                
                if (currentHierarchy.length < 6) {
                    document.querySelectorAll('.drill-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            currentHierarchy.push(btn.dataset.item);
                            sortState = {column: null, direction: null};
                            updateView();
                        });
                    });
                }
            }
            
            let draggedElement = null;
            let draggedMetricId = null;
            
            function setupDragAndDrop() {
                const draggableHeaders = document.querySelectorAll('.draggable-header');
                
                draggableHeaders.forEach(header => {
                    header.addEventListener('dragstart', handleDragStart);
                    header.addEventListener('dragover', handleDragOver);
                    header.addEventListener('drop', handleDrop);
                    header.addEventListener('dragend', handleDragEnd);
                    header.addEventListener('dragenter', handleDragEnter);
                    header.addEventListener('dragleave', handleDragLeave);
                });
            }
            
            function handleDragStart(e) {
                draggedElement = this;
                draggedMetricId = this.dataset.metricId || this.dataset.type;
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            }
            
            function handleDragOver(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                }
                e.dataTransfer.dropEffect = 'move';
                return false;
            }
            
            function handleDragEnter(e) {
                if (this !== draggedElement) {
                    this.classList.add('drag-over');
                }
            }
            
            function handleDragLeave(e) {
                this.classList.remove('drag-over');
            }
            
            function handleDrop(e) {
                if (e.stopPropagation) {
                    e.stopPropagation();
                }
                
                const dropMetricId = this.dataset.metricId || this.dataset.type;
                
                if (draggedMetricId !== dropMetricId) {
                    if (currentMode === 'standard') {
                        const dragIndex = allMetrics.findIndex(m => m.id === draggedMetricId);
                        const dropIndex = allMetrics.findIndex(m => m.id === dropMetricId);
                        
                        const [draggedMetric] = allMetrics.splice(dragIndex, 1);
                        allMetrics.splice(dropIndex, 0, draggedMetric);
                        
                        updateView();
                    } else {
                        const dragIndex = typeOrder.indexOf(draggedMetricId);
                        const dropIndex = typeOrder.indexOf(dropMetricId);
                        
                        const [draggedType] = typeOrder.splice(dragIndex, 1);
                        typeOrder.splice(dropIndex, 0, draggedType);
                        
                        updateCrossView();
                    }
                }
                
                return false;
            }
            
            function handleDragEnd(e) {
                document.querySelectorAll('.draggable-header').forEach(header => {
                    header.classList.remove('dragging', 'drag-over');
                });
                draggedElement = null;
                draggedMetricId = null;
            }
            
            document.getElementById('drillAllBtn').addEventListener('click', () => {
                if (currentHierarchy.length < 7) {
                    currentHierarchy.push('*ALL*');
                    sortState = {column: null, direction: null};
                    updateView();
                }
            });
            
            // ç¸¦æ¨ªæ¯”è¨­å®šã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
            document.getElementById('bubbleChartAspectPreset').addEventListener('change', function() {
                const customSpan = document.getElementById('bubbleChartCustomAspect');
                customSpan.style.display = this.value === 'custom' ? 'inline' : 'none';
            });
            
            document.getElementById('crossChartAspectPreset').addEventListener('change', function() {
                const customSpan = document.getElementById('crossChartCustomAspect');
                customSpan.style.display = this.value === 'custom' ? 'inline' : 'none';
            });
            
            // ãƒãƒ–ãƒ«ãƒãƒ£ãƒ¼ãƒˆè»¸é¸æŠã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
            ['bubbleXAxis', 'bubbleYAxis', 'bubbleSize'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    updateCharts();
                });
            });
            
            // ãƒãƒ–ãƒ«å€ç‡ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
            document.getElementById('bubbleScale').addEventListener('input', function() {
                document.getElementById('bubbleScaleValue').textContent = this.value + 'x';
                updateCharts();
            });
            
            // ã‚°ãƒ©ãƒ•æ›´æ–°é–¢æ•°
            function updateCharts() {
                const data = getCurrentData();
                const aggregatedData = calculateMetrics(data);
                
                if (aggregatedData.length === 0) {
                    return;
                }
                
                updateBubbleChart(aggregatedData);
            }
            
            // ãƒãƒ–ãƒ«ãƒãƒ£ãƒ¼ãƒˆ
            function updateBubbleChart(data) {
                const ctx = document.getElementById('bubbleChart');
                
                if (bubbleChart) {
                    bubbleChart.destroy();
                }
                
                // é¸æŠã•ã‚ŒãŸè»¸ã‚’å–å¾—
                const xAxisId = document.getElementById('bubbleXAxis').value;
                const yAxisId = document.getElementById('bubbleYAxis').value;
                const sizeId = document.getElementById('bubbleSize').value;
                const scale = parseFloat(document.getElementById('bubbleScale').value);
                
                // æŒ‡æ¨™åã®ãƒãƒƒãƒ”ãƒ³ã‚°
                const metricNames = {
                    sales: 'å£²ä¸Šé«˜',
                    sales_ratio: 'å£²ä¸Šæ§‹æˆæ¯”',
                    last_sales: 'æ˜¨å¹´å£²ä¸Šé«˜',
                    target_ratio: 'å£²ä¸Šç›®æ¨™æ¯”',
                    yoy_ratio: 'å£²ä¸Šå‰å¹´æ¯”',
                    profit: 'è’åˆ©é«˜',
                    profit_yoy: 'è’åˆ©å‰å¹´æ¯”',
                    margin: 'è’åˆ©ç‡',
                    last_margin: 'æ˜¨å¹´è’åˆ©ç‡',
                    cross_ratio: 'ç›¸ä¹—ç©'
                };
                
                // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ(å„ãƒãƒ–ãƒ«ã«ç•°ãªã‚‹è‰²ã‚’å‰²ã‚Šå½“ã¦)
                const colorPalette = [
                    'rgba(31, 95, 139, 0.7)',
                    'rgba(135, 179, 226, 0.7)',
                    'rgba(76, 175, 80, 0.7)',
                    'rgba(255, 152, 0, 0.7)',
                    'rgba(244, 67, 54, 0.7)',
                    'rgba(156, 39, 176, 0.7)',
                    'rgba(0, 188, 212, 0.7)',
                    'rgba(255, 235, 59, 0.7)',
                    'rgba(121, 85, 72, 0.7)',
                    'rgba(158, 158, 158, 0.7)',
                    'rgba(233, 30, 99, 0.7)',
                    'rgba(103, 58, 183, 0.7)',
                    'rgba(0, 150, 136, 0.7)',
                    'rgba(205, 220, 57, 0.7)',
                    'rgba(255, 87, 34, 0.7)'
                ];
                
                const borderColorPalette = colorPalette.map(c => c.replace('0.7', '1'));
                
                // ãƒãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                const bubbleData = data.map((d, index) => {
                    let radius;
                    if (sizeId === 'none') {
                        radius = 10 * scale;
                    } else {
                        const sizeValue = Math.abs(d[sizeId]) || 1;
                        radius = Math.sqrt(sizeValue) * scale;
                    }
                    
                    return {
                        x: d[xAxisId],
                        y: d[yAxisId],
                        r: radius,
                        label: d.name,
                        backgroundColor: colorPalette[index % colorPalette.length],
                        borderColor: borderColorPalette[index % borderColorPalette.length]
                    };
                });
                
                // å˜ä½ã®åˆ¤å®š
                const isPercentage = (id) => {
                    return id.includes('ratio') || id.includes('margin') || id.includes('yoy') || id.includes('cross');
                };
                
                const xUnit = isPercentage(xAxisId) ? '%' : 'åƒå††';
                const yUnit = isPercentage(yAxisId) ? '%' : 'åƒå††';
                
                bubbleChart = new Chart(ctx, {
                    type: 'bubble',
                    data: {
                        datasets: bubbleData.map((point, index) => ({
                            label: point.label,
                            data: [{
                                x: point.x,
                                y: point.y,
                                r: point.r
                            }],
                            backgroundColor: point.backgroundColor,
                            borderColor: point.borderColor,
                            borderWidth: 2
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'right',
                                labels: {
                                    boxWidth: 15,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: `${metricNames[xAxisId]} Ã— ${metricNames[yAxisId]}` + 
                                      (sizeId !== 'none' ? ` (ãƒãƒ–ãƒ«ã‚µã‚¤ã‚º:${metricNames[sizeId]})` : ''),
                                font: {
                                    size: 16
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const datasetLabel = context.dataset.label;
                                        const xValue = isPercentage(xAxisId) ? 
                                            context.parsed.x.toFixed(1) + '%' : 
                                            Math.round(context.parsed.x).toLocaleString() + 'åƒå††';
                                        const yValue = isPercentage(yAxisId) ? 
                                            context.parsed.y.toFixed(1) + '%' : 
                                            Math.round(context.parsed.y).toLocaleString() + 'åƒå††';
                                        
                                        return [
                                            datasetLabel,
                                            `${metricNames[xAxisId]}: ${xValue}`,
                                            `${metricNames[yAxisId]}: ${yValue}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: `${metricNames[xAxisId]} (${xUnit})`
                                },
                                ticks: {
                                    callback: function(value) {
                                        if (isPercentage(xAxisId)) {
                                            return value.toFixed(0) + '%';
                                        } else {
                                            return value.toLocaleString();
                                        }
                                    }
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: `${metricNames[yAxisId]} (${yUnit})`
                                },
                                ticks: {
                                    callback: function(value) {
                                        if (isPercentage(yAxisId)) {
                                            return value.toFixed(0) + '%';
                                        } else {
                                            return value.toLocaleString();
                                        }
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // ã‚°ãƒ©ãƒ•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–¢æ•°
            function downloadChart(chart, aspectPresetId, customWidthId, customHeightId, filename) {
                if (!chart) return;
                
                const preset = document.getElementById(aspectPresetId).value;
                let width, height;
                
                if (preset === 'custom') {
                    width = parseInt(document.getElementById(customWidthId).value) || 16;
                    height = parseInt(document.getElementById(customHeightId).value) || 9;
                } else {
                    [width, height] = preset.split(':').map(Number);
                }
                
                const baseWidth = 1920;
                const newWidth = baseWidth;
                const newHeight = Math.round(baseWidth * height / width);
                
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = newWidth;
                tempCanvas.height = newHeight;
                
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.width = newWidth + 'px';
                tempContainer.style.height = newHeight + 'px';
                tempContainer.appendChild(tempCanvas);
                document.body.appendChild(tempContainer);
                
                const tempChart = new Chart(tempCanvas, {
                    type: chart.config.type,
                    data: chart.config.data,
                    options: {
                        ...chart.config.options,
                        responsive: false,
                        maintainAspectRatio: false,
                        animation: false
                    },
                    plugins: chart.config.plugins
                });
                
                setTimeout(() => {
                    const url = tempCanvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = filename + '_' + new Date().toISOString().slice(0, 10) + '.png';
                    link.href = url;
                    link.click();
                    
                    tempChart.destroy();
                    document.body.removeChild(tempContainer);
                }, 100);
            }
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
            document.getElementById('downloadBubbleChart').addEventListener('click', () => {
                downloadChart(
                    bubbleChart,
                    'bubbleChartAspectPreset',
                    'bubbleChartAspectWidth',
                    'bubbleChartAspectHeight',
                    'å¤šæ¬¡å…ƒåˆ†æãƒãƒ–ãƒ«ãƒãƒ£ãƒ¼ãƒˆ'
                );
            });
            
            document.getElementById('downloadCrossChart').addEventListener('click', () => {
                downloadChart(
                    crossChart,
                    'crossChartAspectPreset',
                    'crossChartAspectWidth',
                    'crossChartAspectHeight',
                    'ã‚¯ãƒ­ã‚¹åˆ†æ_å£²ä¸Šæ§‹æˆæ¯”'
                );
            });
            
            document.getElementById('exportTableBtn').addEventListener('click', () => {
                const table = document.querySelector('#tableContainer table');
                if (!table) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹è¡¨ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const clonedTable = table.cloneNode(true);
                clonedTable.querySelectorAll('.sort-icon').forEach(icon => icon.remove());
                clonedTable.querySelectorAll('.drill-btn').forEach(btn => btn.remove());
                clonedTable.querySelectorAll('th::before').forEach(el => {
                    el.style.content = 'none';
                });
                
                const downloadContainer = document.createElement('div');
                downloadContainer.style.position = 'absolute';
                downloadContainer.style.left = '-9999px';
                downloadContainer.style.top = '0';
                downloadContainer.style.padding = '20px';
                downloadContainer.style.backgroundColor = '#ffffff';
                downloadContainer.appendChild(clonedTable);
                document.body.appendChild(downloadContainer);
                
                setTimeout(() => {
                    html2canvas(downloadContainer, {
                        backgroundColor: '#ffffff',
                        scale: 2,
                        logging: false,
                        useCORS: true
                    }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = 'å£²ä¸Šåˆ†æè¡¨_' + new Date().toISOString().slice(0, 10) + '.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                        document.body.removeChild(downloadContainer);
                    }).catch(error => {
                        console.error('ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                        alert('ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                        document.body.removeChild(downloadContainer);
                    });
                }, 200);
            });
            
            document.getElementById('exportCrossTableBtn').addEventListener('click', () => {
                const table = document.querySelector('#crossTableContainer table');
                if (!table) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹è¡¨ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const clonedTable = table.cloneNode(true);
                clonedTable.querySelectorAll('.sort-icon').forEach(icon => icon.remove());
                clonedTable.querySelectorAll('.drill-btn').forEach(btn => btn.remove());
                clonedTable.querySelectorAll('th::before').forEach(el => {
                    el.style.content = 'none';
                });
                
                // ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã«å¤‰æ›
                clonedTable.querySelectorAll('.databar-sales-ratio').forEach(cell => {
                    const percentage = cell.style.getPropertyValue('--percentage');
                    if (percentage) {
                        const bgColor = `linear-gradient(to right, rgba(135, 179, 226, 0.5) 0%, rgba(135, 179, 226, 0.5) ${percentage}, transparent ${percentage})`;
                        cell.style.backgroundImage = bgColor;
                        cell.style.removeProperty('--percentage');
                    }
                });
                
                const downloadContainer = document.createElement('div');
                downloadContainer.style.position = 'absolute';
                downloadContainer.style.left = '-9999px';
                downloadContainer.style.top = '0';
                downloadContainer.style.padding = '20px';
                downloadContainer.style.backgroundColor = '#ffffff';
                downloadContainer.appendChild(clonedTable);
                document.body.appendChild(downloadContainer);
                
                setTimeout(() => {
                    html2canvas(downloadContainer, {
                        backgroundColor: '#ffffff',
                        scale: 2,
                        logging: false,
                        useCORS: true
                    }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = 'ã‚¯ãƒ­ã‚¹åˆ†æè¡¨_' + new Date().toISOString().slice(0, 10) + '.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                        document.body.removeChild(downloadContainer);
                    }).catch(error => {
                        console.error('ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                        alert('ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                        document.body.removeChild(downloadContainer);
                    });
                }, 200);
            });
            
            // ======================
            // ã‚¯ãƒ­ã‚¹åˆ†ææ©Ÿèƒ½
            // ======================
            
            function getCurrentCrossData() {
                let data = rawData; // ã‚¯ãƒ­ã‚¹åˆ†æã¯ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒ—åˆ†é¡ã‚’å¯¾è±¡
                const levels = hierarchyLevels[crossClassification];
                
                crossHierarchy.forEach((value, index) => {
                    if (value !== '*ALL*') {
                        const level = levels[index];
                        data = data.filter(row => row[level] === value);
                    }
                });
                
                return data;
            }
            
            function updateCrossView() {
                updateCrossBreadcrumb();
                
                const currentLevel = crossHierarchy.length;
                
                if (currentLevel < 6) {
                    document.getElementById('crossDrillAllBtn').classList.remove('hidden');
                } else {
                    document.getElementById('crossDrillAllBtn').classList.add('hidden');
                }
                
                updateCrossTable();
                updateCrossChart();
            }
            
            function updateCrossBreadcrumb() {
                const breadcrumb = document.getElementById('crossBreadcrumb');
                let html = '<span class="breadcrumb-item" data-level="-1">ãƒˆãƒƒãƒ—</span>';
                
                crossHierarchy.forEach((item, index) => {
                    const displayText = item === '*ALL*' ? 'å…¨ä½“' : item;
                    html += ' > <span class="breadcrumb-item' + 
                            (index === crossHierarchy.length - 1 ? ' current' : '') + 
                            '" data-level="' + index + '">' + displayText + '</span>';
                });
                
                breadcrumb.innerHTML = html;
                
                breadcrumb.querySelectorAll('.breadcrumb-item:not(.current)').forEach(item => {
                    item.addEventListener('click', () => {
                        const level = parseInt(item.dataset.level);
                        crossHierarchy = crossHierarchy.slice(0, level + 1);
                        crossSortState = {column: null, direction: null};
                        updateCrossView();
                    });
                });
            }
            
            document.getElementById('crossDrillAllBtn').addEventListener('click', () => {
                if (crossHierarchy.length < 7) {
                    crossHierarchy.push('*ALL*');
                    crossSortState = {column: null, direction: null};
                    updateCrossView();
                }
            });
            
            function calculateCrossMetrics(data) {
                const levels = hierarchyLevels[crossClassification];
                const currentLevel = crossHierarchy.length;
                
                if (currentLevel >= 7) {
                    return [];
                }
                
                const nextLevel = levels[currentLevel];
                
                // éšå±¤5ãƒ»6ã§ã¯ä¸Šä½éšå±¤ã¨ã®çµ„ã¿åˆã‚ã›ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–
                let categories;
                if (currentLevel === 5) {
                    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆéšå±¤ï¼šã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ + ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®çµ„ã¿åˆã‚ã›ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–
                    const combinations = data.map(d => ({
                        subCategory: d[levels[4]],
                        segment: d[nextLevel]
                    }));
                    const uniqueCombos = Array.from(
                        new Map(combinations.map(c => [`${c.subCategory}|||${c.segment}`, c])).values()
                    );
                    categories = uniqueCombos.sort((a, b) => {
                        if (a.subCategory !== b.subCategory) {
                            return a.subCategory.localeCompare(b.subCategory, 'ja');
                        }
                        return a.segment.localeCompare(b.segment, 'ja');
                    });
                } else if (currentLevel === 6) {
                    // ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆéšå±¤ï¼šã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ + ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ + ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®çµ„ã¿åˆã‚ã›
                    const combinations = data.map(d => ({
                        subCategory: d[levels[4]],
                        segment: d[levels[5]],
                        subsegment: d[nextLevel]
                    }));
                    const uniqueCombos = Array.from(
                        new Map(combinations.map(c => [`${c.subCategory}|||${c.segment}|||${c.subsegment}`, c])).values()
                    );
                    categories = uniqueCombos.sort((a, b) => {
                        if (a.subCategory !== b.subCategory) {
                            return a.subCategory.localeCompare(b.subCategory, 'ja');
                        }
                        if (a.segment !== b.segment) {
                            return a.segment.localeCompare(b.segment, 'ja');
                        }
                        return a.subsegment.localeCompare(b.subsegment, 'ja');
                    });
                } else {
                    // é€šå¸¸ã®éšå±¤ï¼šåå‰ã®ã¿ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–
                    categories = [...new Set(data.map(d => d[nextLevel]))].filter(x => x).sort();
                }
                
                const types = [...new Set(data.map(d => d['ã‚¿ã‚¤ãƒ—åˆ†é¡å']))].sort();
                
                // ã‚¿ã‚¤ãƒ—é †åºã®åˆæœŸåŒ–
                if (typeOrder.length === 0) {
                    typeOrder = [...types];
                }
                
                // å…¨ä½“ã®åˆè¨ˆã‚’è¨ˆç®—(ã‚¿ã‚¤ãƒ—åˆ¥)
                const typeTotals = {};
                types.forEach(type => {
                    const typeData = data.filter(d => d['ã‚¿ã‚¤ãƒ—åˆ†é¡å'] === type);
                    typeTotals[type] = {
                        sales: typeData.reduce((sum, d) => sum + (d['å£²ä¸Šé«˜ç¨æŠœ(åƒå††)'] || 0), 0),
                        last_sales: typeData.reduce((sum, d) => sum + (d['æ˜¨å¹´å£²ä¸Šé«˜ç¨æŠœ(åƒå††)'] || 0), 0)
                    };
                });
                
                const aggregatedData = categories.map(category => {
                    let categoryData;
                    let name;
                    let hierarchyInfo = {};
                    
                    if (currentLevel === 5) {
                        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆéšå±¤
                        categoryData = data.filter(d => 
                            d[levels[4]] === category.subCategory && 
                            d[nextLevel] === category.segment
                        );
                        name = category.segment;
                        hierarchyInfo.subCategory = category.subCategory;
                    } else if (currentLevel === 6) {
                        // ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆéšå±¤
                        categoryData = data.filter(d => 
                            d[levels[4]] === category.subCategory && 
                            d[levels[5]] === category.segment && 
                            d[nextLevel] === category.subsegment
                        );
                        name = category.subsegment;
                        hierarchyInfo.subCategory = category.subCategory;
                        hierarchyInfo.segment = category.segment;
                    } else {
                        // é€šå¸¸ã®éšå±¤
                        categoryData = data.filter(d => d[nextLevel] === category);
                        name = category;
                        
                        // ä¸Šä½éšå±¤ã®æƒ…å ±ã‚’å–å¾—
                        if (categoryData.length > 0) {
                            const firstItem = categoryData[0];
                            if (currentLevel >= 4) {
                                hierarchyInfo.subCategory = firstItem[levels[4]] || '';
                            }
                            if (currentLevel >= 5) {
                                hierarchyInfo.segment = firstItem[levels[5]] || '';
                            }
                        }
                    }
                    
                    const result = {
                        name: name,
                        hierarchyInfo,
                        types: {}
                    };
                    
                    types.forEach(type => {
                        const typeData = categoryData.filter(d => d['ã‚¿ã‚¤ãƒ—åˆ†é¡å'] === type);
                        const sales = typeData.reduce((sum, d) => sum + (d['å£²ä¸Šé«˜ç¨æŠœ(åƒå††)'] || 0), 0);
                        const last_sales = typeData.reduce((sum, d) => sum + (d['æ˜¨å¹´å£²ä¸Šé«˜ç¨æŠœ(åƒå††)'] || 0), 0);
                        
                        const sales_ratio = typeTotals[type].sales > 0 ? (sales / typeTotals[type].sales) * 100 : 0;
                        const yoy_ratio = last_sales > 0 ? (sales / last_sales) * 100 : 0;
                        
                        result.types[type] = {
                            sales,
                            sales_ratio,
                            yoy_ratio
                        };
                    });
                    
                    return result;
                });
                
                return aggregatedData;
            }
            
            function updateCrossTable() {
                const data = getCurrentCrossData();
                const aggregatedData = calculateCrossMetrics(data);
                const currentLevel = crossHierarchy.length;
                
                // ã‚½ãƒ¼ãƒˆå‡¦ç†
                if (crossSortState.column) {
                    aggregatedData.sort((a, b) => {
                        let aVal, bVal;
                        
                        if (crossSortState.column === 'name') {
                            aVal = a.name;
                            bVal = b.name;
                        } else if (crossSortState.column === 'subCategory') {
                            aVal = a.hierarchyInfo.subCategory || '';
                            bVal = b.hierarchyInfo.subCategory || '';
                        } else if (crossSortState.column === 'segment') {
                            aVal = a.hierarchyInfo.segment || '';
                            bVal = b.hierarchyInfo.segment || '';
                        } else {
                            // ã‚¿ã‚¤ãƒ—åˆ¥ã®æŒ‡æ¨™ã§ã‚½ãƒ¼ãƒˆ
                            // åˆ—åã®å½¢å¼: {ã‚¿ã‚¤ãƒ—å}_{ãƒ¡ãƒˆãƒªãƒƒã‚¯å}
                            // ãƒ¡ãƒˆãƒªãƒƒã‚¯å: sales, sales_ratio, yoy_ratio
                            let type, metric;
                            if (crossSortState.column.endsWith('_yoy_ratio')) {
                                metric = 'yoy_ratio';
                                type = crossSortState.column.slice(0, -10); // '_yoy_ratio' = 10æ–‡å­—
                            } else if (crossSortState.column.endsWith('_sales_ratio')) {
                                metric = 'sales_ratio';
                                type = crossSortState.column.slice(0, -12); // '_sales_ratio' = 12æ–‡å­—
                            } else if (crossSortState.column.endsWith('_sales')) {
                                metric = 'sales';
                                type = crossSortState.column.slice(0, -6); // '_sales' = 6æ–‡å­—
                            }
                            aVal = a.types[type] ? a.types[type][metric] : 0;
                            bVal = b.types[type] ? b.types[type][metric] : 0;
                        }
                        
                        if (typeof aVal === 'string') {
                            return crossSortState.direction === 'asc' 
                                ? aVal.localeCompare(bVal, 'ja')
                                : bVal.localeCompare(aVal, 'ja');
                        } else {
                            return crossSortState.direction === 'asc' ? aVal - bVal : bVal - aVal;
                        }
                    });
                }
                
                // ã‚½ãƒ¼ãƒˆæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                crossAggregatedData = aggregatedData;
                
                renderCrossTable(aggregatedData, currentLevel);
            }
            
            function renderCrossTable(data, currentLevel) {
                const levels = hierarchyLevels[crossClassification];
                const nextLevel = levels[currentLevel];
                
                // å„ã‚¿ã‚¤ãƒ—ã®åˆè¨ˆã‚’è¨ˆç®—
                const typeTotals = {};
                typeOrder.forEach(type => {
                    typeTotals[type] = {
                        sales: 0,
                        sales_ratio: 0,
                        yoy_ratio: 0
                    };
                    
                    data.forEach(item => {
                        const typeData = item.types[type] || {sales: 0, sales_ratio: 0, yoy_ratio: 0};
                        typeTotals[type].sales += typeData.sales;
                        typeTotals[type].sales_ratio += typeData.sales_ratio;
                    });
                });
                
                // å‰å¹´æ¯”ã®è¨ˆç®—ç”¨ãƒ‡ãƒ¼ã‚¿
                const dataCrossData = getCurrentCrossData();
                typeOrder.forEach(type => {
                    const typeData = dataCrossData.filter(d => d['ã‚¿ã‚¤ãƒ—åˆ†é¡å'] === type);
                    const sales = typeData.reduce((sum, d) => sum + (d['å£²ä¸Šé«˜ç¨æŠœ(åƒå††)'] || 0), 0);
                    const last_sales = typeData.reduce((sum, d) => sum + (d['æ˜¨å¹´å£²ä¸Šé«˜ç¨æŠœ(åƒå††)'] || 0), 0);
                    typeTotals[type].yoy_ratio = last_sales > 0 ? (sales / last_sales) * 100 : 0;
                });
                
                let html = '<div class="cross-table"><table><thead>';
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ1(ã‚¿ã‚¤ãƒ—åˆ†é¡å)
                html += '<tr>';
                
                // éšå±¤ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦åˆ†é¡åã®ãƒ˜ãƒƒãƒ€ãƒ¼åˆ—ã‚’èª¿æ•´
                if (currentLevel === 5) {
                    html += `<th rowspan="2" class="sortable" data-column="subCategory">${levels[4]}${getSortIcon('subCategory')}</th>`;
                    html += `<th rowspan="2" class="sortable" data-column="name">${nextLevel}${getSortIcon('name')}</th>`;
                } else if (currentLevel === 6) {
                    html += `<th rowspan="2" class="sortable" data-column="subCategory">${levels[4]}${getSortIcon('subCategory')}</th>`;
                    html += `<th rowspan="2" class="sortable" data-column="segment">${levels[5]}${getSortIcon('segment')}</th>`;
                    html += `<th rowspan="2" class="sortable" data-column="name">${nextLevel}${getSortIcon('name')}</th>`;
                } else {
                    html += `<th rowspan="2" class="sortable" data-column="name">${nextLevel}${getSortIcon('name')}</th>`;
                }
                
                typeOrder.forEach(type => {
                    html += `<th colspan="3" class="draggable-header" draggable="true" data-type="${type}">${type}</th>`;
                });
                html += '</tr>';
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ2(æŒ‡æ¨™å)
                html += '<tr>';
                typeOrder.forEach(type => {
                    html += `<th class="sortable" data-column="${type}_sales">å£²ä¸Šé«˜<br>(åƒå††)${getSortIcon(type + '_sales')}</th>`;
                    html += `<th class="sortable" data-column="${type}_sales_ratio">å£²ä¸Šæ§‹æˆæ¯”${getSortIcon(type + '_sales_ratio')}</th>`;
                    html += `<th class="sortable" data-column="${type}_yoy_ratio">å£²ä¸Šå‰å¹´æ¯”${getSortIcon(type + '_yoy_ratio')}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                // ãƒ‡ãƒ¼ã‚¿è¡Œ
                data.forEach(item => {
                    html += '<tr>';
                    
                    // éšå±¤ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦åˆ†é¡ååˆ—ã‚’è¡¨ç¤º
                    if (currentLevel === 5) {
                        html += `<td class="category-cell">${item.hierarchyInfo.subCategory || ''}</td>`;
                        if (currentLevel < 6) {
                            html += `<td class="category-cell">
                                <button class="drill-btn" data-item="${item.name}">â–¼</button>
                                ${item.name}
                            </td>`;
                        } else {
                            html += `<td class="category-cell">${item.name}</td>`;
                        }
                    } else if (currentLevel === 6) {
                        html += `<td class="category-cell">${item.hierarchyInfo.subCategory || ''}</td>`;
                        html += `<td class="category-cell">${item.hierarchyInfo.segment || ''}</td>`;
                        html += `<td class="category-cell">${item.name}</td>`;
                    } else {
                        if (currentLevel < 6) {
                            html += `<td class="category-cell">
                                <button class="drill-btn" data-item="${item.name}">â–¼</button>
                                ${item.name}
                            </td>`;
                        } else {
                            html += `<td class="category-cell">${item.name}</td>`;
                        }
                    }
                    
                    typeOrder.forEach(type => {
                        const typeData = item.types[type] || {sales: 0, sales_ratio: 0, yoy_ratio: 0};
                        
                        // å£²ä¸Šé«˜
                        html += `<td>${Math.round(typeData.sales).toLocaleString()}</td>`;
                        
                        // å£²ä¸Šæ§‹æˆæ¯”(ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ä»˜ã)
                        const percentage = Math.min(Math.abs(typeData.sales_ratio), 100);
                        html += `<td class="databar-cell databar-sales-ratio" style="--percentage: ${percentage}%">${typeData.sales_ratio.toFixed(1)}%</td>`;
                        
                        // å£²ä¸Šå‰å¹´æ¯”(æ¡ä»¶ä»˜ãæ›¸å¼ä»˜ã)
                        const yoyValue = typeData.yoy_ratio;
                        const colorClass = yoyValue >= 100 ? 'yoy-positive' : 'yoy-negative';
                        html += `<td class="${colorClass}">${yoyValue.toFixed(1)}%</td>`;
                    });
                    
                    html += '</tr>';
                });
                
                // åˆè¨ˆè¡Œã‚’è¿½åŠ 
                html += '<tr class="total-row">';
                
                // éšå±¤ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦åˆè¨ˆè¡Œã®åˆ—æ•°ã‚’èª¿æ•´
                if (currentLevel === 5) {
                    html += '<td class="category-cell" colspan="2">åˆè¨ˆ</td>';
                } else if (currentLevel === 6) {
                    html += '<td class="category-cell" colspan="3">åˆè¨ˆ</td>';
                } else {
                    html += '<td class="category-cell">åˆè¨ˆ</td>';
                }
                
                typeOrder.forEach(type => {
                    const totalData = typeTotals[type];
                    
                    // å£²ä¸Šé«˜
                    html += `<td>${Math.round(totalData.sales).toLocaleString()}</td>`;
                    
                    // å£²ä¸Šæ§‹æˆæ¯”(ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ä»˜ã)
                    const percentage = Math.min(Math.abs(totalData.sales_ratio), 100);
                    html += `<td class="databar-cell databar-sales-ratio" style="--percentage: ${percentage}%">${totalData.sales_ratio.toFixed(1)}%</td>`;
                    
                    // å£²ä¸Šå‰å¹´æ¯”(æ¡ä»¶ä»˜ãæ›¸å¼ä»˜ã)
                    const yoyValue = totalData.yoy_ratio;
                    const colorClass = yoyValue >= 100 ? 'yoy-positive' : 'yoy-negative';
                    html += `<td class="${colorClass}">${yoyValue.toFixed(1)}%</td>`;
                });
                
                html += '</tr>';
                html += '</tbody></table></div>';
                
                document.getElementById('crossTableContainer').innerHTML = html;
                
                // ã‚¯ãƒ­ã‚¹åˆ†æç”¨ã®ãƒ‰ãƒªãƒ«ãƒœã‚¿ãƒ³
                document.querySelectorAll('#crossTableContainer .drill-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        crossHierarchy.push(btn.dataset.item);
                        crossSortState = {column: null, direction: null};
                        updateCrossView();
                    });
                });
                
                setupTableInteractions();
            }
            
            function updateCrossChart() {
                // ä¿å­˜ã•ã‚ŒãŸã‚½ãƒ¼ãƒˆæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                const aggregatedData = crossAggregatedData.length > 0 ? crossAggregatedData : calculateCrossMetrics(getCurrentCrossData());
                
                if (aggregatedData.length === 0) {
                    return;
                }
                
                const ctx = document.getElementById('crossChart');
                
                if (crossChart) {
                    crossChart.destroy();
                }
                
                // ã‚¿ã‚¤ãƒ—åˆ†é¡ã‚’Yè»¸ã®ãƒ©ãƒ™ãƒ«ã«ï¼ˆè¡¨ã®åˆ—é †ã‚’é€†ã«ã—ã¦ä¸Šã‹ã‚‰è¡¨ç¤ºï¼‰
                const typeLabels = [...typeOrder].reverse();
                
                // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä½œæˆï¼ˆå„å•†å“åˆ†é¡ãŒ1ã¤ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼‰
                // ã‚½ãƒ¼ãƒˆé †åºã‚’åæ˜ ï¼šaggregatedDataã®é †åºã§ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½œæˆ
                const colorPalette = [
                    '#FF6B6B',  // èµ¤ç³»
                    '#4ECDC4',  // é’ç·‘ç³»
                    '#45B7D1',  // é’ç³»
                    '#FFA07A',  // ã‚ªãƒ¬ãƒ³ã‚¸ç³»
                    '#98D8C8',  // ç·‘ç³»
                    '#F7DC6F',  // é»„è‰²ç³»
                    '#BB8FCE',  // ç´«ç³»
                    '#85C1E2',  // æ°´è‰²ç³»
                    '#F06292',  // ãƒ”ãƒ³ã‚¯ç³»
                    '#AED581',  // é»„ç·‘ç³»
                ];
                
                const datasets = aggregatedData.map((category, index) => {
                    return {
                        label: category.name,
                        data: typeLabels.map(type => category.types[type] ? category.types[type].sales_ratio : 0),
                        backgroundColor: colorPalette[index % colorPalette.length],
                        borderColor: 'white',
                        borderWidth: 1
                    };
                });
                
                crossChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: typeLabels,
                        datasets: datasets
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    boxWidth: 15,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'ã‚¿ã‚¤ãƒ—åˆ†é¡åˆ¥å£²ä¸Šæ§‹æˆæ¯”',
                                font: {
                                    size: 16
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.x.toFixed(1) + '%';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                min: 0,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'æ§‹æˆæ¯” (%)'
                                }
                            },
                            y: {
                                stacked: true,
                                ticks: {
                                    autoSkip: false,
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>

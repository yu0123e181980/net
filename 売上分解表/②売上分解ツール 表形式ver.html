<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡¨å½¢å¼å£²ä¸Šåˆ†è§£ãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Hiragino Sans", "Yu Gothic", "Meiryo", "MS PGothic", sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1F5F8B 0%, #2C7FB8 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20000;
        }
        
        .splash-content {
            text-align: center;
        }
        
        .splash-title {
            color: white;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 40px;
            opacity: 0;
            animation: fadeInUp 0.6s ease-out 0.2s forwards;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chart-animation {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 8px;
            height: 120px;
            margin-bottom: 30px;
        }
        
        .bar {
            width: 20px;
            background: white;
            border-radius: 3px 3px 0 0;
            opacity: 0.9;
            animation: growBar 0.8s ease-out forwards;
        }
        
        .bar:nth-child(1) {
            height: 60px;
            animation-delay: 0.3s;
        }
        
        .bar:nth-child(2) {
            height: 90px;
            animation-delay: 0.4s;
        }
        
        .bar:nth-child(3) {
            height: 45px;
            animation-delay: 0.5s;
        }
        
        .bar:nth-child(4) {
            height: 75px;
            animation-delay: 0.6s;
        }
        
        .bar:nth-child(5) {
            height: 100px;
            animation-delay: 0.7s;
        }
        
        .bar:nth-child(6) {
            height: 55px;
            animation-delay: 0.8s;
        }
        
        @keyframes growBar {
            from {
                transform: scaleY(0);
                opacity: 0;
            }
            to {
                transform: scaleY(1);
                opacity: 0.9;
            }
        }
        
        .loading-text {
            color: white;
            font-size: 14px;
            opacity: 0;
            animation: fadeIn 0.5s ease-out 1.5s forwards;
        }
        
        @keyframes fadeIn {
            to {
                opacity: 0.8;
            }
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .modal {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .modal-content {
            margin-bottom: 25px;
            line-height: 1.8;
            color: #555;
        }
        
        .library-list {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid #1F5F8B;
        }
        
        .library-list li {
            margin: 8px 0;
            color: #333;
        }
        
        .security-info {
            background: #e8f5e9;
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid #4CAF50;
            font-size: 14px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #1F5F8B;
            color: white;
        }
        
        .btn-primary:hover {
            background: #164563;
        }
        
        .btn-secondary {
            background: #ddd;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #ccc;
        }
        
        .loading-message {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1F5F8B;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #ffebee;
            padding: 20px;
            border-radius: 4px;
            border-left: 4px solid #f44336;
            color: #c62828;
            margin-bottom: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .upload-area {
            border: 3px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #1F5F8B;
            background: #f9f9f9;
        }
        
        .upload-area.dragover {
            border-color: #1F5F8B;
            background: #e3f2fd;
        }
        
        .filters {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
        }
        
        .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .table-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .drill-btn-group {
            display: flex;
            gap: 10px;
        }
        
        .drill-all-btn, .drill-up-btn {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
        }
        
        .drill-all-btn:hover, .drill-up-btn:hover {
            background: #45a049;
        }
        
        .drill-all-btn:disabled, .drill-up-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .drill-up-btn {
            background: #9E9E9E;
        }
        
        .drill-up-btn:hover {
            background: #757575;
        }
        
        .export-btn {
            padding: 8px 16px;
            background: #FF9800;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
        }
        
        .export-btn:hover {
            background: #F57C00;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 4px;
            font-size: 14px;
            flex-wrap: wrap;
        }
        
        .breadcrumb-item {
            color: #1F5F8B;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .breadcrumb-item:hover {
            color: #164563;
        }
        
        .breadcrumb-item.current {
            color: #333;
            cursor: default;
            text-decoration: none;
            font-weight: bold;
        }
        
        .breadcrumb-separator {
            color: #999;
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            background: white;
        }
        
        .data-table th {
            background: #1F5F8B;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #164563;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table th.sortable {
            cursor: pointer;
            user-select: none;
        }
        
        .data-table th.sortable:hover {
            background: #164563;
        }
        
        .data-table td {
            padding: 10px 8px;
            border: 1px solid #ddd;
            text-align: right;
        }
        
        .data-table td.category-cell {
            text-align: left;
            font-weight: 500;
            background: #f9f9f9;
            white-space: nowrap;
        }
        
        .data-table .drill-btn-cell {
            padding: 10px 8px;
            text-align: left;
            cursor: pointer;
            color: #1F5F8B;
            font-weight: bold;
            user-select: none;
            background: #f9f9f9;
        }
        
        .data-table .drill-btn-cell:hover {
            background: #e3f2fd;
        }
        
        .yoy-positive {
            color: #0070C0;
            font-weight: bold;
        }
        
        .yoy-negative {
            color: #C00000;
            font-weight: bold;
        }
        
        .sort-indicator {
            margin-left: 5px;
            font-size: 10px;
        }
    </style>
</head>
<body>
    <!-- ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ -->
    <div id="splashScreen" class="splash-screen">
        <div class="splash-content">
            <div class="splash-title">è¡¨å½¢å¼å£²ä¸Šåˆ†è§£ãƒ„ãƒ¼ãƒ«</div>
            <div class="chart-animation">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
            <div class="loading-text">Loading...</div>
        </div>
    </div>
    
    <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="confirmModal" class="modal-overlay hidden">
        <div class="modal">
            <h2>ğŸ”’ å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ç¢ºèª</h2>
            <div class="modal-content">
                <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®JavaScriptãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å¤–éƒ¨ã‹ã‚‰èª­ã¿è¾¼ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™:</p>
                
                <div class="library-list">
                    <ul>
                        <li><strong>XLSX.js (v0.18.5)</strong> - Excelãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ç”¨</li>
                        <li><strong>html2canvas (v1.4.1)</strong> - ç”»åƒå‡ºåŠ›ç”¨</li>
                    </ul>
                </div>
                
                <div class="security-info">
                    <strong>âœ“ æ¥ç¶šæƒ…å ±:</strong><br>
                    ãƒ»æ¥ç¶šå…ˆ: https://cdnjs.cloudflare.com (Cloudflareå…¬å¼CDN)<br>
                    ãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“<br>
                    ãƒ»ã™ã¹ã¦ã®å‡¦ç†ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å®Œçµã—ã¾ã™
                </div>
                
                <p style="color: #666; font-size: 13px; margin-top: 15px;">
                    â€»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯æ¯å›ã®ãƒ„ãƒ¼ãƒ«èµ·å‹•æ™‚ã«èª­ã¿è¾¼ã¾ã‚Œã€ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§ã®ã¿å‹•ä½œã—ã¾ã™ã€‚<br>
                    â€»æœ¬ãƒ„ãƒ¼ãƒ«å†…ã§åˆ©ç”¨ã•ã‚Œã‚‹CDN(Content Delivery Network)çµŒç”±ã§æä¾›ã•ã‚Œã‚‹å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¤ã„ã¦ã¯ã€ãã®å®‰å…¨æ€§ã€å¯ç”¨æ€§ã€æ­£ç¢ºæ€§ã€ãŠã‚ˆã³ãƒ„ãƒ¼ãƒ«ã®æ©Ÿèƒ½ã«ä¸ãˆã‚‹å½±éŸ¿ã‚’å«ã‚ã€ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚
                </p>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" id="approveBtn">è¨˜è¼‰äº‹é …ã«åŒæ„ã—ã¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚€</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <h1>è¡¨å½¢å¼å£²ä¸Šåˆ†è§£ãƒ„ãƒ¼ãƒ«</h1>
        
        <div id="loadingMessage" class="loading-message hidden">
            <div class="loading-spinner"></div>
            <p>ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
        </div>
        
        <div id="errorMessage" class="error-message hidden"></div>
        
        <div id="mainApp" class="hidden">
            <div class="upload-area" id="uploadArea">
                <p>Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden">
            </div>
            
            <div id="mainContent" class="hidden">
                <div class="filters">
                    <div class="filter-group">
                        <label>åˆ†æåŸºæº–</label>
                        <select id="analysisType">
                            <option value="SuCå•†å“åˆ†é¡">SuCå•†å“åˆ†é¡</option>
                            <option value="SMARTå•†å“åˆ†é¡">SMARTå•†å“åˆ†é¡</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>ã‚¿ã‚¤ãƒ—åˆ†é¡</label>
                        <select id="typeFilter">
                            <option value="all">å…¨ã¦</option>
                        </select>
                    </div>
                </div>
                
                <div class="breadcrumb" id="breadcrumb">
                    <span class="breadcrumb-item current">ãƒˆãƒƒãƒ—</span>
                </div>
                
                <div class="table-controls">
                    <div class="drill-btn-group">
                        <button class="drill-all-btn" id="drillAllBtn">å…¨ä½“ã‚’ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³</button>
                        <button class="drill-up-btn" id="drillUpBtn" disabled>ä¸€éšå±¤æˆ»ã‚‹</button>
                    </div>
                    <button class="export-btn" id="exportTableBtn">è¡¨ã‚’ç”»åƒã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                </div>
                
                <div class="table-container" id="tableContainer">
                    <!-- è¡¨ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åˆ¶å¾¡
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('splashScreen').style.display = 'none';
                document.getElementById('confirmModal').classList.remove('hidden');
            }, 2500);
        });
        
        // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå®šç¾©
        const libraries = [
            {
                name: 'XLSX',
                url: 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
                check: () => typeof XLSX !== 'undefined'
            },
            {
                name: 'html2canvas',
                url: 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
                check: () => typeof html2canvas !== 'undefined'
            }
        ];
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('approveBtn').addEventListener('click', loadLibraries);
        document.getElementById('cancelBtn').addEventListener('click', handleCancel);
        
        function loadLibraries() {
            document.getElementById('confirmModal').classList.add('hidden');
            document.getElementById('loadingMessage').classList.remove('hidden');
            
            const promises = libraries.map(lib => loadScript(lib));
            
            Promise.all(promises)
                .then(() => {
                    document.getElementById('loadingMessage').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    initializeApp();
                })
                .catch(error => {
                    document.getElementById('loadingMessage').classList.add('hidden');
                    const errorMsg = document.getElementById('errorMessage');
                    errorMsg.textContent = `ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
                    errorMsg.classList.remove('hidden');
                });
        }
        
        function loadScript(lib) {
            return new Promise((resolve, reject) => {
                if (lib.check()) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = lib.url;
                
                script.onload = () => {
                    if (lib.check()) {
                        console.log(`âœ“ ${lib.name} loaded successfully`);
                        resolve();
                    } else {
                        reject(new Error(`${lib.name} failed to initialize`));
                    }
                };
                
                script.onerror = () => {
                    reject(new Error(`${lib.name} failed to load from CDN`));
                };
                
                document.head.appendChild(script);
            });
        }
        
        function handleCancel() {
            document.getElementById('confirmModal').classList.add('hidden');
            const errorMsg = document.getElementById('errorMessage');
            errorMsg.innerHTML = `
                <strong>ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ</strong><br>
                ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã‚’æ‰¿èªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br>
                ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã€å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚
            `;
            errorMsg.classList.remove('hidden');
        }
        
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        function initializeApp() {
            let rawData = [];
            let filteredData = [];
            let hierarchy = [];
            let sortState = { column: null, direction: 'asc' };
            
            const hierarchyLevels = [
                'ãƒ‡ã‚£ãƒ“ã‚¸ãƒ§ãƒ³',
                'ãƒ©ã‚¤ãƒ³',
                'éƒ¨é–€',
                'ã‚«ãƒ†ã‚´ãƒªãƒ¼',
                'ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼',
                'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ',
                'ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ'
            ];
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files[0]) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
            fileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    handleFile(e.target.files[0]);
                }
            });
            
            function handleFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        rawData = XLSX.utils.sheet_to_json(sheet);
                        
                        document.getElementById('mainContent').classList.remove('hidden');
                        initializeFilters();
                        updateTable();
                    } catch (error) {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
            
            function initializeFilters() {
                // ã‚¿ã‚¤ãƒ—åˆ†é¡ã®å–å¾—
                const types = [...new Set(rawData.map(d => d['ã‚¿ã‚¤ãƒ—åˆ†é¡']).filter(t => t))].sort();
                
                const typeFilter = document.getElementById('typeFilter');
                typeFilter.innerHTML = '<option value="all">å…¨ã¦</option>' + 
                    types.map(t => `<option value="${t}">${t}</option>`).join('');
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                document.getElementById('analysisType').addEventListener('change', () => {
                    hierarchy = [];
                    updateTable();
                });
                document.getElementById('typeFilter').addEventListener('change', () => {
                    hierarchy = [];
                    updateTable();
                });
                
                // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
                document.getElementById('drillAllBtn').addEventListener('click', drillDownAll);
                document.getElementById('drillUpBtn').addEventListener('click', drillUp);
                document.getElementById('exportTableBtn').addEventListener('click', exportTable);
            }
            
            function updateTable() {
                const analysisType = document.getElementById('analysisType').value;
                const typeFilter = document.getElementById('typeFilter').value;
                
                // ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆä¼šå“¡ã®ã¿ï¼‰
                filteredData = rawData.filter(row => {
                    if (row['åˆ†æåŸºæº–'] !== analysisType) return false;
                    if (row['é¡§å®¢ç¨®é¡'] !== 'ä¼šå“¡') return false;
                    if (typeFilter !== 'all') {
                        if (!row['ã‚¿ã‚¤ãƒ—åˆ†é¡'] && typeFilter === 'all') return true;
                        if (row['ã‚¿ã‚¤ãƒ—åˆ†é¡'] !== typeFilter) return false;
                    }
                    return true;
                });
                
                updateBreadcrumb();
                renderTable();
                updateButtons();
            }
            
            function updateBreadcrumb() {
                const breadcrumb = document.getElementById('breadcrumb');
                let html = '<span class="breadcrumb-item';
                if (hierarchy.length === 0) html += ' current';
                html += '" data-level="-1">ãƒˆãƒƒãƒ—</span>';
                
                hierarchy.forEach((item, index) => {
                    html += '<span class="breadcrumb-separator"> > </span>';
                    const displayName = item.name === '*ALL*' ? 'å…¨ä½“' : item.name;
                    html += `<span class="breadcrumb-item${index === hierarchy.length - 1 ? ' current' : ''}" data-level="${index}">${displayName}</span>`;
                });
                
                breadcrumb.innerHTML = html;
                
                // ãƒ–ãƒ¬ãƒƒãƒ‰ã‚¯ãƒ©ãƒ ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                breadcrumb.querySelectorAll('.breadcrumb-item:not(.current)').forEach(item => {
                    item.addEventListener('click', () => {
                        const level = parseInt(item.dataset.level);
                        hierarchy = hierarchy.slice(0, level + 1);
                        sortState = { column: null, direction: 'asc' };
                        updateTable();
                    });
                });
            }
            
            function updateButtons() {
                const drillUpBtn = document.getElementById('drillUpBtn');
                drillUpBtn.disabled = hierarchy.length === 0;
                
                const drillAllBtn = document.getElementById('drillAllBtn');
                drillAllBtn.disabled = hierarchy.length >= 6;
            }
            
            function renderTable() {
                const currentLevel = hierarchy.length;
                const targetLevel = hierarchyLevels[currentLevel];
                
                // ç¾åœ¨ã®éšå±¤ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                let data = getCurrentLevelData();
                
                if (data.length === 0) {
                    document.getElementById('tableContainer').innerHTML = '<p style="padding:20px;text-align:center;color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }
                
                // ã‚½ãƒ¼ãƒˆé©ç”¨
                if (sortState.column) {
                    data = sortData(data, sortState.column, sortState.direction);
                }
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
                let html = '<table class="data-table" id="dataTable"><thead><tr>';
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šéšå±¤åˆ—
                if (currentLevel >= 5) {  // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆä»¥é™
                    html += '<th rowspan="2">ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼</th>';
                    if (currentLevel >= 5) html += '<th rowspan="2">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</th>';
                    if (currentLevel >= 6) html += '<th rowspan="2">ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</th>';
                } else {
                    html += `<th rowspan="2">${targetLevel}</th>`;
                }
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šæŒ‡æ¨™åˆ—
                const metrics = [
                    { key: 'sales', name: 'å£²ä¸Šé«˜ç¨æŠœé‡‘é¡<br>(åƒå††)', format: 'number' },
                    { key: 'idCount', name: 'IDå®¢æ•°', format: 'number' },
                    { key: 'posCount', name: 'POSå®¢æ•°', format: 'number' },
                    { key: 'visitFreq', name: 'æ¥åº—é »åº¦', format: 'decimal1' },
                    { key: 'itemsPerVisit', name: '1å›ã‚ãŸã‚Šç‚¹æ•°', format: 'decimal1' },
                    { key: 'amountPerVisit', name: '1å›ã‚ãŸã‚Šè³¼å…¥é‡‘é¡', format: 'decimal1' },
                    { key: 'avgPrice', name: 'å¹³å‡å˜ä¾¡', format: 'decimal0' },
                    { key: 'purchaseRate', name: 'è³¼å…¥ç‡<br>(%)', format: 'decimal1' }
                ];
                
                metrics.forEach(metric => {
                    html += `<th colspan="2">${metric.name}</th>`;
                });
                html += '</tr><tr>';
                
                metrics.forEach(metric => {
                    html += `<th class="sortable" data-column="${metric.key}_current">å½“å¹´ ${getSortIcon(metric.key + '_current')}</th>`;
                    html += `<th class="sortable" data-column="${metric.key}_yoy">æ˜¨å¯¾ ${getSortIcon(metric.key + '_yoy')}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                // ãƒ‡ãƒ¼ã‚¿è¡Œ
                data.forEach(row => {
                    html += '<tr>';
                    
                    // éšå±¤åˆ—
                    if (currentLevel >= 5) {
                        html += `<td class="category-cell">${row.subCategory || '-'}</td>`;
                        if (currentLevel >= 5) {
                            if (currentLevel === 5) {
                                html += `<td class="drill-btn-cell" data-name="${row.name}">â–¼ ${row.name}</td>`;
                            } else {
                                html += `<td class="category-cell">${row.segment || '-'}</td>`;
                            }
                        }
                        if (currentLevel >= 6) {
                            html += `<td class="category-cell">${row.name}</td>`;
                        }
                    } else {
                        if (currentLevel < 6) {
                            html += `<td class="drill-btn-cell" data-name="${row.name}">â–¼ ${row.name}</td>`;
                        } else {
                            html += `<td class="category-cell">${row.name}</td>`;
                        }
                    }
                    
                    // æŒ‡æ¨™åˆ—
                    metrics.forEach(metric => {
                        const current = row[metric.key + '_current'] || 0;
                        const yoy = row[metric.key + '_yoy'] || 0;
                        
                        // å½“å¹´å€¤
                        html += `<td>${formatValue(current, metric.format)}</td>`;
                        
                        // æ˜¨å¯¾å€¤ï¼ˆè‰²ä»˜ãï¼‰
                        const yoyClass = yoy >= 100 ? 'yoy-positive' : 'yoy-negative';
                        html += `<td class="${yoyClass}">${yoy.toFixed(1)}%</td>`;
                    });
                    
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                
                document.getElementById('tableContainer').innerHTML = html;
                
                // ã‚½ãƒ¼ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ
                document.querySelectorAll('.sortable').forEach(th => {
                    th.addEventListener('click', () => {
                        const column = th.dataset.column;
                        if (sortState.column === column) {
                            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                        } else {
                            sortState.column = column;
                            sortState.direction = 'asc';
                        }
                        renderTable();
                    });
                });
                
                // ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
                document.querySelectorAll('.drill-btn-cell').forEach(cell => {
                    cell.addEventListener('click', () => {
                        const name = cell.dataset.name;
                        hierarchy.push({ level: currentLevel, name: name });
                        sortState = { column: null, direction: 'asc' };
                        updateTable();
                    });
                });
            }
            
            function getCurrentLevelData() {
                const currentLevel = hierarchy.length;
                const targetLevel = hierarchyLevels[currentLevel];
                
                // ç¾åœ¨ã®éšå±¤ã¾ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                let filtered = filteredData.filter(row => {
                    // ä¸Šä½éšå±¤ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                    for (let i = 0; i < hierarchy.length; i++) {
                        const levelName = hierarchyLevels[i];
                        // *ALL* ã®å ´åˆã¯ãã®éšå±¤ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’ã‚¹ã‚­ãƒƒãƒ—
                        if (hierarchy[i].name === '*ALL*') {
                            continue;
                        }
                        if (row[levelName] !== hierarchy[i].name) {
                            return false;
                        }
                    }
                    
                    // ç¾åœ¨ã®éšå±¤ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼ˆä¸‹ä½éšå±¤ã¯é™¤å¤–ï¼‰
                    if (!row[targetLevel] || row[targetLevel] === '-') return false;
                    
                    // æ¬¡ã®éšå±¤ãŒ'-'ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                    if (currentLevel < 6) {
                        const nextLevel = hierarchyLevels[currentLevel + 1];
                        if (row[nextLevel] && row[nextLevel] !== '-') return false;
                    }
                    
                    return true;
                });
                
                // åŒã˜é …ç›®ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const grouped = {};
                filtered.forEach(row => {
                    // éšå±¤5ãƒ»6ã§ã¯ä¸Šä½éšå±¤ã¨ã®çµ„ã¿åˆã‚ã›ã‚’ã‚­ãƒ¼ã«ã™ã‚‹
                    let key;
                    if (currentLevel === 5) {
                        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆéšå±¤ï¼šã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ + ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ
                        const subCat = row['ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼'] || '';
                        const seg = row[targetLevel] || '';
                        key = `${subCat}|||${seg}`;
                    } else if (currentLevel === 6) {
                        // ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆéšå±¤ï¼šã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ + ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ + ã‚µãƒ–ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ
                        const subCat = row['ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼'] || '';
                        const seg = row['ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ'] || '';
                        const subSeg = row[targetLevel] || '';
                        key = `${subCat}|||${seg}|||${subSeg}`;
                    } else {
                        // é€šå¸¸ã®éšå±¤ï¼šåå‰ã®ã¿
                        key = row[targetLevel];
                    }
                    
                    if (!grouped[key]) {
                        grouped[key] = {
                            name: row[targetLevel],
                            subCategory: row['ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼'],
                            segment: row['ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ'],
                            sales_current: 0,
                            sales_yoy: 0,
                            idCount_current: 0,
                            idCount_yoy: 0,
                            posCount_current: 0,
                            posCount_yoy: 0,
                            visitFreq_current: 0,
                            visitFreq_yoy: 0,
                            itemsPerVisit_current: 0,
                            itemsPerVisit_yoy: 0,
                            amountPerVisit_current: 0,
                            amountPerVisit_yoy: 0,
                            avgPrice_current: 0,
                            avgPrice_yoy: 0,
                            purchaseRate_current: 0,
                            purchaseRate_yoy: 0
                        };
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿é›†ç´„ï¼ˆæœ€åˆã®è¡Œã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰
                    if (grouped[key].sales_current === 0) {
                        grouped[key].sales_current = (row['å£²ä¸Šç¨æŠœé‡‘é¡(å††)'] || 0) / 1000;
                        grouped[key].sales_yoy = (row['å£²ä¸Šç¨æŠœé‡‘é¡(å††)(æœŸé–“æ¯”)'] || 0) * 100;
                        grouped[key].idCount_current = row['IDå®¢æ•°'] || 0;
                        grouped[key].idCount_yoy = (row['IDå®¢æ•°(æœŸé–“æ¯”)'] || 0) * 100;
                        grouped[key].posCount_current = row['POSå®¢æ•°'] || 0;
                        grouped[key].posCount_yoy = (row['POSå®¢æ•°(æœŸé–“æ¯”)'] || 0) * 100;
                        grouped[key].visitFreq_current = row['æ¥åº—é »åº¦'] || 0;
                        grouped[key].visitFreq_yoy = (row['æ¥åº—é »åº¦(æœŸé–“æ¯”)'] || 0) * 100;
                        grouped[key].itemsPerVisit_current = row['1å›ã‚ãŸã‚Šç‚¹æ•°'] || 0;
                        grouped[key].itemsPerVisit_yoy = (row['1å›ã‚ãŸã‚Šç‚¹æ•°(æœŸé–“æ¯”)'] || 0) * 100;
                        grouped[key].amountPerVisit_current = row['å®¢å˜ä¾¡(ç¨æŠœ)'] || 0;
                        grouped[key].amountPerVisit_yoy = (row['å®¢å˜ä¾¡(ç¨æŠœ)(æœŸé–“æ¯”)'] || 0) * 100;
                        grouped[key].avgPrice_current = row['å£²å˜ä¾¡(ç¨è¾¼)'] || 0;
                        grouped[key].avgPrice_yoy = (row['å£²å˜ä¾¡(ç¨è¾¼)(æœŸé–“æ¯”)'] || 0) * 100;
                        grouped[key].purchaseRate_current = (row['è³¼å…¥ç‡'] || 0) * 100;
                        grouped[key].purchaseRate_yoy = (row['è³¼å…¥ç‡(æœŸé–“æ¯”)'] || 0) * 100;
                    }
                });
                
                return Object.values(grouped);
            }
            
            function sortData(data, column, direction) {
                return data.sort((a, b) => {
                    let aVal = a[column];
                    let bVal = b[column];
                    
                    if (typeof aVal === 'string') {
                        return direction === 'asc' ? aVal.localeCompare(bVal, 'ja') : bVal.localeCompare(aVal, 'ja');
                    }
                    
                    return direction === 'asc' ? aVal - bVal : bVal - aVal;
                });
            }
            
            function getSortIcon(column) {
                if (sortState.column !== column) return '<span class="sort-indicator">â‡…</span>';
                return sortState.direction === 'asc' ? '<span class="sort-indicator">â–²</span>' : '<span class="sort-indicator">â–¼</span>';
            }
            
            function formatValue(value, format) {
                if (value === 0 || value === null || value === undefined) return '-';
                
                switch (format) {
                    case 'number':
                        return Math.round(value).toLocaleString('ja-JP');
                    case 'decimal0':
                        return Math.round(value).toLocaleString('ja-JP');
                    case 'decimal1':
                        return value.toFixed(1);
                    case 'decimal2':
                        return value.toFixed(2);
                    default:
                        return value.toString();
                }
            }
            
            function drillDownAll() {
                const currentLevel = hierarchy.length;
                if (currentLevel >= 6) {
                    alert('ã“ã‚Œä»¥ä¸Šãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ã§ãã¾ã›ã‚“');
                    return;
                }
                
                const data = getCurrentLevelData();
                if (data.length === 0) {
                    alert('ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                // å…¨ä½“ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ï¼š*ALL*ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
                hierarchy.push({ level: currentLevel, name: '*ALL*' });
                sortState = { column: null, direction: 'asc' };
                updateTable();
            }
            
            function drillUp() {
                if (hierarchy.length > 0) {
                    hierarchy.pop();
                    sortState = { column: null, direction: 'asc' };
                    updateTable();
                }
            }
            
            function exportTable() {
                const table = document.getElementById('dataTable');
                if (!table) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹è¡¨ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                html2canvas(table, {
                    scale: 2,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const link = document.createElement('a');
                    const timestamp = new Date().toISOString().slice(0,10).replace(/-/g, '');
                    link.download = `è¡¨å½¢å¼å£²ä¸Šåˆ†è§£_${timestamp}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                }).catch(error => {
                    alert('ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                });
            }
        }
    </script>
</body>
</html>
